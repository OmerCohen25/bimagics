<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Analytics Ultimate v5.0</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Chart.js & Plugins -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f8fafc; color: #1e293b; }
        
        /* UI Components */
        .card { @apply bg-white border border-slate-200 rounded-xl shadow-sm transition-shadow duration-300; }
        .card:hover { @apply shadow-md border-slate-300; }
        
        .input-light { @apply bg-white border border-slate-300 text-slate-800 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 shadow-sm; }
        
        .btn { @apply px-4 py-2 rounded-lg font-bold transition-all duration-200 flex items-center justify-center gap-2 shadow-sm active:scale-95; }
        .btn-primary { @apply bg-blue-600 hover:bg-blue-700 text-white; }
        .btn-secondary { @apply bg-white hover:bg-slate-50 text-slate-700 border border-slate-300; }
        
        /* Table */
        .matrix-table th { @apply px-4 py-3 text-xs uppercase bg-slate-50 text-slate-500 font-bold sticky top-0 z-10 border-b border-slate-200 whitespace-nowrap text-right; }
        .matrix-table td { @apply px-4 py-2 text-xs border-b border-slate-100 whitespace-nowrap font-mono text-slate-600; }
        .matrix-table tr:hover { @apply bg-blue-50/50; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Loader */
        .loader { width: 18px; height: 18px; border: 2px solid currentColor; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #3b82f6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }
        .toggle-checkbox { right: 0; z-index: 1; border-color: #e5e7eb; transition: all 0.3s; }
        .toggle-label { width: 3rem; margin-left: -0.5rem; transition: background 0.3s; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

<div id="app" class="h-full flex flex-col">
    
    <!-- HEADER -->
    <header class="bg-white border-b border-slate-200 px-6 py-3 flex justify-between items-center z-20 shadow-sm shrink-0">
        <div class="flex items-center gap-4">
            <div class="bg-blue-600 text-white p-2.5 rounded-xl shadow-lg shadow-blue-200/50">
                <i class="fa-solid fa-layer-group text-xl"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold leading-none text-slate-800">Solar Analytics Ultimate</h1>
                <div class="text-xs text-slate-500 font-medium tracking-wide mt-1">Deep Matrix Engine v5.0</div>
            </div>
        </div>
        
        <div class="flex gap-3 items-center">
            <div class="flex items-center bg-slate-100 rounded-lg p-1 border border-slate-200">
                <i class="fa-solid fa-key text-slate-400 px-3 text-xs"></i>
                <input type="text" v-model="apiKey" placeholder="API Key" class="bg-transparent border-none text-xs w-24 md:w-48 focus:ring-0 placeholder-slate-400 text-slate-700">
            </div>
            
            <button @click="loadSites" class="btn-primary text-xs h-9">
                <i class="fa-solid fa-sync" :class="{'animate-spin': loadingSites}"></i> 
                {{ loadingSites ? 'טוען...' : 'טען' }}
            </button>

            <select v-if="sites.length > 0" v-model="selectedSite" @change="onSiteChange" class="input-light w-56 h-9 py-0 text-xs font-bold border-slate-300">
                <option :value="null" disabled>בחר אתר מהרשימה...</option>
                <option v-for="site in sites" :key="site.id" :value="site">{{ site.name }}</option>
            </select>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col p-4 md:p-6 gap-6 overflow-hidden bg-slate-50 w-full relative">
            
            <!-- EMPTY STATE -->
            <div v-if="!selectedSite" class="flex flex-col items-center justify-center h-full text-slate-400 animate-in fade-in duration-700">
                <div class="bg-white p-8 rounded-full shadow-xl shadow-blue-100 mb-6 border border-slate-100">
                    <i class="fa-solid fa-solar-panel text-6xl text-blue-500/80"></i>
                </div>
                <h2 class="text-xl font-bold text-slate-700">מוכן לניתוח נתונים</h2>
                <p class="text-sm mt-2 text-slate-500">הזן מפתח API ובחר אתר כדי להפעיל את המטריצה</p>
            </div>

            <div v-else class="flex flex-col h-full gap-5">
                
                <!-- CONTROL BAR -->
                <div class="card p-4 flex flex-wrap gap-6 justify-between items-center shrink-0 bg-white/80 backdrop-blur-sm sticky top-0 z-10">
                    
                    <!-- Time Range -->
                    <div class="flex items-center gap-3">
                        <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">טווח ניתוח</div>
                        <div class="flex bg-slate-100 p-1 rounded-lg border border-slate-200">
                            <button v-for="h in [24, 48, 72]" :key="h" 
                                @click="timeRange = h" 
                                :class="['px-3 py-1.5 text-xs font-bold rounded-md transition-all', timeRange === h ? 'bg-white text-blue-600 shadow-sm ring-1 ring-slate-200' : 'text-slate-500 hover:text-slate-700']">
                                {{ h }} שעות
                            </button>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div v-if="inventory" class="hidden md:flex gap-6 text-xs bg-slate-50 px-4 py-2 rounded-lg border border-slate-100">
                        <div class="flex flex-col">
                            <span class="text-slate-400 font-bold uppercase text-[10px]">הספק</span>
                            <span class="font-bold text-slate-700">{{ selectedSite.peakPower }} kWp</span>
                        </div>
                        <div class="w-px bg-slate-200 h-8"></div>
                        <div class="flex flex-col">
                            <span class="text-slate-400 font-bold uppercase text-[10px]">ממירים</span>
                            <span class="font-bold text-slate-700">{{ inventory.inverters?.length || 0 }}</span>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex items-center gap-3">
                        <div v-if="statusMessage" class="flex items-center gap-2 text-xs text-blue-700 bg-blue-50 px-3 py-1.5 rounded-full border border-blue-100 animate-pulse">
                            <div class="loader w-3 h-3 text-blue-600"></div>
                            {{ statusMessage }}
                        </div>
                        <button @click="buildMatrix" :disabled="isBuilding" class="btn-primary shadow-blue-200 hover:shadow-blue-300">
                            <i class="fa-solid fa-bolt"></i> 
                            {{ isBuilding ? 'מעבד מטריצה...' : 'בצע ניתוח מלא' }}
                        </button>
                    </div>
                </div>

                <!-- NAVIGATION -->
                <div v-if="matrixData.length > 0" class="flex gap-6 border-b border-slate-200 px-2 select-none">
                    <button @click="currentTab = 'chart'" :class="['pb-3 text-sm font-bold border-b-2 transition-all flex items-center gap-2', currentTab === 'chart' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-700']">
                        <i class="fa-solid fa-chart-line"></i> ויזואליזציה
                    </button>
                    <button @click="currentTab = 'table'" :class="['pb-3 text-sm font-bold border-b-2 transition-all flex items-center gap-2', currentTab === 'table' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-700']">
                        <i class="fa-solid fa-table"></i> טבלת נתונים
                    </button>
                </div>

                <!-- === CHART VIEW === -->
                <div v-if="currentTab === 'chart' && matrixData.length > 0" class="flex-1 flex flex-col md:flex-row gap-4 overflow-hidden h-full">
                    
                    <!-- Sidebar Controls -->
                    <div class="w-full md:w-72 bg-white border border-slate-200 rounded-xl flex flex-col overflow-hidden shrink-0 shadow-sm h-full">
                        
                        <!-- Settings Panel -->
                        <div class="p-4 bg-slate-50/50 border-b border-slate-200 space-y-3">
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">בקרת גרף</div>
                            
                            <!-- Normalize Toggle -->
                            <label class="flex items-center justify-between p-2.5 bg-white border border-slate-200 rounded-lg cursor-pointer hover:border-blue-300 transition-all shadow-sm">
                                <div class="flex items-center gap-2 text-sm font-bold text-slate-700">
                                    <i class="fa-solid fa-expand text-blue-500"></i> נרמול (0-100%)
                                </div>
                                <div class="relative inline-block w-10 align-middle select-none">
                                    <input type="checkbox" v-model="normalizeChart" @change="updateChart" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300"/>
                                    <label class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer"></label>
                                </div>
                            </label>

                            <!-- Smoothing Toggle -->
                            <label class="flex items-center justify-between p-2.5 bg-white border border-slate-200 rounded-lg cursor-pointer hover:border-purple-300 transition-all shadow-sm">
                                <div class="flex items-center gap-2 text-sm font-bold text-slate-700">
                                    <i class="fa-solid fa-bezier-curve text-purple-500"></i> החלקת קווים
                                </div>
                                <div class="relative inline-block w-10 align-middle select-none">
                                    <input type="checkbox" v-model="smoothLines" @change="updateChart" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300"/>
                                    <label class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer"></label>
                                </div>
                            </label>
                        </div>

                        <!-- Fields Selector -->
                        <div class="flex-1 overflow-y-auto p-3 space-y-2 custom-scroll">
                            
                            <!-- Site Power -->
                            <div class="bg-green-50/50 p-2 rounded-lg border border-green-100">
                                <div class="text-[10px] font-bold text-green-600 mb-1 uppercase flex items-center gap-1"><i class="fa-solid fa-globe"></i> אתר ראשי</div>
                                <div class="flex items-center gap-2">
                                    <input type="checkbox" value="sitePower" v-model="selectedChartFields" @change="updateChart" class="rounded border-slate-300 text-green-600 focus:ring-green-500">
                                    <div class="h-4 w-4 rounded-full overflow-hidden shadow-sm ring-1 ring-slate-200 relative">
                                        <input type="color" v-model="fieldColors['sitePower']" @change="updateChart" class="absolute -top-2 -left-2 w-8 h-8 cursor-pointer">
                                    </div>
                                    <span class="text-xs text-slate-700 font-medium">ייצור כולל (Total)</span>
                                </div>
                            </div>

                            <!-- Inverters -->
                            <div v-for="inv in inventory.inverters" :key="inv.SN" class="bg-white p-2 rounded-lg border border-slate-100 hover:border-slate-300 transition-colors">
                                <div class="text-[10px] font-bold text-blue-600 mb-2 uppercase border-b border-slate-100 pb-1 flex justify-between">
                                    <span>{{ inv.name }}</span>
                                    <span class="text-slate-400 font-normal">{{ inv.SN.slice(-4) }}</span>
                                </div>
                                
                                <div class="space-y-1.5">
                                    <!-- Main Fields -->
                                    <div v-for="field in ['DC Voltage', 'Temperature', 'Active Power']" :key="inv.SN+field" class="flex items-center gap-2">
                                        <input type="checkbox" :value="`${inv.SN}_${field}`" v-model="selectedChartFields" @change="updateChart" class="rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                                        <div class="h-3 w-3 rounded-sm overflow-hidden ring-1 ring-slate-200 relative">
                                            <input type="color" v-model="fieldColors[`${inv.SN}_${field}`]" @change="updateChart" class="absolute -top-1 -left-1 w-6 h-6 cursor-pointer">
                                        </div>
                                        <span class="text-xs text-slate-600">{{ field }}</span>
                                    </div>
                                    
                                    <!-- Phases Dropdown logic simplified to list -->
                                    <div class="pl-2 mt-1 border-r-2 border-slate-100 mr-1">
                                        <div v-for="phaseField in getPhaseFields(inv.SN)" :key="phaseField" class="flex items-center gap-2 py-0.5">
                                            <input type="checkbox" :value="phaseField" v-model="selectedChartFields" @change="updateChart" class="rounded border-slate-300 text-purple-500 focus:ring-purple-500 scale-90">
                                            <div class="h-2 w-2 rounded-full overflow-hidden ring-1 ring-slate-200 relative">
                                                <input type="color" v-model="fieldColors[phaseField]" @change="updateChart" class="absolute -top-1 -left-1 w-5 h-5 cursor-pointer">
                                            </div>
                                            <span class="text-[10px] text-slate-500 font-mono">{{ formatPhaseName(phaseField) }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chart Canvas Area -->
                    <div class="flex-1 card p-4 relative flex flex-col h-full min-h-0 bg-white">
                        <div class="flex justify-between items-center mb-2 px-2">
                            <div class="flex gap-2 items-center">
                                <h3 class="text-sm font-bold text-slate-700">תצוגה גרפית</h3>
                                <span v-if="normalizeChart" class="text-[10px] text-blue-600 bg-blue-50 px-2 py-0.5 rounded font-bold border border-blue-100">Normalized</span>
                            </div>
                            
                            <button @click="resetZoom" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1 rounded-md transition-colors font-medium border border-slate-200">
                                <i class="fa-solid fa-magnifying-glass-minus mr-1"></i> איפוס זום
                            </button>
                        </div>
                        
                        <div class="flex-1 relative w-full min-h-0 bg-slate-50/30 rounded-lg border border-slate-100/50">
                            <canvas id="matrixChart"></canvas>
                        </div>
                        
                        <div class="text-[10px] text-slate-400 text-center mt-2 flex justify-center gap-4">
                            <span><i class="fa-solid fa-mouse"></i> גלול לזום</span>
                            <span><i class="fa-solid fa-hand"></i> גרור להזזה</span>
                        </div>
                    </div>
                </div>

                <!-- === TABLE VIEW === -->
                <div v-if="currentTab === 'table' && matrixData.length > 0" class="flex-1 card flex flex-col relative overflow-hidden h-full">
                    <div class="p-3 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                        <span class="text-xs font-bold text-slate-500">סה"כ: {{ matrixData.length }} רשומות מסונכרנות</span>
                        <button @click="exportCSV" class="btn-secondary text-xs py-1.5 px-3 flex items-center gap-2 hover:bg-green-50 hover:text-green-700 hover:border-green-200 shadow-none">
                            <i class="fa-solid fa-file-excel text-green-600"></i> הורד לאקסל
                        </button>
                    </div>
                    
                    <div class="flex-1 overflow-auto bg-white custom-scroll">
                        <table class="w-full matrix-table text-left border-collapse">
                            <thead>
                                <tr>
                                    <th class="bg-slate-100 border-r text-slate-700 min-w-[100px]">Time</th>
                                    <th class="text-green-600 border-r bg-green-50/30">Site Total (W)</th>
                                    <th v-for="col in dynamicHeaders" :key="col" :class="getHeaderClass(col)">
                                        {{ formatHeaderSimple(col) }}
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(row, idx) in matrixData" :key="idx">
                                    <td class="font-bold border-r bg-slate-50/50 text-slate-800">{{ row.time.split(' ')[1] }} <span class="text-[10px] text-slate-400 font-normal">{{row.time.split(' ')[0]}}</span></td>
                                    <td class="text-green-600 font-bold border-r bg-green-50/10">{{ formatNumber(row.sitePower) }}</td>
                                    <td v-for="col in dynamicHeaders" :key="col + idx">
                                        {{ formatNumber(row[col]) }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>
    </div>
</div>

<script>
const { createApp, ref, onMounted, computed, watch, nextTick, reactive } = Vue;

createApp({
    setup() {
        // Config
        const apiKey = ref('RPR5J7H74H6Y009EYPZ18C0AIZEAEU55');
        const timeRange = ref(24);
        
        // Data
        const sites = ref([]);
        const selectedSite = ref(null);
        const inventory = ref(null);
        
        // Matrix Engine
        const isBuilding = ref(false);
        const loadingSites = ref(false);
        const statusMessage = ref('');
        const matrixData = ref([]);
        const dynamicHeaders = ref([]);
        
        // Visualization
        const currentTab = ref('chart');
        const normalizeChart = ref(false);
        const smoothLines = ref(false); // New: Smooth toggle
        const selectedChartFields = ref(['sitePower']);
        const fieldColors = reactive({});
        let chartInstance = null;

        // --- Utils ---
        const fetchJsonp = (url) => {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_' + Math.floor(Math.random() * 1000000);
                const script = document.createElement('script');
                const sep = url.includes('?') ? '&' : '?';
                script.src = `${url}${sep}api_key=${apiKey.value}&callback=${callbackName}`;
                window[callbackName] = (data) => { delete window[callbackName]; document.body.removeChild(script); resolve(data); };
                script.onerror = () => { delete window[callbackName]; document.body.removeChild(script); reject('Error'); };
                document.body.appendChild(script);
            });
        };
        const formatDateAPI = (d) => d.toISOString().replace('T', ' ').split('.')[0];
        const formatNumber = (v) => (v === undefined || v === null) ? '-' : (typeof v === 'number' && v % 1 !== 0) ? v.toFixed(1) : v;

        // --- Logic ---
        const loadSites = async () => {
            if(!apiKey.value) return;
            loadingSites.value = true;
            try {
                const res = await fetchJsonp(`https://monitoringapi.solaredge.com/sites/list`);
                sites.value = res.sites.site;
            } catch(e) { alert("שגיאה בטעינת אתרים - בדוק מפתח API"); }
            loadingSites.value = false;
        };

        const onSiteChange = async () => {
            if(!selectedSite.value) return;
            matrixData.value = [];
            inventory.value = null;
            try {
                const res = await fetchJsonp(`https://monitoringapi.solaredge.com/site/${selectedSite.value.id}/inventory`);
                inventory.value = res.Inventory;
            } catch(e) { console.error(e); }
        };

        // --- MATRIX ENGINE ---
        const buildMatrix = async () => {
            if(!selectedSite.value || !inventory.value) return;
            isBuilding.value = true;
            matrixData.value = [];
            dynamicHeaders.value = [];
            
            const end = new Date();
            const start = new Date();
            start.setHours(end.getHours() - timeRange.value);
            const startTimeStr = formatDateAPI(start);
            const endTimeStr = formatDateAPI(end);

            const masterMap = new Map();
            // Use 15-minute alignment if possible, but keep raw strings for now
            // Better logic: round to nearest minute to help alignment if off by seconds?
            // For now, keep simple string matching but fix the gap issue in Chart config
            const getRow = (t) => {
                const clean = t.substring(0, 16) + ':00';
                if(!masterMap.has(clean)) masterMap.set(clean, { time: clean });
                return masterMap.get(clean);
            };

            try {
                // 1. Site Power
                statusMessage.value = 'טוען נתוני ייצור אתר...';
                const siteUrl = `https://monitoringapi.solaredge.com/site/${selectedSite.value.id}/power?startTime=${startTimeStr}&endTime=${endTimeStr}`;
                const siteRes = await fetchJsonp(siteUrl);
                if(siteRes.power?.values) siteRes.power.values.forEach(e => getRow(e.date).sitePower = e.value);

                // 2. Inverters
                const inverters = inventory.value.inverters || [];
                for(let i=0; i<inverters.length; i++) {
                    const inv = inverters[i];
                    statusMessage.value = `מעבד ממיר ${i+1}/${inverters.length} (${inv.SN})...`;
                    const invUrl = `https://monitoringapi.solaredge.com/equipment/${selectedSite.value.id}/${inv.SN}/data?startTime=${startTimeStr}&endTime=${endTimeStr}`;
                    
                    try {
                        const invRes = await fetchJsonp(invUrl);
                        const telemetries = invRes.data.telemetries || [];
                        telemetries.forEach(t => {
                            const d = t.inverterTelemetry || t;
                            const time = t.date || d.date;
                            if(!time) return;
                            const row = getRow(time);
                            const p = inv.SN;
                            
                            row[`${p}_DC Voltage`] = d.dcVoltage;
                            row[`${p}_Temperature`] = d.temperature;
                            row[`${p}_Active Power`] = d.totalActivePower || d.activePower;
                            
                            ['L1', 'L2', 'L3'].forEach(ph => {
                                const pd = d[`${ph}Data`];
                                if(pd) {
                                    row[`${p}_${ph}_V`] = pd.acVoltage;
                                    row[`${p}_${ph}_A`] = pd.acCurrent;
                                    row[`${p}_${ph}_Hz`] = pd.acFrequency;
                                    row[`${p}_${ph}_W`] = pd.activePower;
                                }
                            });
                        });
                    } catch(e) { console.warn("Failed inverter", inv.SN); }
                }

                statusMessage.value = 'מסנכרן מטריצה...';
                const final = Array.from(masterMap.values()).sort((a,b) => a.time.localeCompare(b.time));
                
                const headers = new Set();
                final.forEach(r => Object.keys(r).forEach(k => { if(k!=='time' && k!=='sitePower') headers.add(k); }));
                dynamicHeaders.value = Array.from(headers).sort();
                matrixData.value = final;

                assignDefaultColors();
                statusMessage.value = '';
                isBuilding.value = false;
                nextTick(() => updateChart());

            } catch(e) {
                console.error(e);
                statusMessage.value = 'שגיאה בעיבוד';
                isBuilding.value = false;
            }
        };

        const assignDefaultColors = () => {
            if(!fieldColors['sitePower']) fieldColors['sitePower'] = '#16a34a'; // Strong Green
            const palette = ['#2563eb', '#dc2626', '#d97706', '#9333ea', '#0891b2'];
            inventory.value.inverters.forEach((inv, idx) => {
                const base = palette[idx % palette.length];
                dynamicHeaders.value.filter(h => h.startsWith(inv.SN)).forEach(h => {
                    if(!fieldColors[h]) {
                        if(h.includes('Temperature')) fieldColors[h] = '#ef4444'; 
                        else if(h.includes('Voltage')) fieldColors[h] = '#3b82f6';
                        else if(h.includes('Power')) fieldColors[h] = '#10b981';
                        else fieldColors[h] = base; 
                    }
                });
            });
        };

        // --- VISUALIZATION ENGINE ---
        const updateChart = () => {
            if(currentTab.value !== 'chart') return;
            const ctx = document.getElementById('matrixChart');
            if(!ctx) return;
            if(chartInstance) chartInstance.destroy();

            const labels = matrixData.value.map(r => r.time.substring(11, 16));
            
            const datasets = selectedChartFields.value.map(field => {
                const rawData = matrixData.value.map(r => r[field]);
                let displayData = [...rawData];
                let yAxisID = 'y';

                if(normalizeChart.value) {
                    const validValues = rawData.filter(v => v !== undefined && v !== null);
                    const min = Math.min(...validValues);
                    const max = Math.max(...validValues);
                    if(max > min) {
                        displayData = rawData.map(v => (v === undefined) ? null : ((v - min) / (max - min)) * 100);
                    }
                } else {
                    if(field.includes('Voltage')) yAxisID = 'y_volt';
                    if(field.includes('Temp')) yAxisID = 'y_temp';
                }

                // Make sitePower very visible if selected
                const isTotal = field === 'sitePower';
                const color = fieldColors[field] || '#666';

                return {
                    label: formatHeaderSimple(field),
                    data: displayData,
                    borderColor: color,
                    backgroundColor: isTotal ? color + '20' : 'transparent', // Light fill for total
                    borderWidth: isTotal ? 3 : 2, // Thicker line for total
                    pointRadius: 0,
                    pointHitRadius: 20,
                    tension: smoothLines.value ? 0.4 : 0, // Toggle smooth
                    spanGaps: true, // CRITICAL FIX: Connects dots over nulls
                    fill: isTotal,
                    yAxisID: normalizeChart.value ? 'y_norm' : yAxisID,
                    rawValues: rawData
                };
            });

            const scales = normalizeChart.value ? {
                y_norm: { display: true, min: 0, max: 105, grid: { color: '#f1f5f9' }, ticks: { callback: v => v+'%' } }
            } : {
                y: { display: true, position: 'left', title: {display:true, text:'Power (W)'} },
                y_volt: { display: false, position: 'right', grid:{drawOnChartArea:false} },
                y_temp: { display: false, position: 'right', grid:{drawOnChartArea:false} }
            };

            if(!normalizeChart.value) {
                const ids = new Set(datasets.map(d => d.yAxisID));
                if(ids.has('y_volt')) scales.y_volt.display = true;
                if(ids.has('y_temp')) scales.y_temp.display = true;
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const raw = context.dataset.rawValues[context.dataIndex];
                                    let val = (raw !== undefined && raw !== null) ? raw.toFixed(2) : '-';
                                    return `${context.dataset.label}: ${val}`;
                                }
                            }
                        },
                        legend: { position: 'top', labels: { usePointStyle: true, boxWidth: 8 } },
                        zoom: {
                            pan: { enabled: true, mode: 'x' },
                            zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
                        }
                    },
                    scales: {
                        x: { grid: { display: false } },
                        ...scales
                    }
                }
            });
        };

        const resetZoom = () => {
            if(chartInstance) chartInstance.resetZoom();
        };

        // --- Helpers ---
        const getPhaseFields = (sn) => dynamicHeaders.value.filter(h => h.startsWith(sn) && /L[1-3]/.test(h));
        const formatPhaseName = (f) => f.split('_').slice(1).join(' '); 
        const formatHeaderSimple = (f) => f === 'sitePower' ? 'Site Total Production' : f.replace(/.*_/, ''); 
        const getHeaderClass = (h) => {
            if(h.includes('Voltage')) return 'text-blue-600 border-r';
            if(h.includes('Temp')) return 'text-red-600 border-r';
            return 'text-slate-600 border-r';
        };

        const exportCSV = () => {
            if(!matrixData.value.length) return;
            const h = ['Time', 'Site Power', ...dynamicHeaders.value];
            const rows = matrixData.value.map(r => [r.time, r.sitePower||'', ...dynamicHeaders.value.map(c => r[c]||'')].join(','));
            const blob = new Blob([[h.join(','), ...rows].join('\n')], {type:'text/csv'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `solar_matrix_${timeRange.value}h.csv`;
            link.click();
        };

        watch([currentTab, normalizeChart, smoothLines], () => nextTick(updateChart));
        onMounted(loadSites);

        return {
            apiKey, sites, selectedSite, inventory, timeRange,
            isBuilding, loadingSites, statusMessage, matrixData, dynamicHeaders,
            currentTab, normalizeChart, smoothLines, selectedChartFields, fieldColors,
            loadSites, onSiteChange, buildMatrix, updateChart, exportCSV, resetZoom,
            getPhaseFields, formatPhaseName, formatHeaderSimple, getHeaderClass, formatNumber
        };
    }
}).mount('#app');
</script>
</body>
</html>
