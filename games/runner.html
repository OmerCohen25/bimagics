<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Wall Street Runner: An Investor's Journey</title>
<style>
  html,body{margin:0;height:100%;background:#0a0f18;touch-action:none;overscroll-behavior:none; font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', system-ui, sans-serif;}
  canvas{display:block;width:100vw;height:100vh;background:transparent;position:fixed;top:0;left:0}
  #game-container{position:relative;width:100%;height:100%;overflow:hidden}
  #hud{
    position:fixed;top:0;left:0;right:0;pointer-events:none;
    display:flex;justify-content:space-between;align-items:flex-start;
    padding:8px 12px;
    text-shadow:0 1px 4px #000;
  }
  .hud-box{background:rgba(15,25,40,.6);border:1px solid rgba(255,255,255,.12);border-radius:8px;padding:5px 10px;text-align:center; min-width:85px;}
  .hud-box .label{font-size:10px;opacity:.7;letter-spacing:.5px; text-transform:uppercase;}
  .hud-box .value{font-size:16px;font-weight:700; color:#fff;}
  #portfolioValue .value.up{color:#4f4}
  #portfolioValue .value.down{color:#f44}

  #event{position:fixed;top:140px;left:10px;right:10px;text-align:center;font-weight:800;letter-spacing:.5px;
    text-shadow:0 3px 15px #000;color:#fff;opacity:0;transition:opacity .6s ease-out, transform .6s ease-out;
    transform:translateY(20px) scale(.95); pointer-events:none; line-height:1.4;}
  #event.show{opacity:1;transform:translateY(0) scale(1)}
  #event .event-name{font-size:24px; background:linear-gradient(45deg, #ffc837, #ff8008); -webkit-background-clip:text; -webkit-text-fill-color:transparent;}
  #event .event-line{font-size:14px;font-weight:500;color:#eee;opacity:.9}

  #tips{position:fixed;bottom:10px;left:0;right:0;text-align:center;color:#c8d2e0;font-size:13px;opacity:.9;pointer-events:none; font-weight:600;}

  #lanes-overlay{position:fixed;bottom:0;left:0;right:0;height:25vh;display:flex;pointer-events:none}
  .lane-label{flex:1;display:flex;justify-content:center;align-items:center;font-size:28px;font-weight:900;opacity:.1;transition:opacity .3s; text-transform: uppercase;}
  .lane-label.active{opacity:.6}
  #sell-label{color:#f55}
  #hold-label{color:#fff}
  #buy-label{color:#5f5}
</style>
</head>
<body>
<div id="game-container">
  <canvas id="bg-canvas"></canvas>
  <canvas id="main-canvas"></canvas>
  <div id="hud">
    <div class="hud-box" id="portfolioValue">
      <div class="label">Net Worth</div>
      <div class="value">$100,000</div>
    </div>
    <div class="hud-box" id="currentDate">
      <div class="label">Date</div>
      <div class="value">Jan 2005</div>
    </div>
    <div class="hud-box" id="cash">
      <div class="label">Cash</div>
      <div class="value">$100,000</div>
    </div>
  </div>
  <canvas id="graph-canvas"></canvas>
  <div id="event"></div>
  <div id="lanes-overlay">
    <div class="lane-label" id="sell-label">Sell</div>
    <div class="lane-label" id="hold-label">Hold</div>
    <div class="lane-label" id="buy-label">Buy</div>
  </div>
  <div id="tips">Drag the investor to Buy, Sell, or Hold stocks.</div>
</div>

<script>
(() => {
/* ===================== Canvas & Utils ===================== */
const mainCanvas = document.getElementById('main-canvas');
const mainCtx = mainCanvas.getContext('2d');
const bgCanvas = document.getElementById('bg-canvas');
const bgCtx = bgCanvas.getContext('2d', { alpha:false });
const graphCanvas = document.getElementById('graph-canvas');
const graphCtx = graphCanvas.getContext('2d');

let DPR = Math.min(2, window.devicePixelRatio || 1);
let W=0, H=0;

function resize(){
  W = window.innerWidth;
  H = window.innerHeight;
  [mainCanvas, bgCanvas, graphCanvas].forEach(c => {
    c.width = Math.floor(W * DPR);
    c.height = Math.floor(H * DPR);
    c.style.width = W + 'px';
    c.style.height = H + 'px';
  });
  mainCtx.setTransform(DPR,0,0,DPR,0,0);
  bgCtx.setTransform(DPR,0,0,DPR,0,0);
  graphCtx.setTransform(DPR,0,0,DPR,0,0);
  
  graphCanvas.height = Math.floor(120 * DPR);
  graphCanvas.style.height = '120px';
}
new ResizeObserver(resize).observe(document.body);
resize();

function clamp(v,a,b){return Math.max(a, Math.min(b, v))}
function lerp(a,b,t){return a+(b-a)*t}
function rand(a,b){return a + Math.random()*(b-a)}
function pick(arr){return arr[(Math.random()*arr.length)|0]}

/* ===================== Audio (WebAudio, no files) ===================== */
let audioCtx, master, canAudio=false;
function initAudio(){
  if (audioCtx) return;
  try {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    master = audioCtx.createGain(); master.gain.value=0.15; master.connect(audioCtx.destination);
    canAudio = true;
  } catch(e){ canAudio=false; }
}
function playSound(type){
  if(!canAudio) return;
  if(type === 'buy'){
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type='sine'; o.frequency.setValueAtTime(800, audioCtx.currentTime); o.frequency.linearRampToValueAtTime(1200, audioCtx.currentTime+0.1);
    g.gain.setValueAtTime(0.2, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.1);
    o.connect(g); g.connect(master); o.start(); o.stop(audioCtx.currentTime+0.1);
  } else if(type === 'sell'){
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type='sine'; o.frequency.setValueAtTime(600, audioCtx.currentTime); o.frequency.linearRampToValueAtTime(400, audioCtx.currentTime+0.1);
    g.gain.setValueAtTime(0.2, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.1);
    o.connect(g); g.connect(master); o.start(); o.stop(audioCtx.currentTime+0.1);
  } else if(type === 'crash'){
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type='sawtooth'; o.frequency.value = 120; o.detune.setValueAtTime(-400, audioCtx.currentTime);
    g.gain.setValueAtTime(0.001, audioCtx.currentTime); g.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime+0.05); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 1.5);
    o.connect(g);g.connect(master); o.start(); o.stop(audioCtx.currentTime+1.5);
  } else if (type === 'event') {
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type='triangle'; o.frequency.value=330;
    g.gain.setValueAtTime(0.001, audioCtx.currentTime); g.gain.linearRampToValueAtTime(0.25, audioCtx.currentTime+0.1); g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+1.2);
    o.connect(g);g.connect(master); o.start(); o.stop(audioCtx.currentTime+1.3);
  }
}
/* ===================== Input ===================== */
let inputX = W/2, touching=false;
document.body.addEventListener('pointerdown',e=>{if(!audioCtx) initAudio(); touching=true; setInput(e);});
document.body.addEventListener('pointermove',e=>{ if(touching) setInput(e); });
document.body.addEventListener('pointerup',()=>touching=false);
document.body.addEventListener('pointercancel',()=>touching=false);
function setInput(e){ inputX = clamp(e.clientX, 0, W); }

/* ===================== Game Data ===================== */
const hudPortfolio = document.getElementById('portfolioValue').querySelector('.value');
const hudCash = document.getElementById('cash').querySelector('.value');
const hudDate = document.getElementById('currentDate').querySelector('.value');
const eventEl = document.getElementById('event');

const MONTH_NAMES = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

const STOCK_DATA = {
  'AAPL': { name: 'Apple', sector: 'TECH', base: 6, trend: 1.006, vol: 0.15, color: '#999' },
  'GOOGL': { name: 'Google', sector: 'TECH', base: 10, trend: 1.005, vol: 0.18, color: '#4285F4' },
  'MSFT': { name: 'Microsoft', sector: 'TECH', base: 25, trend: 1.004, vol: 0.12, color: '#00A4EF' },
  'AMZN': { name: 'Amazon', sector: 'ECOMM', base: 40, trend: 1.007, vol: 0.22, color: '#FF9900' },
  'TSLA': { name: 'Tesla', sector: 'AUTO', base: 5, trend: 1.012, vol: 0.45, color: '#E31937' },
  'NVDA': { name: 'Nvidia', sector: 'TECH', base: 10, trend: 1.009, vol: 0.35, color: '#76B900' },
  'JPM': { name: 'JPMorgan', sector: 'FIN', base: 40, trend: 1.002, vol: 0.18, color: '#00589F' },
  'XOM': { name: 'ExxonMobil', sector: 'OIL', base: 60, trend: 1.001, vol: 0.2, color: '#D81E2A' }
};

const HISTORICAL_EVENTS = [
  { date: new Date('2007-06-29'), name: "iPhone Launches", line: "Apple changes the world of technology.", effect: { type: 'sector_boom', sector: 'TECH', mult: 1.01 } },
  { date: new Date('2008-09-15'), name: "Financial Crisis", line: "A global financial meltdown begins.", effect: { type: 'market_crash', mult: 0.85 } },
  { date: new Date('2011-10-05'), name: "Passing of Steve Jobs", line: "Mourning in the tech world.", effect: { type: 'stock_shock', ticker: 'AAPL', mult: 0.9 } },
  { date: new Date('2014-06-01'), name: "EV Bubble Begins", line: "Interest in Tesla soars.", effect: { type: 'sector_boom', sector: 'AUTO', mult: 1.02 } },
  { date: new Date('2015-08-01'), name: "E-Commerce Soars", line: "Amazon breaks new records.", effect: { type: 'sector_boom', sector: 'ECOMM', mult: 1.015 } },
  { date: new Date('2018-01-01'), name: "Crypto Craze", line: "Market is volatile, tech sector strengthens.", effect: { type: 'sector_boom', sector: 'TECH', mult: 1.005 } },
  { date: new Date('2020-03-11'), name: "COVID-19 Pandemic", line: "The world shuts down, markets plummet.", effect: { type: 'market_crash', mult: 0.75 } },
  { date: new Date('2020-08-01'), name: "The 'Stay-at-Home' Boom", line: "Tech and e-commerce stocks hit all-time highs.", effect: { type: 'sector_boom', sectors: ['TECH', 'ECOMM'], mult: 1.03 } },
  { date: new Date('2022-01-01'), name: "Inflation Fears", line: "Central banks begin to raise interest rates.", effect: { type: 'market_dip', mult: 0.95 } },
  { date: new Date('2023-02-01'), name: "The AI Revolution", line: "The world discovers generative AI.", effect: { type: 'sector_boom', stock: 'NVDA', mult: 1.05 } },
];

/* ===================== Game State ===================== */
const STATE = {
  running:true, t:0, dt:0,
  gameDate: new Date('2005-01-01'),
  endDate: new Date('2025-08-01'),
  timeScale: 150, // months per minute (e.g., 120 means a year passes in 1 minute)
  lanes: [W*0.25, W*0.5, W*0.75],
  scrollSpeed: 320,
  
  // Player / Portfolio
  p:{ x:W/2, y:H*0.8, r:24, targetLane:1 },
  cash: 100000,
  portfolio: {}, // { 'AAPL': { shares: 10, avgCost: 150 } }
  portfolioValue: 100000,
  portfolioHistory: [],
  maxHistoryValue: 100000,

  market: {}, // { 'AAPL': 150.25 }
  activeEvents: [],
  nextEventIndex: 0,
  
  opportunities: [],
  spawnTimer: 1, // seconds
  shake: 0,
  fx:[],
};

// Initialize market
for (const ticker in STOCK_DATA) {
  STATE.market[ticker] = STOCK_DATA[ticker].base;
  STATE.portfolio[ticker] = { shares: 0, avgCost: 0 };
}

/* ===================== Game Logic ===================== */
function updateDate(dt) {
  const timePassed = dt * (STATE.timeScale / 60); // in months
  const newDate = new Date(STATE.gameDate);
  const currentMonth = newDate.getMonth();
  
  newDate.setMonth(newDate.getMonth() + timePassed);
  
  if (newDate.getMonth() !== currentMonth) {
    updateStockPrices(newDate);
    updatePortfolioValue();
    
    // Record history once per month
    if(STATE.portfolioHistory.length > W/2) STATE.portfolioHistory.shift();
    STATE.portfolioHistory.push({date: new Date(newDate), value: STATE.portfolioValue});
    STATE.maxHistoryValue = Math.max(STATE.maxHistoryValue, STATE.portfolioValue);
  }
  
  STATE.gameDate = newDate;

  if (STATE.gameDate >= STATE.endDate) {
    endGame();
  }
}

function updateStockPrices(date) {
  let globalMult = 1.0;
  STATE.activeEvents.forEach(e => {
    if (e.effect.type === 'market_crash' || e.effect.type === 'market_dip') {
      globalMult *= e.effect.mult;
    }
  });

  for (const ticker in STOCK_DATA) {
    const stock = STOCK_DATA[ticker];
    let price = STATE.market[ticker];
    let trend = stock.trend;
    
    // Apply event effects
    STATE.activeEvents.forEach(e => {
        if (e.effect.type === 'sector_boom' && (e.effect.sector === stock.sector || (e.effect.sectors && e.effect.sectors.includes(stock.sector)) || e.effect.stock === ticker)) {
            trend *= e.effect.mult;
        }
        if (e.effect.type === 'stock_shock' && e.effect.ticker === ticker) {
            price *= e.effect.mult;
            e.used = true; // one-time shock
        }
    });

    // Remove used-up one-time events
    STATE.activeEvents = STATE.activeEvents.filter(e => !e.used);

    const noise = 1 + (Math.random() - 0.5) * stock.vol;
    price *= trend * noise * globalMult;
    STATE.market[ticker] = Math.max(0.01, price);
  }
}

function checkEvents() {
  if (STATE.nextEventIndex < HISTORICAL_EVENTS.length) {
    const nextEvent = HISTORICAL_EVENTS[STATE.nextEventIndex];
    if (STATE.gameDate >= nextEvent.date) {
      eventEl.innerHTML = `<div class="event-name">${nextEvent.name}</div><div class="event-line">${nextEvent.line}</div>`;
      eventEl.classList.add('show');
      setTimeout(() => eventEl.classList.remove('show'), 3500);

      STATE.activeEvents.push(nextEvent);
      if (nextEvent.effect.type === 'market_crash') {
          STATE.shake = 20;
          playSound('crash');
      } else {
          playSound('event');
      }
      STATE.nextEventIndex++;
    }
  }
}

function updatePortfolioValue() {
  let stockValue = 0;
  for (const ticker in STATE.portfolio) {
    stockValue += STATE.portfolio[ticker].shares * STATE.market[ticker];
  }
  const newValue = STATE.cash + stockValue;
  if(newValue > STATE.portfolioValue) hudPortfolio.classList.add('up'); else hudPortfolio.classList.add('down');
  hudPortfolio.classList.remove(newValue > STATE.portfolioValue ? 'down' : 'up');
  STATE.portfolioValue = newValue;
}

function spawnOpportunity() {
  const ticker = pick(Object.keys(STOCK_DATA));
  const x = rand(W*0.2, W*0.8); // Appear at random horizontal positions
  const y = 140; // start below graph
  
  STATE.opportunities.push({ ticker, x, y, r: 35 });
}

function executeTrade(op) {
  const lane = STATE.p.targetLane;
  const price = STATE.market[op.ticker];
  const stockPortfolio = STATE.portfolio[op.ticker];
  
  if (lane === 2) { // BUY
    const sharesToBuy = Math.floor((STATE.cash * 0.25) / price); // Buy with 25% of cash
    if (sharesToBuy > 0) {
      const cost = sharesToBuy * price;
      stockPortfolio.avgCost = ((stockPortfolio.avgCost * stockPortfolio.shares) + cost) / (stockPortfolio.shares + sharesToBuy);
      stockPortfolio.shares += sharesToBuy;
      STATE.cash -= cost;
      addFxText(op.x, op.y, `+${sharesToBuy}`, '#5f5');
      playSound('buy');
    }
  } else if (lane === 0) { // SELL
    const sharesToSell = Math.floor(stockPortfolio.shares * 0.5); // Sell 50% of holding
    if (sharesToSell > 0) {
      const income = sharesToSell * price;
      stockPortfolio.shares -= sharesToSell;
      STATE.cash += income;
      addFxText(op.x, op.y, `-${sharesToSell}`, '#f55');
      playSound('sell');
    }
  } else { // HOLD
      addFxText(op.x, op.y, 'HOLD', '#ccc');
  }
}

function endGame() {
    STATE.running = false;
    eventEl.innerHTML = `<div class="event-name">The Journey is Complete!</div>
    <div class="event-line">Final Net Worth: ${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(STATE.portfolioValue)}</div>`;
    eventEl.classList.add('show');
    document.getElementById('tips').style.display = 'none';
}

/* ===================== Drawing & FX ===================== */
function drawBackground() {
  let bull = 0, bear = 0;
  STATE.activeEvents.forEach(e => {
    if(e.effect.type === 'market_crash') bear = Math.max(bear, 0.8);
    if(e.effect.type === 'market_dip') bear = Math.max(bear, 0.4);
    if(e.effect.type === 'sector_boom') bull = Math.max(bull, 0.6);
  });
  
  const topColorR = lerp(lerp(30, 30, bull), 80, bear);
  const topColorG = lerp(lerp(30, 80, bull), 30, bear);
  const botColorR = 10;
  const botColorG = 15;

  const g=bgCtx.createLinearGradient(0,0,0,H);
  g.addColorStop(0, `rgb(${topColorR}, ${topColorG}, 50)`);
  g.addColorStop(1, `rgb(${botColorR}, ${botColorG}, 24)`);
  bgCtx.fillStyle=g;
  bgCtx.fillRect(0,0,W,H);
  
  // Starfield
  bgCtx.fillStyle = 'rgba(255,255,255,0.7)';
  for(let i=0; i<100; i++){
    const x = ((i*37.34 + STATE.t*15) % W);
    const y = ((i*217.65 + STATE.t*15) % H);
    bgCtx.fillRect(x,y,1,1);
  }
}

function drawGraph() {
    graphCtx.clearRect(0,0,W,120);
    const hist = STATE.portfolioHistory;
    if (hist.length < 2) return;

    graphCtx.save();
    graphCtx.setTransform(DPR,0,0,DPR,0,0);
    graphCtx.strokeStyle = 'rgba(100,200,255,0.7)';
    graphCtx.lineWidth = 2;
    graphCtx.beginPath();

    const maxVal = STATE.maxHistoryValue * 1.1;
    for(let i=0; i<hist.length; i++){
        const p = hist[i];
        const x = (i / (hist.length-1)) * W;
        const y = 110 - (p.value / maxVal) * 100;
        if(i===0) graphCtx.moveTo(x,y);
        else graphCtx.lineTo(x,y);
    }
    graphCtx.stroke();
    
    const grad = graphCtx.createLinearGradient(0,0,0,120);
    grad.addColorStop(0,'rgba(100,200,255,0.2)');
    grad.addColorStop(1,'rgba(100,200,255,0)');
    graphCtx.fillStyle = grad;
    graphCtx.lineTo(W, 120);
    graphCtx.lineTo(0, 120);
    graphCtx.closePath();
    graphCtx.fill();

    graphCtx.restore();
}

function addFxText(x,y,text,color){
  STATE.fx.push({x,y,text,color,life:1,alpha:1});
}

function drawFX(dt){
  for(let i=STATE.fx.length-1;i>=0;i--){
    const f=STATE.fx[i];
    f.y -= 40*dt; f.life -= dt; f.alpha = Math.max(0, f.life);
    mainCtx.font = `bold 18px sans-serif`;
    mainCtx.textAlign = 'center';
    if(f.color.startsWith('#')){
        const r = parseInt(f.color.slice(1,3),16);
        const g = parseInt(f.color.slice(3,5),16);
        const b = parseInt(f.color.slice(5,7),16);
        mainCtx.fillStyle = `rgba(${r},${g},${b},${f.alpha})`;
    }
    mainCtx.fillText(f.text, f.x, f.y);
    if(f.life<=0) STATE.fx.splice(i,1);
  }
}

const formatCurrency = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(val);

/* ===================== Update & Draw Loop ===================== */
let last = 0;
function loop(t){
  if(!STATE.running) return;
  if(!last) last=t;
  const dt = Math.min(0.033, (t-last)/1000);
  last=t;
  STATE.t += dt; STATE.dt=dt;

  if (STATE.shake>0) STATE.shake = Math.max(0, STATE.shake - 40*dt);
  const sx = (Math.random()-0.5)*STATE.shake;
  const sy = (Math.random()-0.5)*STATE.shake;
  mainCtx.save();
  mainCtx.translate(sx,sy);
  
  updateDate(dt);
  checkEvents();

  const p = STATE.p;
  if (inputX < W * (1/3)) p.targetLane = 0;
  else if (inputX < W * (2/3)) p.targetLane = 1;
  else p.targetLane = 2;
  p.x = lerp(p.x, STATE.lanes[p.targetLane], 0.2);
  
  document.getElementById('sell-label').classList.toggle('active', p.targetLane === 0);
  document.getElementById('hold-label').classList.toggle('active', p.targetLane === 1);
  document.getElementById('buy-label').classList.toggle('active', p.targetLane === 2);
  
  STATE.spawnTimer -= dt;
  if (STATE.spawnTimer <= 0) {
    spawnOpportunity();
    STATE.spawnTimer = rand(1.5, 2.5);
  }

  for (let i = STATE.opportunities.length - 1; i >= 0; i--) {
    const op = STATE.opportunities[i];
    op.y += STATE.scrollSpeed * dt;
    const hitZoneY = p.y;
    if (op.y > hitZoneY && op.y < hitZoneY + STATE.scrollSpeed * dt) {
        if(Math.abs(op.x - p.x) < op.r + p.r) {
            executeTrade(op);
            STATE.opportunities.splice(i, 1);
            updatePortfolioValue();
        }
    } else if (op.y > H + op.r) {
      STATE.opportunities.splice(i, 1);
    }
  }

  mainCtx.clearRect(0,0,W,H);
  drawBackground();
  drawGraph();

  STATE.opportunities.forEach(op => {
    const stock = STOCK_DATA[op.ticker];
    mainCtx.fillStyle = stock.color;
    mainCtx.beginPath();
    mainCtx.arc(op.x, op.y, op.r, 0, 6.28);
    mainCtx.fill();
    mainCtx.fillStyle = '#fff';
    mainCtx.font = 'bold 16px sans-serif';
    mainCtx.textAlign = 'center';
    mainCtx.textBaseline = 'middle';
    mainCtx.fillText(op.ticker, op.x, op.y - 8);
    mainCtx.font = '12px sans-serif';
    mainCtx.fillText(`$${STATE.market[op.ticker].toFixed(2)}`, op.x, op.y + 12);
  });
  
  mainCtx.font = '42px sans-serif';
  mainCtx.textAlign = 'center';
  mainCtx.fillText('🧑‍💼', p.x, p.y + 12);

  drawFX(dt);
  mainCtx.restore();
  
  hudPortfolio.textContent = formatCurrency(STATE.portfolioValue);
  hudCash.textContent = formatCurrency(STATE.cash);
  hudDate.textContent = `${MONTH_NAMES[STATE.gameDate.getMonth()]} ${STATE.gameDate.getFullYear()}`;
  
  requestAnimationFrame(loop);
}

updatePortfolioValue();
requestAnimationFrame(loop);
})();
</script>
</body>
</html>
