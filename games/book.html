<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>××—×•×œ×œ ×”×¡×™×¤×•×¨×™× ×”×§×¡×•×</title>

<!-- ×”×¨×©××ª ×¨×©×ª ××•×ª×¨×ª: Google Fonts + Font Awesome ×‘×œ×‘×“ -->
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700;900&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

<style>
:root{
  --bg: #0d1117;
  --card:#151b23;
  --text:#e6edf3;
  --muted:#8b949e;
  --accent:#7c3aed; /* ×¡×’×•×œ ×§×¡×•× */
  --accent-2:#10b981; /* ×™×¨×•×§ ×§×¡× */
  --ink:#0d1117;
  --paper:#ffffff;
  --shadow: 0 10px 30px rgba(0,0,0,.35);
}

:root[data-theme="light"]{
  --bg:#f6f8fa;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#475569;
  --accent:#7c3aed;
  --accent-2:#0284c7;
  --ink:#0f172a;
  --paper:#ffffff;
  --shadow: 0 10px 25px rgba(2,6,23,.08);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:Heebo, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
  background:var(--bg); color:var(--text);
}

.header{
  position:sticky; top:0; z-index:1000; backdrop-filter:saturate(1.2) blur(8px);
  background:color-mix(in oklab, var(--bg) 80%, transparent);
  border-bottom:1px solid color-mix(in oklab, var(--text) 15%, transparent);
}
.container{max-width:980px; margin:0 auto; padding:12px 16px}
.header .row{display:flex; align-items:center; gap:10px; justify-content:space-between}
.brand{display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.3px}
.brand .logo{
  width:36px; height:36px; border-radius:12px; display:grid; place-items:center;
  background: linear-gradient(135deg, var(--accent), var(--accent-2));
  color:white; box-shadow: var(--shadow); font-size:18px;
}

.toolbar{display:flex; gap:8px; flex-wrap:wrap}
.btn{
  display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px;
  border:1px solid color-mix(in oklab, var(--text) 15%, transparent);
  background:color-mix(in oklab, var(--card) 90%, transparent);
  color:var(--text); cursor:pointer; box-shadow: var(--shadow);
  transition:.2s transform, .2s background, .2s border-color, .2s opacity;
  text-decoration:none; user-select:none;
}
.btn:hover{ transform:translateY(-1px)}
.btn.primary{ background: linear-gradient(135deg, var(--accent), var(--accent-2)); border-color:transparent; color:#fff; }
.btn.ghost{ background:transparent }
.btn.icon{ padding:10px; width:42px; justify-content:center }

.main{padding:20px 16px; max-width:980px; margin:0 auto;}

.card{
  background:var(--card); border:1px solid color-mix(in oklab, var(--text) 12%, transparent);
  border-radius:18px; padding:16px; box-shadow:var(--shadow);
}

h1,h2,h3{margin:0 0 12px}
h1{font-size:clamp(24px, 3vw, 34px);}
h2{font-size:clamp(20px, 2.4vw, 26px);}
p{line-height:1.7; color:var(--text); margin:0 0 10px}
.muted{color:var(--muted)}

textarea{
  width:100%; min-height:140px; resize:vertical; padding:14px; border-radius:14px;
  border:1px solid color-mix(in oklab, var(--text) 15%, transparent);
  background: color-mix(in oklab, var(--card) 92%, transparent);
  color:var(--text); font-size:16px;
}

.grid{display:grid; gap:16px}
@media(min-width:720px){ .grid.cols-2{ grid-template-columns: 1.2fr .8fr } }

.helper{
  display:flex; gap:10px; align-items:flex-start; color:var(--muted); font-size:14px
}
.helper i{ color:var(--accent-2); margin-top:3px }

.center{ display:flex; justify-content:center; align-items:center; gap:10px; flex-wrap:wrap }

hr.sep{
  height:1px; border:0; background: color-mix(in oklab, var(--text) 14%, transparent);
  margin:14px 0;
}

/* ×©× ×™ ×”××¡×›×™× */
#generator-view{}
#book-view{ display:none }

/* ×¡×¤×¨ */
.book{
  display:grid; gap:18px;
}
.chapter{
  padding:16px; border-radius:16px; background: color-mix(in oklab, var(--card) 95%, transparent);
  border:1px dashed color-mix(in oklab, var(--text) 18%, transparent);
}
.chapter .illus{ width:100%; aspect-ratio:16/9; border-radius:12px; overflow:hidden; background:#0b1220; display:grid; place-items:center; }
.chapter .illus img{ width:100%; height:100%; object-fit:contain; background:transparent }
.tools-row{ display:flex; gap:8px; flex-wrap:wrap }
.badge{
  display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-size:13px;
  background: color-mix(in oklab, var(--accent) 15%, transparent); color:var(--text);
  border:1px solid color-mix(in oklab, var(--accent) 40%, transparent);
}

/* Toast */
.toast{
  position:fixed; inset-inline:0; bottom:14px; display:grid; place-items:center; pointer-events:none; z-index:2000;
}
.toast .pill{
  pointer-events:auto;
  background: color-mix(in oklab, var(--ink) 30%, var(--paper) 70%);
  color: var(--ink);
  border-radius:999px; padding:10px 14px; box-shadow: var(--shadow); border:1px solid #0001;
}

/* Overlay ×˜×¢×™× ×” */
#loading-overlay{
  position:fixed; inset:0; display:none; z-index:1500;
  background:
    radial-gradient(1200px 1200px at 10% 10%, color-mix(in oklab, var(--accent) 20%, transparent), transparent 60%),
    radial-gradient(1000px 1000px at 90% 10%, color-mix(in oklab, var(--accent-2) 18%, transparent), transparent 60%),
    linear-gradient(180deg, color-mix(in oklab, var(--bg) 92%, transparent), var(--bg));
  color:#fff;
}
#loading-overlay .inner{
  height:100%; display:grid; place-items:center; text-align:center; padding:24px;
}
.loader{
  width:72px; height:72px; border-radius:50%; border:6px solid #ffffff30; border-top-color:#fff; animation:spin 1s linear infinite; margin:0 auto 16px;
}
@keyframes spin{ to{ transform:rotate(360deg) } }

/* Print */
@media print{
  .header, #generator-view .card:first-of-type, .toolbar { display:none !important }
  body{ background:var(--paper); color:var(--ink) }
  .card, .chapter{ border-color:#0003; background:var(--paper); box-shadow:none }
  .illus{ background:#fff }
}
</style>
</head>
<body>

<header class="header">
  <div class="container">
    <div class="row">
      <div class="brand">
        <div class="logo"><i class="fa-solid fa-wand-magic-sparkles"></i></div>
        <div>××—×•×œ×œ ×”×¡×™×¤×•×¨×™× ×”×§×¡×•×</div>
      </div>
      <div class="toolbar">
        <button id="themeToggle" class="btn icon" title="××¦×‘ ×™×•×/×œ×™×œ×”"><i class="fa-solid fa-circle-half-stroke"></i></button>
        <a id="shareWhatsApp" class="btn" target="_blank" rel="noopener"><i class="fa-brands fa-whatsapp"></i> ×©×™×ª×•×£</a>
        <button id="exportPdfBtn" class="btn"><i class="fa-solid fa-file-arrow-down"></i> ×”×•×¨×“×” ×›-PDF</button>
        <button id="playAllBtn" class="btn"><i class="fa-solid fa-play"></i> × ×’×Ÿ ×”×›×œ</button>
        <button id="newStoryBtn" class="btn ghost"><i class="fa-solid fa-plus"></i> ×”×ª×—×œ ×¡×™×¤×•×¨ ×—×“×©</button>
      </div>
    </div>
  </div>
</header>

<main class="main">
  <!-- ××¡×š 1: ×”××—×•×œ×œ -->
  <section id="generator-view" class="grid cols-2">
    <div class="card">
      <h1>××—×•×œ×œ ×”×¡×™×¤×•×¨×™× ×”×§×¡×•×</h1>
      <p class="muted">×›×ª×‘×• ×¨×¢×™×•×Ÿ ×§×¦×¨, ×•×× ×• × ×”×¤×•×š ××•×ª×• ×œ×¡×¤×¨ ×“×™×’×™×˜×œ×™ ×©×œ× â€“ ×¤×¨×§×™×, ××™×•×¨×™×, ×§×¨×™×™× ×•×ª, ×•×”×•×¨×“×” ×›-PDF.</p>
      <hr class="sep">
      <label for="storyPrompt"><strong>×”×©×¨××” ×œ×¡×™×¤×•×¨</strong></label>
      <textarea id="storyPrompt" placeholder="×œ×“×•×’××”: ×“×¨×§×•×Ÿ ×‘×™×™×©×Ÿ ×©×¨×•×¦×” ×œ×”×›×™×Ÿ ×¢×•×’×ª ×©×•×§×•×œ×“ ×¢×œ ×”×™×¨×—, ×¢× ×¨×•×‘×•×˜ ××¦×—×™×§ ×©××¤×—×“ ××—×ª×•×œ×™×."></textarea>
      <div style="height:10px"></div>
      <div class="center">
        <button id="generateBtn" class="btn primary"><i class="fa-solid fa-sparkles"></i> ×¦×•×¨ ×œ×™ ×¡×™×¤×•×¨ ×§×¡×•×!</button>
      </div>
      <div style="height:8px"></div>
      <div class="helper">
        <i class="fa-solid fa-lightbulb"></i>
        <div>×˜×™×¤: ×”×©×ª××©×• ×‘××™×œ×™× ×›××• <em>×¤×™×¨××˜</em>, <em>×—×œ×œ</em>, <em>×××™×¥</em>, <em>×¢×¦×•×‘</em>, <em>×™×¢×¨</em>, <em>×™×¨×—</em> â€“ ×•×”××™×•×¨×™× ×™×•×ª×××• ××•×˜×•××˜×™×ª.</div>
      </div>
    </div>

    <div class="card">
      <h2>××™×š ×–×” ×¢×•×‘×“?</h2>
      <p class="muted">×”××¤×œ×™×§×¦×™×” ××“××” â€œ×‘×™× ×” ××œ××›×•×ª×™×ªâ€ ×‘×¦×“ ×”×œ×§×•×— ×‘×œ×‘×“: ××¤×¢× ×—×ª ××™×œ×•×ª ××¤×ª×—, ×‘×•×—×¨×ª ×ª×‘× ×™×ª ×¡×™×¤×•×¨, ×××œ××ª ×“××•×™×•×ª ×•××ª×’×¨×™×, ×•××ª××™××” ×¦×‘×¢×™× ×‘××™×•×¨×™ SVG ×œ×¤×™ ××¦×‘-×¨×•×—.</p>
      <ul class="muted">
        <li>××•×‘×™×™×œ-×¤×¨×¡×˜, RTL, ××¦×‘ ×™×•×/×œ×™×œ×” ×•×©××™×¨×” ××•×˜×•××˜×™×ª.</li>
        <li>×§×¨×™×™× ×•×ª ×œ×›×œ ×¤×¡×§×” ×•×œ×›×œ ×”×¡×¤×¨ (pause/resume + ××”×™×¨×•×ª).</li>
        <li>×”×“×¤×¡×”/×©××™×¨×” ×œ-PDF ××”×“×¤×“×¤×Ÿ (×•×¢×•×’×Ÿ ×œ×”×˜××¢×ª jsPDF+html2canvas).</li>
        <li>×©×™×ª×•×£ ×§×œ ×‘×•×•×˜×¡××¤.</li>
      </ul>
      <div class="badge"><i class="fa-solid fa-lock"></i> ×¢×•×‘×“ 100% ×‘×“×¤×“×¤×Ÿ â€“ ×œ×œ× ×©×¨×ª</div>
    </div>
  </section>

  <!-- ××¡×š 2: ×”×¡×¤×¨ -->
  <section id="book-view" class="book">
    <div class="card">
      <h2 id="bookTitle">â€”</h2>
      <p id="bookSubtitle" class="muted">â€”</p>
      <div class="tools-row">
        <span class="badge"><i class="fa-solid fa-feather"></i> × ×›×ª×‘ ××•×˜×•××˜×™×ª</span>
        <span id="createdAtBadge" class="badge"><i class="fa-regular fa-clock"></i> â€”</span>
      </div>
    </div>
    <div id="chapters"></div>
  </section>
</main>

<!-- Overlay ×˜×¢×™× ×” -->
<div id="loading-overlay">
  <div class="inner">
    <div>
      <div class="loader"></div>
      <h2>×¨×•×§× ××™×œ×™×, ××¦×™×™×¨ ×›×•×›×‘×™×...</h2>
      <p class="muted">×”×¡×™×¤×•×¨ ×©×œ×š × ×•×¦×¨â€¦</p>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast" aria-live="polite"></div>

<script>
(function(){
  // ===============================
  // ××¦×‘ ×™×•×/×œ×™×œ×” + ×©××™×¨×”
  // ===============================
  const root = document.documentElement;
  const THEME_KEY = 'story.theme';
  function applyTheme(theme){
    root.setAttribute('data-theme', theme);
    localStorage.setItem(THEME_KEY, theme);
  }
  const savedTheme = localStorage.getItem(THEME_KEY) || (matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
  applyTheme(savedTheme);
  document.getElementById('themeToggle').addEventListener('click', ()=>{
    applyTheme(root.getAttribute('data-theme')==='light' ? 'dark' : 'light');
    ping('×”×—×œ×¤× ×• ××¦×‘ ×ª×¦×•×’×”');
  });

  // ===============================
  // UI refs
  // ===============================
  const generatorView = document.getElementById('generator-view');
  const bookView = document.getElementById('book-view');
  const storyPrompt = document.getElementById('storyPrompt');
  const generateBtn = document.getElementById('generateBtn');
  const loadingOverlay = document.getElementById('loading-overlay');
  const bookTitleEl = document.getElementById('bookTitle');
  const bookSubtitleEl = document.getElementById('bookSubtitle');
  const createdAtBadge = document.getElementById('createdAtBadge');
  const chaptersEl = document.getElementById('chapters');
  const shareBtn = document.getElementById('shareWhatsApp');
  const exportPdfBtn = document.getElementById('exportPdfBtn');
  const playAllBtn = document.getElementById('playAllBtn');
  const newStoryBtn = document.getElementById('newStoryBtn');

  // ===============================
  // ×©××™×¨×”/×˜×¢×™× ×”
  // ===============================
  const SAVE_KEY = 'story.last';
  function saveState(state){
    localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  }
  function loadState(){
    try{
      const s = JSON.parse(localStorage.getItem(SAVE_KEY)||'null');
      return s;
    }catch{ return null }
  }

  // ×˜×¢×™× ×” ××•×˜×•××˜×™×ª ×©×œ ×¡×¤×¨ ××—×¨×•×Ÿ
  const last = loadState();
  if(last && last.title){
    renderBook(last);
    switchTo('book');
  } else {
    switchTo('generator');
  }

  // ===============================
  // â€œAIâ€ ×¡×™××•×œ×˜×™×‘×™: ×ª×‘× ×™×•×ª ×•××™×œ×•×Ÿ
  // ===============================
  const keywordMap = {
    '×¤×™×¨××˜': { hero:'×©×•×“×“ ×”×™× ×—×“-×”×¢×™×Ÿ', place:'××™ ×¡×•×“×™', challenge:'×¡×¢×¨×” ××™××ª× ×™×ª', solution:'××•××¥ ×•×—×‘×¨×•×ª' },
    '×“×¨×§×•×Ÿ': { hero:'×“×¨×§×•×Ÿ ×‘×™×™×©×Ÿ', place:'×”×¨ ×¢×¨×¤×™×œ×™', challenge:'×œ××¦×•× ×—×‘×¨', solution:'×¢×•×’×ª ×©×•×§×•×œ×“ ××©×•×ª×¤×ª' },
    '×—×œ×œ': { hero:'××¡×˜×¨×•× ××•×˜ ×¦×¢×™×¨', place:'×ª×—× ×ª ×—×œ×œ', challenge:'××›×©×™×¨ ×©×”×ª×§×œ×§×œ', solution:'×—×©×™×‘×” ×™×¦×™×¨×ª×™×ª' },
    '×™×¢×¨': { hero:'×©×•××¨×ª ×”×™×¢×¨', place:'×™×¢×¨ ×¢×ª×™×§', challenge:'×©×‘×™×œ ×©××‘×“', solution:'×¨×•×— ×˜×•×‘×” ×•××¦×¤×Ÿ' },
    '×™×¨×—': { hero:'××•×¤×” ×™×¨×—×™', place:'×”×™×¨×—', challenge:'×›×‘×™×“×” ××•×–×¨×”', solution:'×§××— ×›×•×›×‘×™×' },
    '×¨×•×‘×•×˜': { hero:'×¨×•×‘×•×˜ ××¦×—×™×§', place:'××¢×‘×“×” ×¦×‘×¢×•× ×™×ª', challenge:'×¨×¢×© ××¤×—×™×“', solution:'×œ×¦×—×•×§ ×¢×œ ×”×¤×—×“' },
    '×××™×¥': { tone:'brave' },
    '×¢×¦×•×‘': { tone:'sad' },
    '××¦×—×™×§': { tone:'funny' },
    '×§×¡×': { tone:'magic' }
  };

  const templates = [
`[×›×•×ª×¨×ª]: [×“××•×ª_×¨××©×™×ª] ×‘[××™×§×•×]
[×¤×ª×™×—]: ×¤×¢× ×‘××§×•× ×©× ×§×¨× [××™×§×•×], ×—×™/×” [×“××•×ª_×¨××©×™×ª]. 
[×¤×¨×§]: ×™×•× ××—×“ ×”×•×¤×™×¢ [××ª×’×¨], ×•×›×•×œ× ×“××’×•.
[×”××©×š]: ××‘×œ [×“××•×ª_×¨××©×™×ª] ××¡×£/×” ××ª ×”×›×•×—×•×ª, ×•×‘×™×—×“ ×¢× ×—×‘×¨×™× ××¦××• [×¤×ª×¨×•×Ÿ].
[×¡×™×•×]: ×××–, ×‘[××™×§×•×] ×œ×•××“×™× ×©×›×œ ××ª×’×¨ ×§×˜×Ÿ ×™×•×ª×¨ ×›×©× ×™×’×©×™× ××œ×™×• ×™×—×“.`,

`[×›×•×ª×¨×ª]: ×”×”×‘×˜×—×” ×©×œ [×“××•×ª_×¨××©×™×ª]
[×¤×ª×™×—]: ×œ[×“××•×ª_×¨××©×™×ª] ×ª××™×“ ×”×™×” ×—×œ×•× ××™×•×—×“ ×‘[××™×§×•×].
[×¤×¨×§]: ×›×©×”×’×™×¢ [××ª×’×¨], ×”×—×œ×•× × ×¨××” ×¨×—×•×§ ××ª××™×“.
[×”××©×š]: ××– × ×™×¡×• ×“×¨×š ××—×¨×ª â€“ ×§×¡×, ×“××™×•×Ÿ, ×•×§×¦×ª ×¡×‘×œ× ×•×ª â€“ ×¢×“ ×©×”×’×™×¢ [×¤×ª×¨×•×Ÿ].
[×¡×™×•×]: ×”×—×œ×•× ×”×ª×’×©×, ×•××•×¨ ×—×“×© ××™×œ× ××ª [××™×§×•×].`,

`[×›×•×ª×¨×ª]: ×ª×¢×œ×•××ª [××™×§×•×]
[×¤×ª×™×—]: ×‘×•×§×¨ ××—×“ ×§×/×” [×“××•×ª_×¨××©×™×ª] ×•×’×™×œ×”/×ª×” ××©×”×• ××¡×ª×•×¨×™.
[×¤×¨×§]: [××ª×’×¨] ×”×ª×’×œ×’×œ ×œ×¤×ª×— ×”×‘×™×ª.
[×”××©×š]: ××—×¨×™ ×—×§×™×¨×” ××¦×—×™×§×” ×•××œ××ª ×”×¤×ª×¢×•×ª, × ××¦× [×¤×ª×¨×•×Ÿ].
[×¡×™×•×]: ×•×›×š × ×¤×ª×¨×” ×”×ª×¢×œ×•××”, ×•×”×œ×‘ ×”×ª××œ× ×‘×©×§×˜ ×•×¨×•×’×¢.`
  ];

  // ===============================
  // ×¡×¤×¨×™×™×ª ××™×•×¨×™ SVG (× ×‘× ×” dataURL Base64 ×‘×–××Ÿ ×¨×™×¦×”)
  // ×›×œ ××™×•×¨ ×¢×•×‘×¨ ×× ×™×¤×•×œ×¦×™×” ×¦×‘×¢×•× ×™×ª ×œ×¤×™ ×˜×•×Ÿ (×œ××©×œ "×¢×¦×•×‘" â†’ ×›×—×•×œ).
  // ===============================
  const baseSvgs = {
    dragon: (color='#E11D48') => `
      <svg xmlns='http://www.w3.org/2000/svg' width='1024' height='576' viewBox='0 0 1024 576'>
        <defs>
          <linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
            <stop offset='0%' stop-color='${color}' stop-opacity='.85'/>
            <stop offset='100%' stop-color='#111827' stop-opacity='.95'/>
          </linearGradient>
        </defs>
        <rect width='100%' height='100%' fill='url(#g)'/>
        <g transform='translate(180,120)'>
          <path d='M0,200 C60,60 220,40 300,140 C360,210 540,160 580,240 C590,260 520,300 500,280 C440,230 350,260 300,230 C240,195 120,210 0,200' fill='#11182780'/>
          <g transform='translate(160,40)'>
            <circle cx='0' cy='0' r='60' fill='${color}'/>
            <circle cx='-15' cy='-10' r='8' fill='#fff'/>
            <circle cx='-15' cy='-10' r='3' fill='#111827'/>
            <path d='M-40,30 Q0,60 40,30' stroke='#fff' stroke-width='6' fill='none' stroke-linecap='round'/>
            <path d='M-65,-20 L-85,-60 L-45,-40 Z' fill='${color}' opacity='.8'/>
          </g>
        </g>
        <text x='28' y='550' fill='#ffffffaa' font-family='Heebo' font-size='22'>×“×¨×§×•×Ÿ ×‘×™×™×©×Ÿ</text>
      </svg>`,
    pirate: (color='#F59E0B') => `
      <svg xmlns='http://www.w3.org/2000/svg' width='1024' height='576' viewBox='0 0 1024 576'>
        <rect width='100%' height='100%' fill='#0f172a'/>
        <circle cx='180' cy='420' r='160' fill='#1e293b'/>
        <rect x='0' y='360' width='1024' height='216' fill='#0ea5a8'/>
        <g transform='translate(340,140)'>
          <rect x='-60' y='-30' width='120' height='60' fill='${color}' rx='12'/>
          <circle cx='-15' cy='-5' r='8' fill='#000'/>
          <rect x='-80' y='-90' width='160' height='40' fill='#111' rx='6'/>
          <rect x='-80' y='-90' width='70' height='40' fill='#111' rx='6' />
          <path d='M-70,-90 Q-65,-120 0,-120 Q65,-120 70,-90' fill='#111'/>
        </g>
        <text x='24' y='48' fill='#93c5fd' font-family='Heebo' font-size='24'>×¤×™×¨××˜ ×××™×¥</text>
      </svg>`,
    space: (color='#22d3ee') => `
      <svg xmlns='http://www.w3.org/2000/svg' width='1024' height='576' viewBox='0 0 1024 576'>
        <rect width='100%' height='100%' fill='#0b1020'/>
        <g fill='#fff'>
          <circle cx='50' cy='50' r='1'/><circle cx='120' cy='90' r='1'/><circle cx='240' cy='60' r='1'/>
          <circle cx='380' cy='40' r='1'/><circle cx='700' cy='80' r='1'/><circle cx='900' cy='30' r='1'/>
        </g>
        <circle cx='860' cy='130' r='68' fill='${color}'/>
        <g transform='translate(320,180)'>
          <circle cx='0' cy='0' r='36' fill='#e5e7eb'/>
          <rect x='-18' y='-60' width='36' height='30' rx='8' fill='#94a3b8'/>
          <rect x='-22' y='-16' width='44' height='18' rx='6' fill='#94a3b8'/>
        </g>
        <text x='30' y='540' fill='#ffffffcc' font-family='Heebo' font-size='22'>××¡×¢ ×‘×—×œ×œ</text>
      </svg>`,
    forest: (color='#10b981') => `
      <svg xmlns='http://www.w3.org/2000/svg' width='1024' height='576' viewBox='0 0 1024 576'>
        <rect width='100%' height='100%' fill='#052e2b'/>
        <g fill='${color}'>
          <path d='M120,460 L180,340 L240,460 Z'/><rect x='160' y='460' width='40' height='80' fill='#0b3b39'/>
          <path d='M360,460 L420,330 L480,460 Z'/><rect x='400' y='460' width='40' height='80' fill='#0b3b39'/>
          <path d='M620,460 L680,320 L740,460 Z'/><rect x='660' y='460' width='40' height='80' fill='#0b3b39'/>
        </g>
        <rect x='0' y='520' width='1024' height='56' fill='#083c3a'/>
        <text x='24' y='48' fill='#a7f3d0' font-family='Heebo' font-size='24'>×™×¢×¨ ×¢×ª×™×§</text>
      </svg>`,
    moon: (color='#cbd5e1') => `
      <svg xmlns='http://www.w3.org/2000/svg' width='1024' height='576' viewBox='0 0 1024 576'>
        <rect width='100%' height='100%' fill='#0b1020'/>
        <circle cx='780' cy='180' r='100' fill='${color}'/>
        <circle cx='750' cy='170' r='10' fill='#94a3b8'/><circle cx='820' cy='195' r='14' fill='#94a3b8'/>
        <rect x='0' y='460' width='1024' height='116' fill='#475569'/>
        <text x='28' y='540' fill='#e2e8f0' font-family='Heebo' font-size='22'>×¢×œ ×”×™×¨×—</text>
      </svg>`,
    robot: (color='#38bdf8') => `
      <svg xmlns='http://www.w3.org/2000/svg' width='1024' height='576' viewBox='0 0 1024 576'>
        <rect width='100%' height='100%' fill='#0b1220'/>
        <g transform='translate(360,160)'>
          <rect x='0' y='0' width='300' height='180' rx='16' fill='${color}'/>
          <circle cx='90' cy='70' r='18' fill='#0b1220'/><circle cx='200' cy='70' r='18' fill='#0b1220'/>
          <rect x='120' y='120' width='60' height='20' rx='8' fill='#0b1220'/>
        </g>
        <text x='28' y='48' fill='#bae6fd' font-family='Heebo' font-size='24'>×¨×•×‘×•×˜ ××¦×—×™×§</text>
      </svg>`
  };

  function svgToDataUrl(svgString){
    return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString)));
  }

  // ×‘×—×™×¨×ª ××™×•×¨ ×œ×¤×™ ××™×œ×ª ××¤×ª×— + ×˜×•×Ÿ ×¦×‘×¢×•× ×™
  function pickIllustration(keywords, tone){
    // ××™×¤×•×™ ×’×¡: ×¢×“×™×¤×•×ª ×œ×¤×™ ××™×œ×ª ××¤×ª×— ×©× ××¦××”
    if(keywords.includes('×“×¨×§×•×Ÿ')) return svgToDataUrl(baseSvgs.dragon(colorByTone(tone,'#E11D48')));
    if(keywords.includes('×¤×™×¨××˜')) return svgToDataUrl(baseSvgs.pirate(colorByTone(tone,'#F59E0B')));
    if(keywords.includes('×—×œ×œ')) return svgToDataUrl(baseSvgs.space(colorByTone(tone,'#22d3ee')));
    if(keywords.includes('×™×¢×¨')) return svgToDataUrl(baseSvgs.forest(colorByTone(tone,'#10b981')));
    if(keywords.includes('×™×¨×—')) return svgToDataUrl(baseSvgs.moon(colorByTone(tone,'#cbd5e1')));
    if(keywords.includes('×¨×•×‘×•×˜')) return svgToDataUrl(baseSvgs.robot(colorByTone(tone,'#38bdf8')));
    // ×‘×¨×™×¨×ª ××—×“×œ
    return svgToDataUrl(baseSvgs.forest(colorByTone(tone,'#10b981')));
  }

  function colorByTone(tone, base){
    if(tone==='sad') return '#3b82f6';
    if(tone==='brave') return '#ef4444';
    if(tone==='funny') return '#f59e0b';
    if(tone==='magic') return '#a855f7';
    return base;
  }

  // ===============================
  // ××—×•×œ×œ ×¡×™×¤×•×¨ ××ª×•×š ×¤×¨×•××¤×˜
  // ===============================
  function generateStoryFromPrompt(prompt){
    const text = (prompt||'').trim();
    const found = [];
    let tone = null;

    for(const k of Object.keys(keywordMap)){
      if(text.includes(k)){
        found.push(k);
        if(keywordMap[k].tone) tone = keywordMap[k].tone;
      }
    }

    // ×™×¦×™×¨×ª "××©×ª× ×™ ××™×œ×•×™"
    const base = found[0] && keywordMap[found[0]] || {};
    const vars = {
      ×“××•×ª_×¨××©×™×ª: base.hero || '×™×œ×“/×” ×¡×§×¨× /×™×ª',
      ××™×§×•×: base.place || '×›×¤×¨ ×¨×—×•×§',
      ××ª×’×¨: base.challenge || '×¡×•×“ ×œ× ×¤×ª×•×¨',
      ×¤×ª×¨×•×Ÿ: base.solution || '×©×™×ª×•×£ ×¤×¢×•×œ×”'
    };

    // ×‘×—×¨ ×ª×‘× ×™×ª ×•×¤×¦×œ ×œ×©×•×¨×•×ª
    const tpl = templates[Math.floor(Math.random()*templates.length)];
    const filled = tpl
      .replaceAll('[×“××•×ª_×¨××©×™×ª]', vars.×“××•×ª_×¨××©×™×ª)
      .replaceAll('[××™×§×•×]', vars.××™×§×•×)
      .replaceAll('[××ª×’×¨]', vars.××ª×’×¨)
      .replaceAll('[×¤×ª×¨×•×Ÿ]', vars.×¤×ª×¨×•×Ÿ);

    // × ×—×œ×¥ ×¤×¨×§×™×
    const lines = filled.split('\n').map(s=>s.trim()).filter(Boolean);
    const titleLine = lines.find(l=>l.startsWith('[×›×•×ª×¨×ª]:')) || '';
    const title = titleLine.replace('[×›×•×ª×¨×ª]:','').trim() || '×¡×™×¤×•×¨ ×§×¡×•×';

    // × ×™×™×¦×¨ 3-4 â€œ×¤×¨×§×™×â€ ××ª×•×š ×—×œ×§×™ ×”×ª×‘× ×™×ª
    const bodies = lines.filter(l=>!l.startsWith('[×›×•×ª×¨×ª]:')).map(l=>{
      return l.replace(/^\[(.*?)\]:\s*/,'');
    });
    const chapters = (bodies.length>=4 ? bodies.slice(0,4) : bodies).map((t,i)=>({
      heading: `×¤×¨×§ ${i+1}`,
      text: prettifyText(t)
    }));

    // ×›×•×ª×¨×ª ××©× ×”
    const subtitle = text || '×¡×™×¤×•×¨ ×©× ×•×¦×¨ ×××—×©×‘×” ××—×ª ×§×˜× ×”';

    // ××™×•×¨×™× (××—×“ ×œ×›×œ ×¤×¨×§)
    const illusUrl = pickIllustration(found, tone);
    const illusAlt = '××™×•×¨ × ×•×¦×¨';

    return {
      title,
      subtitle,
      createdAt: new Date().toISOString(),
      tone: tone || 'neutral',
      keywords: found,
      chapters: chapters.map(ch => ({
        ...ch,
        illu: illusUrl,
        illuAlt
      }))
    };
  }

  function prettifyText(t){
    // ×¤×™×¡×•×§ ×¢×“×™×Ÿ ×œ×™×œ×“×™×
    let s = t;
    if(!/[.!?]$/.test(s)) s += 'â€¦';
    return s;
  }

  // ===============================
  // ×¨×™× ×“×•×¨ ×¡×¤×¨ ×œ××¡×š
  // ===============================
  function renderBook(data){
    bookTitleEl.textContent = data.title;
    bookSubtitleEl.textContent = data.subtitle;
    createdAtBadge.innerHTML = `<i class="fa-regular fa-clock"></i> × ×•×¦×¨ ×‘-${new Date(data.createdAt).toLocaleString('he-IL')}`;
    chaptersEl.innerHTML = '';

    data.chapters.forEach((ch, idx)=>{
      const sec = document.createElement('section');
      sec.className = 'chapter';

      const h = document.createElement('h3');
      h.textContent = ch.heading;
      sec.appendChild(h);

      const ill = document.createElement('div');
      ill.className = 'illus';
      ill.innerHTML = `<img alt="${ch.illuAlt||''}" loading="lazy" src="${ch.illu}">`;
      sec.appendChild(ill);

      const p = document.createElement('p');
      p.textContent = ch.text;
      sec.appendChild(p);

      // ×›×¤×ª×•×¨×™ ×§×¨×™×™× ×•×ª ×œ×¤×¡×§×”/×›×•×ª×¨×ª
      const row = document.createElement('div'); row.className='tools-row';
      const playBtn = document.createElement('button'); playBtn.className='btn icon'; playBtn.innerHTML = '<i class="fa-solid fa-play"></i>'; playBtn.title='×§×¨×™×™× ×•×ª ×œ×¤×¡×§×”';
      const pauseBtn = document.createElement('button'); pauseBtn.className='btn icon'; pauseBtn.innerHTML = '<i class="fa-solid fa-pause"></i>'; pauseBtn.title='×”×¤×¡×§×”';
      const speedSlow = document.createElement('button'); speedSlow.className='btn'; speedSlow.textContent='××™×˜×™';
      const speedNorm = document.createElement('button'); speedNorm.className='btn'; speedNorm.textContent='×¨×’×™×œ';
      const speedFast = document.createElement('button'); speedFast.className='btn'; speedFast.textContent='××”×™×¨';

      let rate = 1.0;
      speedSlow.addEventListener('click', ()=>{ rate=0.85; ping('××”×™×¨×•×ª: ××™×˜×™') });
      speedNorm.addEventListener('click', ()=>{ rate=1.0; ping('××”×™×¨×•×ª: ×¨×’×™×œ') });
      speedFast.addEventListener('click', ()=>{ rate=1.25; ping('××”×™×¨×•×ª: ××”×™×¨') });

      let utter = null;
      playBtn.addEventListener('click', ()=>{
        if(window.speechSynthesis){
          if(utter) window.speechSynthesis.cancel();
          utter = new SpeechSynthesisUtterance(`${h.textContent}. ${p.textContent}`);
          utter.lang = 'he-IL'; utter.rate = rate;
          speechSynthesis.speak(utter);
        }
      });
      pauseBtn.addEventListener('click', ()=>{
        if(speechSynthesis.speaking) speechSynthesis.pause();
        else if(speechSynthesis.paused) speechSynthesis.resume();
      });

      row.append(playBtn, pauseBtn, speedSlow, speedNorm, speedFast);
      sec.appendChild(row);

      chaptersEl.appendChild(sec);
    });

    // ×©×™×ª×•×£ ×•×•×˜×¡××¤
    shareBtn.href = buildWhatsAppShareUrl(data);
  }

  // ===============================
  // ××¢×‘×¨ ××¡×›×™×
  // ===============================
  function switchTo(which){
    if(which==='book'){ generatorView.style.display='none'; bookView.style.display='grid'; }
    else { bookView.style.display='none'; generatorView.style.display='grid'; }
  }

  // ===============================
  // ×™×¦×™×¨×ª ×¡×™×¤×•×¨ (×›×¤×ª×•×¨)
  // ===============================
  generateBtn.addEventListener('click', async ()=>{
    const prompt = storyPrompt.value.trim() || '×“×¨×§×•×Ÿ ×‘×™×™×©×Ÿ ×©×¨×•×¦×” ×œ×”×›×™×Ÿ ×¢×•×’×ª ×©×•×§×•×œ×“ ×¢×œ ×”×™×¨×—';
    showLoading(true);
    await sleep(1300 + Math.random()*800);
    const story = generateStoryFromPrompt(prompt);
    saveState(story);
    renderBook(story);
    switchTo('book');
    showLoading(false);
    ping('×”×¡×™×¤×•×¨ ××•×›×Ÿ âœ¨');
  });

  newStoryBtn.addEventListener('click', ()=>{
    switchTo('generator');
    ping('×—×–×¨×” ×œ××—×•×œ×œ');
  });

  function showLoading(flag){
    loadingOverlay.style.display = flag ? 'block' : 'none';
  }
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

  // ===============================
  // ×©×™×ª×•×£ ×•×•×˜×¡××¤
  // ===============================
  function buildWhatsAppShareUrl(data){
    const t = `ğŸ“– "${data.title}" â€“ × ×•×¦×¨ ×‘××—×•×œ×œ ×”×¡×™×¤×•×¨×™× ×”×§×¡×•×!\n× ×¡×” ×’× ××ª×”/××ª: ××—×•×œ×œ ×¡×™×¤×•×¨×™× ×“×™×’×™×˜×œ×™×™× ×¢× ××™×•×¨×™× ×•×§×¨×™×™× ×•×ª.`;
    return `https://wa.me/?text=${encodeURIComponent(t)}`;
  }

  // ===============================
  // × ×’×Ÿ ×”×›×œ (TTS) + pause/resume
  // ===============================
  let allQueue = [];
  let allRate = 1.0;
  playAllBtn.addEventListener('click', ()=>{
    if(!window.speechSynthesis) return;
    if(speechSynthesis.speaking && !speechSynthesis.paused){ speechSynthesis.pause(); ping('×”×•×©×¢×”'); return; }
    if(speechSynthesis.paused){ speechSynthesis.resume(); ping('×”××©×š'); return; }

    const parts = [];
    parts.push(bookTitleEl.textContent);
    parts.push(bookSubtitleEl.textContent);
    chaptersEl.querySelectorAll('.chapter').forEach(ch=>{
      const h = ch.querySelector('h3')?.textContent || '';
      const p = ch.querySelector('p')?.textContent || '';
      parts.push(`${h}. ${p}`);
    });

    allQueue = parts;
    speechSynthesis.cancel();
    speakNextInQueue();
  });

  function speakNextInQueue(){
    if(allQueue.length===0) { ping('×”×¡×ª×™×™×'); return; }
    const text = allQueue.shift();
    const u = new SpeechSynthesisUtterance(text);
    u.lang='he-IL'; u.rate = allRate;
    u.onend = ()=> speakNextInQueue();
    speechSynthesis.speak(u);
  }

  // ===============================
  // ×™×¦×•× PDF
  // ×‘×¨×™×¨×ª ××—×“×œ: ×¤×ª×™×—×ª ×—×œ×•×Ÿ ×”×“×¤×¡×” (×©××™×¨×” ×œ-PDF). 
  // ×¢×•×’×Ÿ ×œ×©×™×œ×•×‘ jsPDF+html2canvas ××•×‘× ×™× â€“ ×¨××” ××§×˜×¢ ×”×¡×¤×¨×™×•×ª ×‘×”××©×š.
  // ===============================
  exportPdfBtn.addEventListener('click', async ()=>{
    // ×’×¨×¡×ª fallback: Print to PDF
    ping('×¤×•×ª×— ×”×“×¤×¡×”â€¦ ×‘×—×¨×• "×©××•×¨ ×›-PDF" ×œ×©××™×¨×”.');
    window.print();
  });

  // ===============================
  // Toast
  // ===============================
  const toast = document.getElementById('toast');
  let toastTimer = null;
  function ping(msg){
    clearTimeout(toastTimer);
    toast.innerHTML = `<div class="pill">${msg}</div>`;
    toastTimer = setTimeout(()=> toast.innerHTML='', 1800);
  }

  // ××™×§×•×“ ×‘×©×“×”
  storyPrompt.focus();

  // ===============================
  // ======  ×¡×¤×¨×™×•×ª ××•×˜××¢×•×ª (×¢×•×’× ×™×)  ======
  // ×›×“×™ ×œ×¢××•×“ ×‘××™×œ×•×¥ "×§×•×‘×¥ ×™×—×™×“ ×¢× ×¡×¤×¨×™×•×ª ×‘×§×•×“", ××¤×©×¨ ×œ×”×“×‘×™×§ ×›××Ÿ ××ª ×§×•×“ jsPDF ×•-html2canvas (minified).
  // ×œ××—×¨ ×”×”×“×‘×§×”, × ×™×ª×Ÿ ×œ×”×—×œ×™×£ ××ª fallback ×©×œ window.print() ×‘×™×¦×•× PDF ××™×›×•×ª×™:
  //
  //   1) ×”××¨×¦×¤×™× ××ª ××–×•×¨ ×”×¡×¤×¨ ×œ-canvas ×¢× html2canvas.
  //   2) ×××™×¨×™× ××ª ×”-canvas ×œ×ª××•× ×” (PNG/JPEG).
  //   3) ××©×‘×¦×™× ×œ××¡××š PDF ×—×“×© ×©×œ jsPDF, ×›×•×œ×œ ×¢××•×“ ×©×¢×¨ ××¢×•×¦×‘.
  //
  // ×“×•×’××ª ×©×™××•×© ××—×¨×™ ×”×”×˜××¢×”:
  //
  // async function exportWithLibs(){
  //   const bookNode = document.querySelector('#book-view');
  //   const canvas = await html2canvas(bookNode,{scale:2});
  //   const imgData = canvas.toDataURL('image/jpeg', 0.92);
  //   const pdf = new jspdf.jsPDF({orientation:'p', unit:'pt', format:'a4'});
  //   // ×¢××•×“ ×©×¢×¨:
  //   pdf.setFillColor(124,58,237);
  //   pdf.rect(0,0,595,842,'F');
  //   pdf.setTextColor(255,255,255);
  //   pdf.setFontSize(28);
  //   pdf.text(bookTitleEl.textContent, 40, 80);
  //   pdf.setFontSize(12);
  //   pdf.text(new Date().toLocaleString('he-IL'), 40, 110);
  //   // ×¢××•×“ ×ª×•×›×Ÿ:
  //   pdf.addPage();
  //   const pageW=595, pageH=842, margin=20;
  //   const imgW = pageW - margin*2;
  //   const imgH = canvas.height * imgW / canvas.width;
  //   pdf.addImage(imgData, 'JPEG', margin, margin, imgW, imgH);
  //   pdf.save(`${bookTitleEl.textContent}.pdf`);
  // }
  //
  // ×•××– ×œ×”×—×œ×™×£ ×‘-exportPdfBtn: exportWithLibs();
  //
  // ====== ××§×•××•×ª ×œ×”×“×‘×§×”: ======
  // /*** BEGIN html2canvas ***/
  // // ... html2canvas.min.js ...
  // /*** END html2canvas ***/
  //
  // /*** BEGIN jsPDF ***/
  // // ... jspdf.umd.min.js ...
  // /*** END jsPDF ***/

})();
</script>
</body>
</html>