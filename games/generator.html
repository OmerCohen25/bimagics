<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>××—×•×œ×œ ××ª×¨×™ HTML â€“ Chat â†’ App</title>
<style>
  :root { --bg:#0f1220; --panel:#151a2c; --accent:#7ee787; --muted:#9aa4bf; --text:#e6e9f2; --danger:#ff6b6b; }
  *{box-sizing:border-box} html,body{height:100%} body{margin:0;font-family:Inter,Segoe UI,Roboto,system-ui,sans-serif;background:linear-gradient(180deg,#0a0d1a,#0f1220);}
  header{display:flex;align-items:center;gap:12px;padding:12px 16px;background:#0c1022;border-bottom:1px solid #1f2740;position:sticky;top:0;z-index:3}
  header h1{font-size:16px;margin:0;color:var(--text);font-weight:600}
  header .tag{font-size:12px;color:#c7cff9;background:#1b2240;padding:4px 8px;border-radius:999px}
  header .sp{flex:1}
  header button, .btn{background:#1c2442;border:1px solid #2a3763;color:#dbe3ff;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
  header button:hover, .btn:hover{filter:brightness(1.1)}
  #app{display:grid;grid-template-columns: minmax(320px,520px) 1fr; gap:12px; height:calc(100% - 56px); padding:12px}
  @media (max-width: 960px){ #app{grid-template-columns:1fr; height:auto} #previewCard{height:60vh} }
  .card{background:var(--panel);border:1px solid #232b4a;border-radius:16px;overflow:hidden;display:flex;flex-direction:column;min-height:0}
  .card h2{margin:0;padding:12px 14px;border-bottom:1px solid #1f2740;color:#eaf0ff;font-size:14px}
  #chat{display:flex;flex-direction:column;height:100%}
  #log{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
  .msg{display:flex;gap:10px;align-items:flex-start}
  .msg .bubble{padding:10px 12px;border-radius:12px;max-width:100%;white-space:pre-wrap;word-wrap:anywhere;border:1px solid #283155}
  .me .bubble{background:#172044;color:#dbe3ff}
  .ai .bubble{background:#121833;color:#e6e9f2}
  .sys{font-size:12px;color:var(--muted);text-align:center;margin:6px 0}
  #composer{display:flex;gap:8px;padding:10px;border-top:1px solid #1f2740}
  #prompt{flex:1;min-height:48px;max-height:120px;resize:vertical;background:#0e1430;color:#e6e9f2;border:1px solid #2a3763;border-radius:12px;padding:10px}
  #send{min-width:120px;background:linear-gradient(90deg,#3bb273,#7ee787);color:#0b1020;border:none}
  #previewCard{position:relative}
  #iframe{flex:1;border:0;background:#fff;min-height:0}
  #tools{display:flex;gap:8px;padding:10px;border-top:1px solid #1f2740;flex-wrap:wrap}
  .pill{font-size:12px;color:#b7c3ff;background:#1b2240;padding:6px 10px;border-radius:999px;border:1px solid #2a3763}
  .label{color:#9aa4bf;font-size:12px;margin-left:6px}
  #modelSel{background:#0e1430;color:#e6e9f2;border:1px solid #2a3763;border-radius:10px;padding:6px 8px}
  .danger{background:#3a1420;border-color:#642a3a;color:#ffd4d4}
  .ok{color:#98f5b0}
  /* modal */
  dialog{background:#121833;color:#e6e9f2;border:1px solid #2a3664;border-radius:14px;width:min(560px,92%);padding:0}
  dialog::backdrop{background:rgba(2,6,20,.62)}
  .modal-h{padding:12px 14px;border-bottom:1px solid #1f2740;display:flex;justify-content:space-between;align-items:center}
  .modal-b{padding:14px;display:grid;gap:10px}
  input[type="password"], input[type="text"]{background:#0e1430;color:#e6e9f2;border:1px solid #2a3763;border-radius:10px;padding:10px}
  .help{font-size:12px;color:#9aa4bf}
  .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#16203c;color:#e6e9f2;border:1px solid #2a3763;padding:10px 14px;border-radius:12px;z-index:9;opacity:0;transition:opacity .2s, transform .2s}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}
  code, pre{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;font-size:12px}
  .loading-dots::after{content:"";display:inline-block;width:1ch;text-align:left;animation:dots 1.2s steps(4,end) infinite}
  @keyframes dots{0%{content:""}25%{content:"."}50%{content:".."}75%{content:"..."}}
</style>
</head>
<body>
  <header>
    <h1>××—×•×œ×œ ××ª×¨×™× ××”×¦â€™××˜</h1>
    <span class="tag">HTML ×‘×§×•×‘×¥ ××—×“</span>
    <div class="sp"></div>
    <select id="modelSel" title="Model">
      <option value="o4-mini" selected>o4-mini</option>
      <option value="gpt-4.1-mini">gpt-4.1-mini</option>
      <option value="gpt-4o-mini">gpt-4o-mini</option>
    </select>
    <button id="keyBtn">ğŸ”‘ ××¤×ª×— API</button>
  </header>

  <div id="app">
    <section class="card" id="chatCard">
      <h2>×¦â€™××˜</h2>
      <div id="chat">
        <div id="log"></div>
        <div class="sys">×”×§×œ×“/×™ ××” ×œ×‘× ×•×ª: â€œ×“×£ × ×—×™×ª×” ×œ×××¤×™×™×”â€ / â€œ××©×—×§ ×¨×× ×¨ ×¤×©×•×˜â€ / â€œ×“××©×‘×•×¨×“ ×ª×™×§ ×”×©×§×¢×•×ªâ€â€¦</div>
        <div id="composer">
          <textarea id="prompt" placeholder="××” ×‘×•× ×™×? ××¤×©×¨ ×‘×¢×‘×¨×™×ª. Shift+Enter ×œ×©×•×¨×” ×—×“×©×”"></textarea>
          <button id="send">×‘× ×” ××ª×¨</button>
        </div>
      </div>
    </section>

    <section class="card" id="previewCard">
      <h2>×ª×¦×•×’×” ×—×™×”</h2>
      <iframe id="iframe" title="×ª×¦×•×’×” ×—×™×”"></iframe>
      <div id="tools">
        <button class="btn" id="openNew">×¤×ª×— ×‘×˜××‘ ×—×“×©</button>
        <button class="btn" id="download">×”×•×¨×“ .html</button>
        <button class="btn" id="copyCode">×”×¢×ª×§ ×§×•×“</button>
        <span class="pill" id="status">××•×›×Ÿ</span>
        <span class="label">××¤×ª×—: <span id="keyState">×œ× ×”×•×–×Ÿ</span></span>
        <div class="sp"></div>
        <button class="btn danger" id="refineBtn" title="×ª×Ÿ ×©×“×¨×•×’ ×¢×œ ×”×ª×•×¦×¨ ×”× ×•×›×—×™">×©×¤×¨ ×ª×•×¦×¨</button>
        <button class="btn danger" id="resetBtn" title="××™×¤×•×¡ ×”×¦â€™××˜ ×‘×œ×‘×“">××¤×¡ ×¦â€™××˜</button>
      </div>
    </section>
  </div>

  <!-- API Key Modal -->
  <dialog id="keyModal">
    <div class="modal-h">
      <strong>×”×–× ×ª ××¤×ª×— OpenAI (× ×©××¨ ××§×•××™×ª)</strong>
      <button class="btn" id="closeKey">×¡×’×•×¨</button>
    </div>
    <div class="modal-b">
      <label>OpenAI API Key</label>
      <input id="apiKey" type="password" placeholder="sk-..." autocomplete="off"/>
      <div class="help">×”××¤×ª×— × ×©××¨ ×‘Ö¾localStorage ×©×œ ×”×“×¤×“×¤×Ÿ ×‘×œ×‘×“. ××•××œ×¥ ×‘×™×™×¦×•×¨ ×œ×¢×‘×•×“ ×“×¨×š ×¤×¨×•×§×¡×™ ×©×¨×ª ×•×œ× ×œ×”×¦×™×‘ ××¤×ª×— ×‘×“×¤×“×¤×Ÿ.</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn" id="saveKey">×©××•×¨</button>
        <button class="btn danger" id="clearKey">××—×§</button>
        <input id="peek" type="checkbox"/><label for="peek" class="label">×”×¦×’ ×ª×•×•×™×</label>
      </div>
    </div>
  </dialog>

  <div class="toast" id="toast"></div>

<script>
/** ====== Minimal â€œChat â†’ Appâ€ Frontend (no build, one file) ====== **/

const els = {
  log: document.getElementById('log'),
  prompt: document.getElementById('prompt'),
  send: document.getElementById('send'),
  iframe: document.getElementById('iframe'),
  download: document.getElementById('download'),
  copyCode: document.getElementById('copyCode'),
  openNew: document.getElementById('openNew'),
  status: document.getElementById('status'),
  keyBtn: document.getElementById('keyBtn'),
  keyModal: document.getElementById('keyModal'),
  closeKey: document.getElementById('closeKey'),
  apiKey: document.getElementById('apiKey'),
  saveKey: document.getElementById('saveKey'),
  clearKey: document.getElementById('clearKey'),
  peek: document.getElementById('peek'),
  keyState: document.getElementById('keyState'),
  resetBtn: document.getElementById('resetBtn'),
  refineBtn: document.getElementById('refineBtn'),
  modelSel: document.getElementById('modelSel'),
  toast: document.getElementById('toast'),
};

let appHTML = '<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>×ª×•×¦×¨ ×™×•×¤×™×¢ ×›××Ÿ</title><style>body{font-family:sans-serif;padding:24px}</style></head><body><h1>×¢×“×™×™×Ÿ ××™×Ÿ ×ª×•×¦×¨</h1><p>×¦×•×¨/×™ ××ª×¨ ×“×¨×š ×”×¦â€™××˜.</p></body></html>';
renderPreview(appHTML);

const SYS_PROMPT = `
××ª/×” ××—×•×œ×œ ××ª×¨×™× ×‘×§×•×‘×¥ ××—×“. ×”×¤×œ×˜ ×©×œ×š ×—×™×™×‘ ×œ×”×™×•×ª *××š ×•×¨×§* ×§×•×‘×¥ HTML ××—×“ ××•×©×œ× ×¢×:
- <!DOCTYPE html>, <html dir="rtl" lang="he">, <meta viewport>, <title>.
- CSS ×•-JavaScript ××•×˜××¢×™× <style> ×•-<script> ×œ×œ× ×§×‘×¦×™× ×—×™×¦×•× ×™×™×.
- ×¢×™×¦×•×‘ Mobile-first, RTL ××œ×, ×¤×•× ×˜×™× ××¢×¨×›×ª×™×™× ×‘×œ×‘×“.
- ××™×Ÿ ×§×™×©×•×¨×™× ×œ××©××‘×™× ×—×™×¦×•× ×™×™× (×œ×œ× CDN, ×œ×œ× ×ª××•× ×•×ª ×—×™×¦×•× ×™×•×ª). ×× ×™×© ×ª××•× ×•×ª â€“ ×œ×”×©×ª××© ×‘-data URL base64.
- ×× ××ª×‘×§×©×ª ××¤×œ×™×§×¦×™×” ××™× ×˜×¨××§×˜×™×‘×™×ª/××©×—×§ â€“ ×›×œ ×”×§×•×“ ×™×”×™×” ×‘×¤× ×™×, ×¢× ×˜×™×¤×•×œ ×‘××’×¢ ×•× ×™×™×“.
- ××™×›×•×ª ×’×‘×•×”×”, ×—×•×•×™×” ××¨×©×™××”, ×× ×™××¦×™×•×ª ×§×œ×•×ª ×•×©××™×¨×” ×¢×œ ×‘×™×¦×•×¢×™× ×˜×•×‘×™×.

××™×Ÿ ×œ×”×—×–×™×¨ ×”×¡×‘×¨×™×, ××™×Ÿ markdown, ××™×Ÿ ×‘×œ×•×§×™× ×©×œ ×§×•×“ â€“ ×¨×§ HTML ××œ× ×ª×§×™×Ÿ.
`.trim();

let messages = []; // chat log for the model (user content only; we enforce system each call)

/* ===== Utilities ===== */
function toast(msg){ els.toast.textContent = msg; els.toast.classList.add('show'); setTimeout(()=>els.toast.classList.remove('show'), 1800); }
function getKey(){ return localStorage.getItem('openai_key') || ''; }
function setKey(k){ localStorage.setItem('openai_key', k); }
function clearKey(){ localStorage.removeItem('openai_key'); }
function updateKeyState(){ els.keyState.textContent = getKey() ? '×”×•×–×Ÿ' : '×œ× ×”×•×–×Ÿ'; }
function renderPreview(html){ appHTML = html; els.iframe.srcdoc = html; }
function addMsg(role, text){
  const wrap = document.createElement('div'); wrap.className = `msg ${role==='user'?'me':'ai'}`;
  const bubble = document.createElement('div'); bubble.className = 'bubble'; bubble.textContent = text;
  wrap.appendChild(bubble); els.log.appendChild(wrap); els.log.scrollTop = els.log.scrollHeight;
  return bubble;
}
// Try to extract raw HTML from ```html fenced blocks if model returns markdown.
function extractHTML(raw){
  const codeFence = raw.match(/```html\s*([\s\S]*?)```/i) || raw.match(/```[\s\S]*?```/);
  if(codeFence){ return (codeFence[1]||'').trim(); }
  // If it starts with <!DOCTYPE or <html, accept as-is
  if(/<!doctype html>|<html[\s>]/i.test(raw)) return raw.trim();
  // Last resort: wrap inside minimal shell so preview won't be blank.
  return `<!doctype html><html lang="he" dir="rtl"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Generated</title></head><body><pre>${escapeHtml(raw)}</pre></body></html>`;
}
function escapeHtml(s){ return s.replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }

/* ===== OpenAI call (Responses API, streamed) ===== */
async function generateSite(prompt, refine=false){
  const apiKey = getKey();
  if(!apiKey){ els.keyModal.showModal(); toast('×™×© ×œ×”×–×™×Ÿ ××¤×ª×— API'); return; }
  const model = els.modelSel.value;
  els.status.textContent = '××™×™×¦×¨â€¦'; els.status.classList.add('loading-dots');

  const userMsg = refine
    ? `×©×¤×¨/×™ ××ª ×”××ª×¨ ×”×§×™×™× ×”×‘× (HTML ××œ× ×œ××—×¨×•× ×” ×‘×ª×—×ª×™×ª), ×‘×”×ª×× ×œ×‘×§×©×”: """${prompt}"""\n\n=== ×”×ª×•×¦×¨ ×”×§×•×“× ===\n${appHTML}`
    : prompt;

  messages.push({ role:'user', content: userMsg });

  const uiBubble = addMsg('assistant', 'â³ ××™×™×¦×¨ ××ª ×”××ª×¨â€¦');

  try{
    const res = await fetch('https://api.openai.com/v1/responses', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + apiKey,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model,
        stream: true,
        // Build "input" in Responses API style:
        input: [
          { role: 'system', content: [{ type:'text', text: SYS_PROMPT }] },
          ...messages.map(m => ({ role: m.role, content: [{ type:'text', text: m.content }] }))
        ]
      })
    });

    if(!res.ok){
      const txt = await res.text();
      throw new Error(`API ${res.status}: ${txt}`);
    }

    // Stream SSE
    const reader = res.body.getReader();
    const decoder = new TextDecoder('utf-8');
    let buffer = '', fullText = '';

    while(true){
      const {value, done} = await reader.read();
      if(done) break;
      buffer += decoder.decode(value, {stream:true});
      const parts = buffer.split('\n\n');
      buffer = parts.pop(); // keep last partial

      for(const chunk of parts){
        if(!chunk.startsWith('data:')) continue;
        const data = chunk.slice(5).trim();
        if(data === '[DONE]') continue;
        try{
          const json = JSON.parse(data);
          // Responses API stream chunk path: json.output_text
          const delta = json.output_text ?? '';
          if(delta){
            fullText += delta;
            uiBubble.textContent = fullText;
            els.log.scrollTop = els.log.scrollHeight;
          }
        }catch(e){ /* ignore JSON parse errors for keep-alives */ }
      }
    }

    const html = extractHTML(fullText);
    renderPreview(html);
    uiBubble.textContent = 'âœ… ×ª×•×¦×¨ ××•×›×Ÿ â€“ × ×˜×¢×Ÿ ×‘Ö¾Preview ×œ××˜×”.';
    els.status.textContent = '××•×›×Ÿ'; els.status.classList.remove('loading-dots');
  }catch(err){
    console.error(err);
    uiBubble.textContent = 'âŒ ×©×’×™××”: ' + err.message;
    els.status.textContent = '×©×’×™××”'; els.status.classList.remove('loading-dots');
  }
}

/* ===== Events ===== */
els.keyBtn.onclick = ()=> els.keyModal.showModal();
els.closeKey.onclick = ()=> els.keyModal.close();
els.saveKey.onclick = ()=>{ if(els.apiKey.value.trim()){ setKey(els.apiKey.value.trim()); updateKeyState(); els.keyModal.close(); toast('×”××¤×ª×— × ×©××¨ ×‘×“×¤×“×¤×Ÿ'); } };
els.clearKey.onclick = ()=>{ clearKey(); updateKeyState(); els.apiKey.value=''; toast('× ××—×§'); };
els.peek.onchange = ()=> els.apiKey.type = els.peek.checked ? 'text' : 'password';

els.send.onclick = ()=> {
  const q = els.prompt.value.trim();
  if(!q) return toast('××” ×‘×•× ×™×?');
  addMsg('user', q);
  els.prompt.value = '';
  generateSite(q, false);
};
els.prompt.addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); els.send.click(); }
});

els.refineBtn.onclick = ()=>{
  const q = prompt('××” ×œ×©×¤×¨ ×‘×ª×•×¦×¨ ×”× ×•×›×—×™? ×œ××©×œ: "×”×•×¡×£ ×× ×™××¦×™×”", "×ª××™×›×” ×‘××¦×‘ ×›×”×”", "×›×¤×ª×•×¨ ×©×™×ª×•×£".');
  if(!q) return;
  addMsg('user', '[Refine] ' + q);
  generateSite(q, true);
};

els.resetBtn.onclick = ()=>{
  messages = [];
  els.log.innerHTML = '';
  toast('×”×¦â€™××˜ ××•×¤×¡. ×”×ª×•×¦×¨ × ×©××¨.');
};

els.download.onclick = ()=>{
  const blob = new Blob([appHTML], {type:'text/html;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'generated-app.html';
  document.body.appendChild(a);
  a.click();
  a.remove();
};

els.copyCode.onclick = async ()=>{
  try{ await navigator.clipboard.writeText(appHTML); toast('×”×§×•×“ ×”×•×¢×ª×§'); }
  catch{ toast('×œ× ×”×¦×œ×™×— ×œ×”×¢×ª×™×§'); }
};

els.openNew.onclick = ()=>{
  const blob = new Blob([appHTML], {type:'text/html;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  window.open(url, '_blank');
};

updateKeyState();
// If no key yet â€“ prompt once on load
if(!getKey()){ setTimeout(()=>els.keyModal.showModal(), 300); }
</script>
</body>
</html>