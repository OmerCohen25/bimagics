<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <!-- חשוב: דפדפנים ניידים יכווצו את התוכן כשהמקלדת נפתחת -->
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, interactive-widget=resizes-content" />
  <title>נחשו את השם!</title>
  <meta name="theme-color" content="#6aaa64" />
  <style>
    :root{
      --correct-bg-color:#6aaa64;
      --present-bg-color:#c9b458;
      --absent-bg-color:#787c7e;
      --default-border-color:#d3d6da;
      --tile-text-color:#ffffff;
      --key-text-color:#000000;
      --bg-color:#ffffff;

      /* גובה אפליקציה דינמי – יתעדכן ב־JS עם visualViewport */
      --app-h: 100svh; /* עדיפות */
    }

    /* לא משתמשים ב-overflow:hidden כדי לא לחתוך מסכים */
    html, body { margin: 0; padding: 0; }
    body{
      min-height: var(--app-h);
      /* נפעיל גם נפילות חינניות: */
      min-height: 100svh;
      min-height: 100dvh;
      min-height: 100vh;
      background: var(--bg-color);
      color:#212121;
      font-family: Arial,"Helvetica Neue",Helvetica,sans-serif;
      display:flex;flex-direction:column;align-items:center;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      touch-action:manipulation;
      /* נאפשר גלילה במקרה של מסכים קצרים */
      overflow:auto;
    }

    #game-container{
      display:flex;flex-direction:column;align-items:center;justify-content:space-between;
      min-height: var(--app-h);
      min-height: 100%;
      width:100%;max-width:500px;padding:8px;box-sizing:border-box;
    }

    header{width:100%;text-align:center;border-bottom:1px solid var(--default-border-color);padding-bottom:10px;flex-shrink:0;transition:all .5s ease}
    h1{font-size:clamp(1.8rem,5vw,2.2rem);margin:0;padding:10px 0;color:#212121;transition:color .5s ease}
    header.header-win{padding:20px 0;border-bottom:none;border-radius:0 0 15px 15px;box-shadow:0 4px 6px rgba(0,0,0,.1);
      background-image:url('https://img.lovepik.com/png/20231010/Jasmine-flower-with-leaf-elements-white-flowers-real-flowers_159892_wh1200.png');
      background-size:cover;background-position:center 65%;background-repeat:no-repeat}
    header.header-win h1{font-size:clamp(2.2rem,6vw,2.8rem);color:#fff;text-shadow:0 2px 5px rgba(0,0,0,.8)}

    #board-container{display:flex;justify-content:center;align-items:center;flex-grow:1;width:100%;padding:10px 0;perspective:1000px}
    #board{display:grid;grid-template-rows:repeat(5,1fr);grid-gap:5px;width:clamp(280px,90vw,330px);height:clamp(300px,100vw,360px)}
    .row{display:grid;grid-template-columns:repeat(5,1fr);grid-gap:5px}
    .tile{position:relative;cursor:default;transform-style:preserve-3d;transition:transform .6s ease;will-change:transform}
    .tile.flip{transform:rotateX(180deg)}
    .tile-face{width:100%;height:100%;position:absolute;backface-visibility:hidden;display:inline-flex;justify-content:center;align-items:center;font-size:clamp(1.8rem,8vw,2.5rem);font-weight:bold;box-sizing:border-box;border-radius:4px}
    .tile-front{border:2px solid var(--default-border-color);background:#fff;color:#000}
    .tile.filled .tile-front{border-color:#878a8c;animation:pop .1s}
    .tile-back{transform:rotateX(180deg);color:var(--tile-text-color);border:2px solid transparent}
    .tile-back.correct{background:var(--correct-bg-color)}
    .tile-back.present{background:var(--present-bg-color)}
    .tile-back.absent{background:var(--absent-bg-color)}
    @keyframes pop{50%{transform:scale(1.08)}}
    .shake{animation:shake .5s}
    @keyframes shake{10%,90%{transform:translateX(-1px)}20%,80%{transform:translateX(2px)}30%,50%,70%{transform:translateX(-4px)}40%,60%{transform:translateX(4px)}}

    /* מקלדת: תמיד נראית; נדבקת לתחתית, עם שוליים לאזורי safe-area */
    #keyboard{
      width:100%;
      user-select:none;
      padding: 6px 6px max(env(safe-area-inset-bottom), 6px) 6px;
      background: linear-gradient(#f4f5f6,#e6e8ea);
      box-shadow: 0 -2px 8px rgba(0,0,0,.06);
      position: sticky;
      bottom: 0;
      z-index: 10;
      flex-shrink: 0;
    }
    .keyboard-row{display:flex;justify-content:center;margin:6px 0;direction:rtl}
    .key{
      font-family:inherit;font-weight:bold;border:0;padding:0 8px;height:56px;cursor:pointer;
      background:#d3d6da;color:var(--key-text-color);flex-grow:1;margin:0 3px;border-radius:8px;
      display:flex;justify-content:center;align-items:center;font-size:clamp(1rem,4.5vw,1.4rem);
      -webkit-tap-highlight-color:rgba(0,0,0,.2)
    }
    .key.large{flex-grow:1.6}
    .key:active{background:#c0c3c6}
    .key.correct{background:var(--correct-bg-color);color:var(--tile-text-color)}
    .key.present{background:var(--present-bg-color);color:var(--tile-text-color)}
    .key.absent{background:var(--absent-bg-color);color:var(--tile-text-color)}

    #toast-container{
      position:fixed;top:12%;left:50%;transform:translateX(-50%);
      background:rgba(0,0,0,.85);color:#fff;padding:12px 24px;border-radius:24px;font-size:1rem;z-index:1000;
      visibility:hidden;opacity:0;transition:visibility .5s,opacity .5s
    }
    #toast-container.show{visibility:visible;opacity:1}

    .modal-overlay{position:fixed;inset:0;background:rgba(255,255,255,.7);display:flex;justify-content:center;align-items:center;z-index:2000;visibility:hidden;opacity:0;transition:visibility .3s,opacity .3s ease}
    .modal-overlay.show{visibility:visible;opacity:1}
    .modal-content{background:var(--bg-color);padding:20px 30px;border-radius:8px;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,.2);transform:scale(.9);transition:transform .3s ease}
    .modal-overlay.show .modal-content{transform:scale(1)}
    .modal-content h2{margin-top:0}
    .modal-content p{margin-bottom:20px}
    .modal-content button{background:var(--correct-bg-color);color:#fff;border:none;padding:12px 24px;font-size:1.1rem;border-radius:4px;cursor:pointer}
  </style>
</head>
<body>
  <div id="game-container">
    <header><h1>נחש את השם</h1></header>
    <div id="board-container"><div id="board"></div></div>
    <div id="keyboard"></div>
  </div>

  <div id="toast-container"></div>

  <div id="modal-overlay" class="modal-overlay" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <h2 id="modal-title"></h2>
      <p id="modal-body"></p>
      <button id="modal-button">שחק שוב</button>
    </div>
  </div>

  <script>
  // התאמת גובה לכל דפדפן – גם כשמקלדת מערכת נפתחת
  (function setViewportHeight(){
    const apply = () => {
      const vh = window.visualViewport ? window.visualViewport.height : window.innerHeight;
      document.documentElement.style.setProperty('--app-h', vh + 'px');
    };
    apply();
    window.addEventListener('resize', apply);
    window.visualViewport && window.visualViewport.addEventListener('resize', apply);
  })();

  document.addEventListener('DOMContentLoaded', () => {
    const WORD_LENGTH = 5;
    const MAX_TRIES = 5;

    // לא חושפים על הפסד – מציגים רק אם ניצחון
    const encodedTargetWord = "15nXodee15nXnw=="; // החלף למילה שלך (Base64 UTF-8)
    const decodeBase64UTF8 = (b64) => {
      const bin = atob(b64);
      const bytes = Uint8Array.from([...bin].map(ch => ch.charCodeAt(0)));
      return new TextDecoder("utf-8").decode(bytes);
    };
    const targetWordRaw = decodeBase64UTF8(encodedTargetWord);

    const finalsMap = {"ך":"כ","ם":"מ","ן":"נ","ף":"פ","ץ":"צ","כ":"כ","מ":"מ","נ":"נ","פ":"פ","צ":"צ"};
    const normalizeLetter = (ch)=>finalsMap[ch]||ch;
    const normalizeWord   = (w)=>[...w].map(normalizeLetter).join("");

    const targetWordNorm = normalizeWord(targetWordRaw);
    const targetWord = targetWordRaw;

    const headerEl = document.querySelector('header');
    const boardEl = document.getElementById('board');
    const keyboardEl = document.getElementById('keyboard');
    const toastEl = document.getElementById('toast-container');
    const modalOverlayEl = document.getElementById('modal-overlay');
    const modalTitleEl = document.getElementById('modal-title');
    const modalBodyEl = document.getElementById('modal-body');
    const modalButtonEl = document.getElementById('modal-button');

    let currentRowIndex = 0;
    let currentTileIndex = 0;
    let isGameOver = false;
    let guessGrid = [];

    // פריסת מקלדת עברית קלאסית (RTL: ״פ״ בימין)
    const keys = [
      ['פ','ם','ן','ו','ט','א','ר','ק'],
      ['ף','ך','ל','ח','י','ע','כ','ג','ד','ש'],
      ['Backspace','ץ','ת','צ','מ','נ','ה','ב','ס','ז','Enter']
    ];

    const pairLetter = (ch)=>{
      const pairs={"כ":"ך","ך":"כ","מ":"ם","ם":"מ","נ":"ן","ן":"נ","פ":"ף","ף":"פ","צ":"ץ","ץ":"צ"};
      return pairs[ch]||ch;
    };

    function initializeGame(){
      isGameOver=false;currentRowIndex=0;currentTileIndex=0;
      guessGrid = Array(MAX_TRIES).fill(null).map(()=>Array(WORD_LENGTH).fill(''));

      headerEl.classList.remove('header-win');

      boardEl.innerHTML='';
      for(let i=0;i<MAX_TRIES;i++){
        const row=document.createElement('div');row.className='row';
        for(let j=0;j<WORD_LENGTH;j++){
          const tile=document.createElement('div');tile.className='tile';
          tile.innerHTML=`<div class="tile-face tile-front"></div><div class="tile-face tile-back"></div>`;
          row.appendChild(tile);
        }
        boardEl.appendChild(row);
      }

      keyboardEl.innerHTML='';
      keys.forEach(rowKeys=>{
        const rowDiv=document.createElement('div');rowDiv.className='keyboard-row';
        rowKeys.forEach(key=>{
          const keyButton=document.createElement('button');keyButton.className='key';keyButton.dataset.key=key;
          if(key==='Enter'){keyButton.textContent='אישור';keyButton.classList.add('large');}
          else if(key==='Backspace'){keyButton.innerHTML='&#9003;';keyButton.classList.add('large');keyButton.setAttribute('aria-label','מחיקה');}
          else{keyButton.textContent=key;}
          rowDiv.appendChild(keyButton);
        });
        keyboardEl.appendChild(rowDiv);
      });

      document.querySelectorAll('.key').forEach(k=>k.classList.remove('correct','present','absent'));
      modalOverlayEl.classList.remove('show');
      modalOverlayEl.setAttribute('aria-hidden','true');
    }

    function handleKeyPress(key){
      if(isGameOver) return;
      if(key==='Enter'){submitGuess();}
      else if(key==='Backspace'){deleteLetter();}
      else if(keys.flat().includes(key)){addLetter(key);}
    }

    function addLetter(letter){
      if(currentTileIndex<WORD_LENGTH){
        const tile=boardEl.children[currentRowIndex].children[currentTileIndex];
        const front=tile.querySelector('.tile-front');
        front.textContent=letter;
        tile.classList.add('filled');
        guessGrid[currentRowIndex][currentTileIndex]=letter;
        currentTileIndex++;
      }
    }

    function deleteLetter(){
      if(currentTileIndex>0){
        currentTileIndex--;
        const tile=boardEl.children[currentRowIndex].children[currentTileIndex];
        const front=tile.querySelector('.tile-front');
        front.textContent='';
        tile.classList.remove('filled');
        guessGrid[currentRowIndex][currentTileIndex]='';
      }
    }

    function submitGuess(){
      if(currentTileIndex!==WORD_LENGTH){showToast('לא מספיק אותיות');shakeRow();return;}
      const currentGuess=guessGrid[currentRowIndex].join('');
      processFlip(currentGuess);
    }

    function processFlip(guess){
      const rowTiles=boardEl.children[currentRowIndex].children;
      const guessLetters=[...guess];
      const guessLettersNorm=[...normalizeWord(guess)];
      const targetLettersNorm=[...targetWordNorm];

      const letterCounts=targetLettersNorm.reduce((acc,l)=>(acc[l]=(acc[l]||0)+1,acc),{});
      const states=Array(WORD_LENGTH).fill(null);

      guessLettersNorm.forEach((l,i)=>{
        if(targetLettersNorm[i]===l){states[i]='correct';letterCounts[l]--;}
      });
      guessLettersNorm.forEach((l,i)=>{
        if(states[i])return;
        if((letterCounts[l]||0)>0){states[i]='present';letterCounts[l]--;}
        else{states[i]='absent';}
      });

      Array.from(rowTiles).forEach((tile,idx)=>{
        setTimeout(()=>{
          const front=tile.querySelector('.tile-front');
          const back =tile.querySelector('.tile-back');
          back.textContent=front.textContent;
          back.classList.add(states[idx]);
          tile.classList.add('flip');
          updateKeyboard(guessLetters[idx],states[idx]);
        },idx*350);
      });

      setTimeout(()=>checkGameOver(guess,states),WORD_LENGTH*350+20);
    }

    function updateKeyboard(letter,state){
      const twin=pairLetter(letter);
      [letter,twin].forEach(ch=>{
        const key=document.querySelector(`.key[data-key='${CSS.escape(ch)}']`);
        if(!key) return;
        const isCorrect=key.classList.contains('correct');
        const isPresent=key.classList.contains('present');
        if(state==='correct'){key.classList.remove('present','absent');key.classList.add('correct');}
        else if(state==='present'&&!isCorrect){key.classList.remove('absent');key.classList.add('present');}
        else if(state==='absent'&&!isCorrect&&!isPresent){key.classList.add('absent');}
      });
    }

    function checkGameOver(guess){
      if(normalizeWord(guess)===targetWordNorm){
        showToast('כל הכבוד! הצלחת!',2000);
        isGameOver=true;
        setTimeout(()=>showResultModal(true),700);
      }else{
        currentRowIndex++;currentTileIndex=0;
        if(currentRowIndex>=MAX_TRIES){
          isGameOver=true;
          setTimeout(()=>showResultModal(false),400);
        }
      }
    }

    function showResultModal(isWin){
      if(isWin){
        headerEl.classList.add('header-win');
        modalTitleEl.textContent='ניצחת! 🏆';
        modalBodyEl.textContent=`כל הכבוד! השם הוא: ${targetWord}`;
      }else{
        modalTitleEl.textContent='כמעט!';
        modalBodyEl.textContent='לא נורא, תמיד אפשר לנסות שוב! לחצו "שחק שוב" וקדימה לסיבוב נוסף ✨';
      }
      modalOverlayEl.classList.add('show');
      modalOverlayEl.setAttribute('aria-hidden','false');
    }

    function shakeRow(){
      const row=boardEl.children[currentRowIndex];
      row.classList.add('shake');
      row.addEventListener('animationend',()=>row.classList.remove('shake'),{once:true});
    }

    function showToast(message,duration=1200){
      toastEl.textContent=message;toastEl.classList.add('show');
      setTimeout(()=>toastEl.classList.remove('show'),duration);
    }

    keyboardEl.addEventListener('click',(e)=>{
      const btn=e.target.closest('button.key'); if(!btn) return;
      handleKeyPress(btn.dataset.key);
    });
    document.addEventListener('keydown',(e)=>{
      let k=e.key;
      if(k==='Enter') handleKeyPress('Enter');
      else if(k==='Backspace') handleKeyPress('Backspace');
      else if(keys.flat().includes(k)) handleKeyPress(k);
    });

    modalButtonEl.addEventListener('click',initializeGame);

    initializeGame();
  });
  </script>
</body>
</html>
