<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>住专 住专 专转</title>
    <!-- 注转 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 注转 驻 Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 砖砖 驻 Rubik 注专 注专转 -Inter 专专转  */
        body {
            font-family: 'Rubik', 'Inter', sans-serif;
        }
        /* 转转 拽转 -RTL */
        label {
            display: block;
            text-align: right;
        }
        textarea {
            resize: vertical;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">住专 住专 专转</h1>
            <p class="text-lg text-gray-600 mt-2">转 爪转 驻爪 专砖转</p>
        </header>

        <!-- 砖 1: 专转 住住 -->
        <div id="setupSection" class="bg-white p-6 rounded-lg shadow-lg max-w-lg mx-auto">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">专转 住住</h2>
            <div class="space-y-4">
                <div>
                    <label for="totalSeatsInput" class="block text-sm font-medium text-gray-700 mb-1">住" 拽转 专:</label>
                    <input type="number" id="totalSeatsInput" value="19" min="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="votesPerVoterDisplay" class="block text-sm font-medium text-gray-700 mb-1">住驻专 住  爪注 (2/3 住", 注 ):</label>
                    <input type="number" id="votesPerVoterDisplay" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100">
                </div>
                <button id="startAppBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150 ease-in-out shadow-md">
                    转 住爪
                </button>
            </div>
        </div>

        <!-- 砖 2: 驻拽爪 专砖转 (住转专 转) -->
        <div id="mainAppSection" class="hidden">
            <!-- 转 住 砖 专转 () -->
            <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-4 rounded-lg mb-8 shadow-md" role="alert">
                <h3 class="font-bold text-xl mb-2">转 住 (拽注)</h3>
                <div class="flex flex-wrap justify-around text-center">
                    <div class="p-2">
                        <span id="totalSeatsDisplay" class="block text-3xl font-bold">19</span>
                        <span class="text-sm">拽转 专</span>
                    </div>
                    <div class="p-2">
                        <span id="votesPerVoterDisplayBox" class="block text-3xl font-bold">12</span>
                        <span class="text-sm">专转 (住)  爪注</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

                <!-- 专住 1: 驻爪 ( 爪专?) -->
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold text-blue-700 mb-6 border-b pb-3">
                        <span class="inline-block mr-2"></span>
                        驻爪:  拽转 爪专  爪?
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label for="ourCandidatesToWin" class="block text-sm font-medium text-gray-700 mb-1"> 注 *砖*  专爪 住?</label>
                            <input type="number" id="ourCandidatesToWin" value="16" min="12" max="19" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                         <div>
                            <label for="ourCandidateNamesOpt" class="block text-sm font-medium text-gray-700 mb-1">专砖转 注 *砖* (  砖专):</label>
                            <textarea id="ourCandidateNamesOpt" rows="8" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        <div>
                            <label for="oppVotersOpt" class="block text-sm font-medium text-gray-700 mb-1"> 爪注 砖 *专*?</label>
                            <input type="number" id="oppVotersOpt" value="80" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="oppCandidatesOpt" class="block text-sm font-medium text-gray-700 mb-1"> 注 *专* 专抓 专砖 砖?</label>
                            <input type="number" id="oppCandidatesOpt" value="12" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <button id="calculateMinVoters" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150 ease-in-out shadow-md">
                            砖   爪注  爪专
                        </button>
                    </div>
                    <div id="minVotersResult" class="mt-6 p-4 bg-gray-50 rounded-lg hidden">
                        <!-- 转爪 转爪  -->
                    </div>
                </div>

                <!-- 专住 2: 住专 ( 拽专 ?) -->
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold text-green-700 mb-6 border-b pb-3">
                        <span class="inline-block mr-2"></span>
                        住专:  拽专 ...
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label for="ourVotersSim" class="block text-sm font-medium text-gray-700 mb-1"> 爪注 砖 **?</label>
                            <input type="number" id="ourVotersSim" value="108" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        </div>
                         <div>
                            <label for="ourCandidatesSim" class="block text-sm font-medium text-gray-700 mb-1"> 注 *砖*  专爪?</label>
                            <input type="number" id="ourCandidatesSim" value="16" min="12" max="19" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        </div>
                         <div>
                            <label for="ourCandidateNamesSim" class="block text-sm font-medium text-gray-700 mb-1">专砖转 注 *砖* (  砖专):</label>
                            <textarea id="ourCandidateNamesSim" rows="8" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></textarea>
                        </div>
                        <div>
                            <label for="oppVotersSim" class="block text-sm font-medium text-gray-700 mb-1"> 爪注 砖 *专*?</label>
                            <input type="number" id="oppVotersSim" value="80" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        </div>
                        <div>
                            <label for="oppCandidatesSim" class="block text-sm font-medium text-gray-700 mb-1"> 注 *专* 专抓?</label>
                            <input type="number" id="oppCandidatesSim" value="12" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        </div>
                        <button id="runSimulation" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150 ease-in-out shadow-md">
                            专抓 住爪
                        </button>
                    </div>
                    <div id="simulationResult" class="mt-6 p-4 bg-gray-50 rounded-lg hidden">
                        <!-- 转爪 转爪  -->
                    </div>
                </div>
            </div>

            <!-- 专 转爪转 驻专: 爪转 驻爪 专砖转 -->
            <div id="listRecommendation" class="mt-8 bg-white p-6 rounded-lg shadow-lg hidden">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">
                    <span class="inline-block mr-2"></span>
                    爪 住专转: 驻爪 专砖转 砖 (住)
                </h3>
                <p class="text-gray-600 mb-4"> 砖 驻专 拽转 驻 住 转  注 砖, 注 拽 转 爪注 砖 拽爪转 ("专砖转 砖"  "住").  拽爪 拽转 专砖转 爪注 砖.</p>
                <div id="listRecommendationContent" class="space-y-4">
                    <!-- 转 爪 住  -->
                </div>
            </div>
            
            <!-- 专 转爪转 驻专:  注 -->
            <div id="fullResults" class="mt-8 bg-white p-6 rounded-lg shadow-lg hidden">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">
                    <span class="inline-block mr-2"></span>
                    驻专 转爪转 
                </h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">专</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">注</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">住 拽转</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">住住</th>
                            </tr>
                        </thead>
                        <tbody id="fullResultsBody" class="bg-white divide-y divide-gray-200">
                            <!-- 砖专转 转爪转 住  -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- 拽注 ---
        let TOTAL_SEATS = 19;
        let VOTES_PER_VOTER = 12;

        // --- 专 DOM ---
        // 砖 1: 专转
        const setupSection = document.getElementById('setupSection');
        const mainAppSection = document.getElementById('mainAppSection');
        const totalSeatsInput = document.getElementById('totalSeatsInput');
        const votesPerVoterDisplay = document.getElementById('votesPerVoterDisplay');
        const startAppBtn = document.getElementById('startAppBtn');
        
        // 砖 2: 驻拽爪
        const totalSeatsDisplay = document.getElementById('totalSeatsDisplay');
        const votesPerVoterDisplayBox = document.getElementById('votesPerVoterDisplayBox');
        
        const calculateMinVotersBtn = document.getElementById('calculateMinVoters');
        const runSimulationBtn = document.getElementById('runSimulation');
        
        const minVotersResultEl = document.getElementById('minVotersResult');
        const simulationResultEl = document.getElementById('simulationResult');
        const listRecommendationEl = document.getElementById('listRecommendation');
        const listRecommendationContentEl = document.getElementById('listRecommendationContent');
        const fullResultsEl = document.getElementById('fullResults');
        const fullResultsBodyEl = document.getElementById('fullResultsBody');
        
        // --- 砖转 拽 ---
        const ourCandidatesToWinInput = document.getElementById('ourCandidatesToWin');
        const ourCandidateNamesOptTextarea = document.getElementById('ourCandidateNamesOpt');
        const ourCandidatesSimInput = document.getElementById('ourCandidatesSim');
        const ourCandidateNamesSimTextarea = document.getElementById('ourCandidateNamesSim');

        // --- 专注 ---
        // 砖 1
        totalSeatsInput.addEventListener('input', updateVotesPerVoter);
        startAppBtn.addEventListener('click', startApplication);
        
        // 砖 2
        calculateMinVotersBtn.addEventListener('click', handleCalculateMinVoters);
        runSimulationBtn.addEventListener('click', handleRunSimulation);
        
        ourCandidatesToWinInput.addEventListener('input', () => syncInputs('numToText', 'Opt'));
        ourCandidateNamesOptTextarea.addEventListener('input', () => syncInputs('textToNum', 'Opt'));
        
        ourCandidatesSimInput.addEventListener('input', () => syncInputs('numToText', 'Sim'));
        ourCandidateNamesSimTextarea.addEventListener('input', () => syncInputs('textToNum', 'Sim'));
        
        // --- 转 ---
        function initializeSetupScreen() {
            // 转 专砖 - 拽注 转 住驻专 注 -16 爪专 砖转 专专转 
            updateVotesPerVoter();
        }
        
        function updateVotesPerVoter() {
            const seats = parseInt(totalSeatsInput.value) || 0;
            const votes = Math.floor(seats * (2 / 3));
            votesPerVoterDisplay.value = votes;
        }
        
        function startApplication() {
            // 1. 拽注 转 砖转 
            TOTAL_SEATS = parseInt(totalSeatsInput.value);
            VOTES_PER_VOTER = parseInt(votesPerVoterDisplay.value);
            
            if (isNaN(TOTAL_SEATS) || isNaN(VOTES_PER_VOTER) || TOTAL_SEATS < 3 || VOTES_PER_VOTER < 1) {
                alert("注专  拽.   住驻专 拽 砖 拽转.");
                return;
            }
            
            // 2. 注 转 转爪 砖 转 住
            totalSeatsDisplay.textContent = TOTAL_SEATS;
            votesPerVoterDisplayBox.textContent = VOTES_PER_VOTER;
            
            // 3. 转 转 砖转 驻拽爪
            initializeAppInputs();
            
            // 4. 祝  住
            setupSection.classList.add('hidden');
            mainAppSection.classList.remove('hidden');
        }
        
        /**
         * 转 转 注专 专专转  砖 驻拽爪 专砖转
         */
        function initializeAppInputs() {
            // 注 转 转 注专 砖 砖转 专转 注
            const minCandidates = VOTES_PER_VOTER;
            const maxCandidates = TOTAL_SEATS;
            const defaultCandidates = Math.min(Math.max(16, minCandidates), maxCandidates); // 住 16,   砖 转

            ourCandidatesToWinInput.min = minCandidates;
            ourCandidatesToWinInput.max = maxCandidates;
            ourCandidatesToWinInput.value = defaultCandidates;
            
            ourCandidatesSimInput.min = minCandidates;
            ourCandidatesSimInput.max = maxCandidates;
            ourCandidatesSimInput.value = defaultCandidates;
            
            // 注 转 砖转 砖转
            syncInputs('numToText', 'Opt');
            syncInputs('numToText', 'Sim');
        }
        
        /**
         * 住专  砖 住驻专 注 转转 拽住 砖 砖转
         */
        function syncInputs(direction, type) {
            const numInput = (type === 'Opt') ? ourCandidatesToWinInput : ourCandidatesSimInput;
            const textarea = (type === 'Opt') ? ourCandidateNamesOptTextarea : ourCandidateNamesSimTextarea;
            
            const minCandidates = VOTES_PER_VOTER; // 拽专: 砖转砖 砖转 
            const maxCandidates = TOTAL_SEATS; // 拽专: 砖转砖 砖转 

            if (direction === 'numToText') {
                let count = parseInt(numInput.value);
                
                // 爪 住驻专 注
                if (isNaN(count) || count < minCandidates) {
                    count = minCandidates;
                    numInput.value = minCandidates;
                } else if (count > maxCandidates) {
                    count = maxCandidates;
                    numInput.value = maxCandidates;
                }
                
                const existingNames = textarea.value.split('\n').filter(Boolean);
                const newNames = [];
                
                for (let i = 0; i < count; i++) {
                    newNames.push(existingNames[i] || `注 ${i + 1}`);
                }
                textarea.value = newNames.join('\n');
                
            } else if (direction === 'textToNum') {
                const names = textarea.value.split('\n').filter(Boolean);
                let count = names.length;
                
                 if (count < minCandidates) {
                    if (count === 0) numInput.value = minCandidates; 
                    else numInput.value = count; 

                } else if (count > maxCandidates) {
                    textarea.value = names.slice(0, maxCandidates).join('\n');
                    numInput.value = maxCandidates;
                } else {
                    numInput.value = count;
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', initializeSetupScreen);

        // --- 驻拽爪转  ---

        /**
         * 驻拽爪转 : 砖转 转 驻爪 拽转 驻
         */
        function calculateOptimalSplit(K, V, N, names) {
            // K = our candidates, V = votes per voter, N = our voters
            if (K <= 0 || V <= 0 || N <= 0) {
                 return { lists: [], candidateVotes: [] };
            }
            
            //  K (注) 拽  砖 -V (爪注转),  爪专 驻爪.
            if (K <= V) {
                const candidateVotes = Array(K).fill(0).map((_, i) => ({
                    id: (names && names[i]) ? names[i] : `砖-${i + 1}`,
                    votes: N,
                    type: 'our'
                }));
                const lists = [{
                    voters: N,
                    omits: [],
                    includes: Array.from({ length: K }, (_, i) => i + 1)
                }];
                return { lists, candidateVotes };
            }

            const omitCount = K - V; //  注 ** 住  专砖
            const numLists = Math.ceil(K / omitCount); // 住驻专 专砖转 (住) 专砖

            const lists = [];
            const candidateVotes = Array(K).fill(0).map((_, i) => ({
                id: (names && names[i]) ? names[i] : `砖-${i + 1}`,
                votes: 0,
                type: 'our'
            }));

            // 1. 拽 转 爪注 砖  专砖转 爪专 砖  转
            const baseVotersPerList = Math.floor(N / numLists);
            let remainderVoters = N % numLists;
            
            const voterDistribution = [];
            for (let i = 0; i < numLists; i++) {
                let votersForThisList = baseVotersPerList + (i < remainderVoters ? 1 : 0);
                voterDistribution.push(votersForThisList);
            }

            // 2. 爪专 转 专砖转 (住)
            let candidateOmitIndex = 0;
            for (let i = 0; i < numLists; i++) {
                const voters = voterDistribution[i];
                const omits = []; // 注 砖 (拽住 0-based)
                const includes = []; // 注  (拽住 1-based)

                for (let j = 0; j < omitCount; j++) {
                    if (candidateOmitIndex < K) {
                        omits.push(candidateOmitIndex);
                        candidateOmitIndex++;
                    }
                }
                
                // 3. 砖 拽转:  注 拽 拽转  专砖 *砖* 砖 转
                for (let c = 0; c < K; c++) {
                    if (!omits.includes(c)) {
                        candidateVotes[c].votes += voters;
                        includes.push(c + 1); // 住祝 转 住驻专 住专 (1-based)
                    }
                }
                
                lists.push({
                    voters: voters,
                    omits: omits.map(idx => idx + 1), // 专 拽住 1 (1-based)
                    includes: includes
                });
            }

            return { lists, candidateVotes };
        }

        /**
         * 专抓 转 住爪 
         */
        function runFullSimulation(ourVoters, ourCandidates, oppVoters, oppCandidates, ourNames) {
            // 1. 砖 拽转 专
            const oppSplit = calculateOptimalSplit(oppCandidates, VOTES_PER_VOTER, oppVoters); // 砖转砖 -VOTES_PER_VOTER 
            const oppResults = oppSplit.candidateVotes.map(c => ({
                ...c,
                id: `专-${c.id.split('-')[1]}`,
                type: 'opp'
            }));

            // 2. 砖 拽转 砖 (注 驻爪 驻)
            const ourSplit = calculateOptimalSplit(ourCandidates, VOTES_PER_VOTER, ourVoters, ourNames); // 砖转砖 -VOTES_PER_VOTER 
            const ourResults = ourSplit.candidateVotes;

            // 3.  专
            const allCandidates = [...ourResults, ...oppResults];
            allCandidates.sort((a, b) => b.votes - a.votes);

            // 4. 拽转 拽转
            const winners = [];
            const losers = [];
            
            allCandidates.forEach((candidate, index) => {
                const rank = index + 1;
                const status = rank <= TOTAL_SEATS ? '专' : ' 专'; // 砖转砖 -TOTAL_SEATS 
                const result = { ...candidate, rank, status };
                
                if (status === '专') {
                    winners.push(result);
                } else {
                    losers.push(result);
                }
            });

            const ourWins = winners.filter(c => c.type === 'our').length;
            const oppWins = winners.filter(c => c.type === 'opp').length;
            
            const threshold = winners.length > 0 ? winners[Math.min(winners.length - 1, TOTAL_SEATS - 1)].votes : 0;
            const minOurVotes = ourResults.length > 0 ? Math.min(...ourResults.map(c => c.votes)) : 0;
            const maxOurVotes = ourResults.length > 0 ? Math.max(...ourResults.map(c => c.votes)) : 0;
            const minOppVotes = oppResults.length > 0 ? Math.min(...oppResults.map(c => c.votes)) : 0;
            const maxOppVotes = oppResults.length > 0 ? Math.max(...oppResults.map(c => c.votes)) : 0;

            return {
                ourWins,
                oppWins,
                threshold,
                minOurVotes,
                maxOurVotes,
                minOppVotes,
                maxOppVotes,
                listRecommendation: { lists: ourSplit.lists, names: ourNames },
                fullResults: [...winners, ...losers]
            };
        }


        // --- 驻 专注 (Handlers) ---

        /**
         * 驻 爪 注 "砖   爪注  爪专" (驻爪)
         */
        function handleCalculateMinVoters() {
            // 1. 住祝 拽
            const ourNames = ourCandidateNamesOptTextarea.value.split('\n').filter(Boolean);
            const ourCandidatesToWin = ourNames.length;
            
            // 爪 驻 专爪
            if (ourCandidatesToWin < VOTES_PER_VOTER || ourCandidatesToWin > TOTAL_SEATS) {
                alert(`住驻专 注  转  ${VOTES_PER_VOTER} -${TOTAL_SEATS}.  转拽 转 专砖.`);
                return;
            }
            ourCandidatesToWinInput.value = ourCandidatesToWin; //  住专 专
            
            const oppVoters = parseInt(document.getElementById('oppVotersOpt').value);
            const oppCandidates = parseInt(document.getElementById('oppCandidatesOpt').value);

            if (ourCandidatesToWin === 0) {
                 alert("  驻转 砖 注 .");
                return;
            }
            if (isNaN(oppVoters) || isNaN(oppCandidates)) {
                alert("  转  砖转 注专 住驻专.");
                return;
            }
            
            if (ourCandidatesToWin > TOTAL_SEATS) {
                alert(` 转 住 ${ourCandidatesToWin} 注, 砖 专拽 ${TOTAL_SEATS} 拽转.`);
                return;
            }

            // 2. 砖 拽转 专
            const oppSplit = calculateOptimalSplit(oppCandidates, VOTES_PER_VOTER, oppVoters);
            const oppMinVotes = oppSplit.candidateVotes.length > 0 ? Math.min(...oppSplit.candidateVotes.map(c => c.votes)) : 0;
            
            const targetVotes = oppMinVotes + 1;

            // 3. 砖 转专
            let totalVotesNeeded = targetVotes * ourCandidatesToWin;
            let minVoters = Math.ceil(totalVotesNeeded / VOTES_PER_VOTER);

            // 4. 爪
            let simulationResult;
            let actualMinOurVotes;
            
            while (true) {
                simulationResult = runFullSimulation(minVoters, ourCandidatesToWin, oppVoters, oppCandidates, ourNames);
                actualMinOurVotes = simulationResult.minOurVotes;
                
                if (actualMinOurVotes > oppMinVotes && simulationResult.ourWins === ourCandidatesToWin) {
                     break; // 爪 
                }
                
                minVoters++;
                
                if (minVoters > (oppVoters * 20) + 50) {
                    minVotersResultEl.innerHTML = `<p class="text-red-600 font-bold">砖 砖. 转 砖转  驻砖专 爪 (砖, 专 拽 ).</p>`;
                    minVotersResultEl.classList.remove('hidden');
                    return;
                }
            }

            // 5. 爪转 转爪转
            minVotersResultEl.innerHTML = `
                <p class="text-lg mb-2">
                      住 砖 <strong>${ourCandidatesToWin} 注</strong> ( 专 注 ${oppVoters} 拽转):
                </p>
                <p class="text-4xl font-bold text-blue-700 text-center my-4">${minVoters}</p>
                <p class="text-lg text-center mb-4">爪注 (驻转)</p>
                <hr class="my-3">
                <h4 class="font-bold">转 (爪 ):</h4>
                <ul class="list-disc list-inside text-sm text-gray-700 space-y-1 mt-2">
                    <li> 注 砖 专 拽 -<strong>${oppMinVotes}</strong> 拽转.</li>
                    <li>注 砖  <strong>${targetVotes}</strong> 拽转  注 砖.</li>
                    <li>注 <strong>${minVoters}</strong> 爪注 驻爪 ,  注 砖 拽  <strong>${simulationResult.minOurVotes}</strong> -<strong>${simulationResult.maxOurVotes}</strong> 拽转.</li>
                    <li><strong>转爪 住驻转: <span class="text-blue-700 font-bold">${simulationResult.ourWins} 拽转 </span>  <span class="text-red-700 font-bold">${simulationResult.oppWins} 拽转 专</span>.</strong></li>
                    <li>住祝 住 (拽 砖 拽 -${TOTAL_SEATS})  <strong>${simulationResult.threshold}</strong> 拽转.</li>
                </ul>
            `;
            minVotersResultEl.classList.remove('hidden');
            
            displayListRecommendation(simulationResult.listRecommendation.lists, minVoters, simulationResult.listRecommendation.names);
            fullResultsEl.classList.add('hidden');
        }
        
        /**
         * 驻 爪 注 "专抓 住爪"
         */
        function handleRunSimulation() {
            // 1. 住祝 拽
            const ourNames = ourCandidateNamesSimTextarea.value.split('\n').filter(Boolean);
            const ourCandidates = ourNames.length;
            
            // 爪 驻 专爪
             if (ourCandidates < VOTES_PER_VOTER || ourCandidates > TOTAL_SEATS) {
                alert(`住驻专 注  转  ${VOTES_PER_VOTER} -${TOTAL_SEATS}.  转拽 转 专砖.`);
                return;
            }
            ourCandidatesSimInput.value = ourCandidates; //  住专 专
            
            const ourVoters = parseInt(document.getElementById('ourVotersSim').value);
            const oppVoters = parseInt(document.getElementById('oppVotersSim').value);
            const oppCandidates = parseInt(document.getElementById('oppCandidatesSim').value);
            
            if (ourCandidates === 0) {
                 alert("  驻转 砖 注 .");
                return;
            }
            if (isNaN(ourVoters) || isNaN(oppVoters) || isNaN(oppCandidates)) {
                alert("  转  砖转 注专 住驻专.");
                return;
            }

            // 2. 专爪转 住爪
            const result = runFullSimulation(ourVoters, ourCandidates, oppVoters, oppCandidates, ourNames);

            // 3. 爪转 转爪转
            simulationResultEl.innerHTML = `
                <p class="text-lg mb-2">
                    转 <strong>${ourVoters}</strong> 爪注 砖 -<strong>${oppVoters}</strong> 专:
                </p>
                <div class="text-center my-4">
                    <span class="text-4xl font-bold text-green-700">${result.ourWins}</span>
                    <span class="text-3xl text-gray-600 mx-2">/</span>
                    <span class="text-4xl font-bold text-red-700">${result.oppWins}</span>
                    <br>
                    <span class="text-sm text-green-700 font-medium">拽转 </span>
                    <span class="text-sm text-gray-500 mx-4">转 ${TOTAL_SEATS}</span>
                    <span class="text-sm text-red-700 font-medium">拽转 专</span>
                </div>
                <hr class="my-3">
                <h4 class="font-bold">转 (爪 ):</h4>
                <ul class="list-disc list-inside text-sm text-gray-700 space-y-1 mt-2">
                    <li>注 砖 拽  <strong>${result.minOurVotes}</strong> -<strong>${result.maxOurVotes}</strong> 拽转 (注 驻爪 驻).</li>
                    <li>注 砖 专 拽  <strong>${result.minOppVotes}</strong> -<strong>${result.maxOppVotes}</strong> 拽转.</li>
                    <li>住祝 住 (拽 砖 拽 -${TOTAL_SEATS})  <strong>${result.threshold}</strong> 拽转.</li>
                </ul>
            `;
            simulationResultEl.classList.remove('hidden');

            // 4. 爪转 爪转 驻爪 转爪转 转
            displayListRecommendation(result.listRecommendation.lists, ourVoters, result.listRecommendation.names);
            displayFullResults(result.fullResults);
        }
        
        
        // --- 驻拽爪转 转爪 ---

        /**
         * 爪 转 爪 驻爪 专砖转
         */
        function displayListRecommendation(lists, totalVoters, names) {
            if (!lists || lists.length === 0 || (lists.length === 1 && lists[0].omits.length === 0)) {
                listRecommendationContentEl.innerHTML = '<p> 爪专 驻爪 专砖转 .  爪注  爪注 转 专砖 砖  注.</p>';
                listRecommendationEl.classList.remove('hidden');
                return;
            }

            let html = `<p class="text-sm text-gray-600 mb-4">砖 拽 转 <strong>${totalVoters}</strong> 爪注 砖 -<strong>${lists.length}</strong> 拽爪转:</p>`;
            
            html += '<div class="space-y-3">';
            
            lists.forEach((list, index) => {
                html += `<div class="p-3 bg-gray-50 border border-gray-200 rounded-md">`;
                html += `<h4 class="font-bold text-gray-800">拽爪 ${index + 1}: (${list.voters} 爪注)</h4>`;
                
                if (list.omits.length > 0) {
                    const omitsNames = list.omits.map(idx => names[idx - 1] || `注 ${idx}`).join(', ');
                    const includesNames = list.includes.map(idx => names[idx - 1] || `注 ${idx}`).join(', ');
                    
                    html += `<p class="text-sm text-red-700"><strong>砖:</strong> <span class="font-medium">${omitsNames}</span></p>`;
                    html += `<p class="text-sm text-green-700"><strong>爪注:</strong> <span class="font-medium">${includesNames}</span></p>`;
                } else {
                     const includesNames = list.includes.map(idx => names[idx - 1] || `注 ${idx}`).join(', ');
                     html += `<p class="text-sm text-green-700"><strong>爪注:</strong> <span class="font-medium">${includesNames}</span></p>`;
                }
                
                html += `</div>`;
            });
            
            html += '</div>';
            
            listRecommendationContentEl.innerHTML = html;
            listRecommendationEl.classList.remove('hidden');
        }

        /**
         * 爪 转 转 转爪转 
         */
        function displayFullResults(fullResults) {
            let html = '';
            
            fullResults.forEach(candidate => {
                let statusClass = candidate.status === '专' ? 'text-green-600 font-bold' : 'text-red-600';
                let rowClass = candidate.status === '专' ? 'bg-green-50' : '';
                if (candidate.rank > TOTAL_SEATS) {
                    rowClass = ''; //  爪注   砖抓 -19
                }
                
                let candidateClass = candidate.type === 'our' ? 'text-blue-800' : 'text-gray-700';
                
                html += `
                    <tr class="${rowClass}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${candidate.rank}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${candidateClass} font-medium">${candidate.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 font-mono">${candidate.votes}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${statusClass}">${candidate.status}</td>
                    </tr>
                `;
            });
            
            fullResultsBodyEl.innerHTML = html;
            fullResultsEl.classList.remove('hidden');
        }

    </script>
</body>
</html>
