<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>הר נבו | מערכת שליטה ובקרה לאחזקה</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --idf-green: #587042;
            --idf-dark: #2f3b26;
            --idf-accent: #8FA875;
            --alert-red: #e53e3e;
            --bg-base: #111827; /* Darker almost black */
            --panel-bg: #1f2937;
        }

        body {
            font-family: 'Heebo', sans-serif;
            background-color: var(--bg-base);
            color: #e2e8f0;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* Military Aesthetics */
        .bg-idf { background-color: var(--idf-green); }
        .text-idf { color: var(--idf-accent); }
        .border-idf { border-color: var(--idf-green); }
        
        .glass-panel {
            background: rgba(31, 41, 55, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: var(--idf-green); border-radius: 2px; }

        .btn-press:active { transform: scale(0.96); }

        /* Tactical Status Indicators */
        .status-badge {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 9999px;
            font-weight: bold;
            letter-spacing: 0.05em;
        }
        
        /* Tabs */
        .tab-btn.active {
            color: var(--idf-accent);
            border-bottom: 2px solid var(--idf-accent);
            background: rgba(255,255,255,0.03);
        }
    </style>
</head>
<body class="h-screen flex flex-col selection:bg-green-900 selection:text-white">

    <!-- Preloader / Data Initializer (Invisible) -->
    <div id="app-init"></div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 border-r-4 border-green-500 text-white px-6 py-3 rounded shadow-2xl z-[60] hidden transition-all flex items-center gap-3 min-w-[320px]">
        <i class="fas fa-satellite-dish text-green-400 animate-pulse"></i>
        <div>
            <h4 class="font-bold text-sm">מערכת הר נבו</h4>
            <span id="toast-msg" class="text-xs text-gray-300">הנתונים נשמרו בהצלחה</span>
        </div>
    </div>

    <!-- ================= VIEW 1: LOGIN ================= -->
    <div id="view-login" class="flex-1 flex flex-col items-center justify-center p-6 fade-in relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]">
        
        <!-- Background Overlay -->
        <div class="absolute inset-0 bg-gradient-to-b from-gray-900 via-gray-900 to-black opacity-90"></div>
        
        <div class="z-10 w-full max-w-sm">
            <div class="text-center mb-10">
                <div class="inline-block relative">
                    <div class="absolute inset-0 bg-green-500 blur-xl opacity-20 rounded-full"></div>
                    <div class="w-24 h-24 bg-idf rounded-full flex items-center justify-center mx-auto mb-4 shadow-2xl relative z-10 border-4 border-gray-800">
                        <i class="fas fa-mountain text-4xl text-white"></i>
                    </div>
                </div>
                <h1 class="text-5xl font-black text-white tracking-tight mb-1">הר נבו</h1>
                <p class="text-gray-400 text-sm tracking-[0.2em] font-bold uppercase">מערכת שו״ב טכנולוגית</p>
            </div>

            <div class="glass-panel p-8 rounded-2xl shadow-2xl border-t border-gray-700">
                <div class="space-y-5">
                    <div>
                        <label class="text-xs text-gray-400 font-bold ml-1 uppercase">מספר אישי / שם משתמש</label>
                        <div class="relative">
                            <input type="text" id="login-user" value="יוגב כהן" class="w-full bg-gray-900/50 border border-gray-600 rounded-lg p-3 pl-10 text-white focus:border-idf focus:ring-1 focus:ring-idf focus:outline-none transition" placeholder="שם משתמש">
                            <i class="fas fa-user absolute left-3 top-3.5 text-gray-500"></i>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="setRole('מט״ק')" class="role-sel btn-press p-3 text-sm bg-gray-800 border border-gray-600 rounded-lg hover:bg-gray-700 transition flex flex-col items-center gap-2" data-role="מט״ק">
                            <i class="fas fa-chess-king"></i> מט״ק
                        </button>
                        <button onclick="setRole('נהג')" class="role-sel btn-press p-3 text-sm bg-gray-800 border border-gray-600 rounded-lg hover:bg-gray-700 transition flex flex-col items-center gap-2 active-role" data-role="נהג">
                            <i class="fas fa-dharmachakra"></i> נהג
                        </button>
                    </div>

                    <button onclick="login()" class="w-full bg-gradient-to-r from-green-700 to-green-900 hover:from-green-600 hover:to-green-800 text-white font-bold py-4 rounded-lg shadow-lg transition transform hover:-translate-y-0.5 flex justify-center items-center gap-2">
                        <span>כניסה למערכת</span>
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
            </div>
            <p class="text-center text-[10px] text-gray-600 mt-6 font-mono">מערכת מסווגת - לשימוש פנימי בלבד | v2.4.1</p>
        </div>
    </div>

    <!-- ================= VIEW 2: DASHBOARD ================= -->
    <div id="view-home" class="hidden h-full flex flex-col fade-in bg-gray-900">
        <!-- Top Bar -->
        <header class="bg-gray-800/80 backdrop-blur-md p-4 border-b border-gray-700 flex justify-between items-center sticky top-0 z-30">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-gray-700 to-gray-800 flex items-center justify-center border border-gray-600 shadow-inner">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Yogev&backgroundColor=b6e3f4" class="w-8 h-8 rounded-full" alt="avatar">
                </div>
                <div>
                    <h2 class="font-bold text-base leading-tight text-white">היי יוגב,</h2>
                    <p class="text-[10px] text-green-400 font-mono tracking-wide">פלוגת ויקינג | כשירות מבצעית</p>
                </div>
            </div>
            <button onclick="logout()" class="text-gray-500 hover:text-red-400 transition bg-gray-800 p-2 rounded-full">
                <i class="fas fa-power-off"></i>
            </button>
        </header>

        <!-- Status Overview -->
        <div class="p-5 space-y-6 overflow-y-auto pb-24">
            
            <!-- Commander's Message -->
            <div class="bg-yellow-900/20 border-r-4 border-yellow-600 p-4 rounded-lg relative overflow-hidden">
                <div class="absolute top-0 left-0 p-2 opacity-10">
                    <i class="fas fa-bullhorn text-4xl text-yellow-500"></i>
                </div>
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <h3 class="text-yellow-500 font-bold text-xs uppercase tracking-wider mb-1">דגשי מפקד הפלוגה</h3>
                        <p class="text-gray-300 text-sm leading-relaxed font-light">
                            "שבוע מלחמה בפתח. דגש על בדיקת מתח זחל ומערכות ירי. כלי שלא כשיר ב-100% לא עולה לקו. סומך עליכם."
                        </p>
                    </div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 relative overflow-hidden">
                    <div class="absolute -right-2 -bottom-2 text-gray-700 opacity-20">
                        <i class="fas fa-tools text-5xl"></i>
                    </div>
                    <span class="block text-3xl font-black text-white" id="stat-open">2</span>
                    <span class="text-xs text-gray-400 font-medium">טיפולים פתוחים</span>
                </div>
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 relative overflow-hidden">
                    <div class="absolute -right-2 -bottom-2 text-gray-700 opacity-20">
                        <i class="fas fa-heartbeat text-5xl"></i>
                    </div>
                    <span class="block text-3xl font-black text-green-500" id="stat-readiness">92%</span>
                    <span class="text-xs text-gray-400 font-medium">כשירות מחלקתית</span>
                </div>
            </div>

            <!-- Actions -->
            <div class="space-y-3">
                <h3 class="text-gray-500 text-xs font-bold mr-1">פעולות מהירות</h3>
                
                <button onclick="openNewTreatmentModal()" class="w-full btn-press bg-gradient-to-l from-gray-800 to-gray-750 hover:bg-gray-700 border-r-4 border-idf p-5 rounded-lg shadow-lg flex justify-between items-center group transition">
                    <div>
                        <div class="font-bold text-white text-lg group-hover:text-idf transition">טיפול חדש</div>
                        <div class="text-xs text-gray-400">פתיחת שגרת טיפולים (שבועי/לפני תנועה)</div>
                    </div>
                    <div class="bg-gray-700 p-3 rounded-full group-hover:bg-idf group-hover:text-white transition duration-300">
                        <i class="fas fa-plus"></i>
                    </div>
                </button>

                <button onclick="showOpenTreatments()" class="w-full btn-press bg-gradient-to-l from-gray-800 to-gray-750 hover:bg-gray-700 border-r-4 border-blue-500 p-5 rounded-lg shadow-lg flex justify-between items-center group transition">
                    <div>
                        <div class="font-bold text-white text-lg group-hover:text-blue-400 transition">טיפולים פתוחים</div>
                        <div class="text-xs text-gray-400">המשך ביצוע, צ'ק ליסטים פעילים</div>
                    </div>
                    <div class="bg-gray-700 p-3 rounded-full group-hover:bg-blue-500 group-hover:text-white transition duration-300">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                </button>

                <button onclick="showHistory()" class="w-full btn-press bg-gradient-to-l from-gray-800 to-gray-750 hover:bg-gray-700 border-r-4 border-purple-500 p-5 rounded-lg shadow-lg flex justify-between items-center group transition">
                    <div>
                        <div class="font-bold text-white text-lg group-hover:text-purple-400 transition">תיק כלי (היסטוריה)</div>
                        <div class="text-xs text-gray-400">ארכיון טיפולים ותקלות עבר</div>
                    </div>
                    <div class="bg-gray-700 p-3 rounded-full group-hover:bg-purple-500 group-hover:text-white transition duration-300">
                        <i class="fas fa-history"></i>
                    </div>
                </button>
            </div>

            <!-- Urgent Action -->
            <button onclick="openFaultReport(null)" class="mt-4 w-full bg-red-900/20 border border-red-800/50 hover:bg-red-900/40 text-red-100 p-4 rounded-xl flex items-center justify-center gap-3 transition btn-press">
                <i class="fas fa-exclamation-triangle text-red-500 animate-pulse"></i>
                <span class="font-bold">דיווח תקלה משביתה (SOS)</span>
            </button>
        </div>
    </div>

    <!-- ================= VIEW 3: ACTIVE TREATMENT ================= -->
    <div id="view-treatment" class="hidden h-full flex flex-col bg-gray-900 slide-in">
        <!-- Header -->
        <div class="bg-gray-800 p-4 shadow-lg z-20 flex justify-between items-center border-b border-gray-700">
            <button onclick="goHome()" class="text-gray-400 hover:text-white p-2"><i class="fas fa-arrow-right text-lg"></i></button>
            <div class="text-center">
                <h2 class="font-bold text-white text-base" id="treatment-title">ט. שבועי</h2>
                <div class="flex items-center justify-center gap-2">
                    <span class="text-[10px] bg-gray-700 px-2 py-0.5 rounded text-gray-300 font-mono" id="treatment-tank">צ׳ 820041</span>
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                </div>
            </div>
            <button onclick="finishTreatment()" class="text-green-500 hover:text-green-400 font-bold text-sm">סיים</button>
        </div>

        <!-- Progress -->
        <div class="bg-gray-800 px-6 py-3 border-b border-gray-700/50">
            <div class="flex justify-between text-xs text-gray-400 mb-1 font-mono">
                <span>סטטוס ביצוע</span>
                <span id="progress-text">0%</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-1.5 overflow-hidden">
                <div id="progress-bar" class="bg-gradient-to-r from-idf-green to-green-400 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex bg-gray-800 border-b border-gray-700 sticky top-0 z-10 shadow-md">
            <button onclick="filterTasks('תובה')" class="flex-1 py-3 text-sm text-gray-400 font-medium transition tab-btn active" id="tab-hull">תובה</button>
            <button onclick="filterTasks('צריח')" class="flex-1 py-3 text-sm text-gray-400 font-medium transition tab-btn" id="tab-turret">צריח</button>
            <button onclick="filterTasks('מזקום')" class="flex-1 py-3 text-sm text-gray-400 font-medium transition tab-btn" id="tab-tracks">מזקו״ם</button>
        </div>

        <!-- Task List -->
        <div id="tasks-container" class="flex-1 overflow-y-auto p-4 space-y-3 pb-24 bg-gray-900">
            <!-- Dynamic Tasks -->
        </div>

        <!-- Add Task Floating Button -->
        <div class="absolute bottom-6 left-6 z-30">
            <button onclick="promptAddTask()" class="w-14 h-14 bg-idf rounded-full shadow-2xl text-white flex items-center justify-center text-xl hover:bg-[#4a6330] transition border-2 border-gray-700">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </div>

    <!-- ================= VIEW 4: LISTS ================= -->
    <div id="view-list" class="hidden h-full flex flex-col bg-gray-900 slide-in">
        <div class="bg-gray-800 p-4 border-b border-gray-700 flex items-center gap-4 sticky top-0 z-20">
            <button onclick="goHome()" class="text-gray-400 hover:text-white p-2"><i class="fas fa-arrow-right"></i></button>
            <h2 id="list-title" class="font-bold text-white text-lg">רשימה</h2>
        </div>
        <div id="list-container" class="flex-1 overflow-y-auto p-4 space-y-3 pb-10">
            <!-- List Items -->
        </div>
    </div>

    <!-- ================= MODALS ================= -->
    
    <!-- New Treatment Modal -->
    <div id="modal-new" class="fixed inset-0 bg-black/80 z-50 hidden flex items-end sm:items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-gray-800 rounded-2xl w-full max-w-sm p-6 border border-gray-600 shadow-2xl transform transition-transform">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">פתיחת יומן עבודה</h3>
                <button onclick="closeModal('modal-new')" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-gray-400 mb-1 font-bold">בחירת כלי (צ׳)</label>
                    <select id="new-tank-id" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 text-white focus:border-idf outline-none appearance-none">
                        <option value="820041">820041 (הכלי שלי)</option>
                        <option value="820155">820155 (סמ״פ)</option>
                        <option value="844102">844102 (גור)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1 font-bold">סוג טיפול</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="treat-type" value="טיפול שבועי" class="peer hidden" checked>
                            <div class="p-3 bg-gray-900 border border-gray-600 rounded-lg text-center text-sm text-gray-300 peer-checked:bg-idf peer-checked:text-white peer-checked:border-idf transition">
                                טיפול שבועי
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="treat-type" value="לפני תנועה" class="peer hidden">
                            <div class="p-3 bg-gray-900 border border-gray-600 rounded-lg text-center text-sm text-gray-300 peer-checked:bg-idf peer-checked:text-white peer-checked:border-idf transition">
                                לפני תנועה
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="treat-type" value="טיפול 10" class="peer hidden">
                            <div class="p-3 bg-gray-900 border border-gray-600 rounded-lg text-center text-sm text-gray-300 peer-checked:bg-idf peer-checked:text-white peer-checked:border-idf transition">
                                טיפול 10 שע׳
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="treat-type" value="טיפול טכני" class="peer hidden">
                            <div class="p-3 bg-gray-900 border border-gray-600 rounded-lg text-center text-sm text-gray-300 peer-checked:bg-idf peer-checked:text-white peer-checked:border-idf transition">
                                טיפול חוליה
                            </div>
                        </label>
                    </div>
                </div>
                
                <button onclick="createNewSession()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3.5 rounded-lg mt-4 shadow-lg transition">
                    התחל בדיקות
                </button>
            </div>
        </div>
    </div>

    <!-- Fault Report Modal -->
    <div id="modal-fault" class="fixed inset-0 bg-red-900/90 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-gray-900 rounded-2xl w-full max-w-sm p-6 border-2 border-red-600 shadow-[0_0_50px_rgba(220,38,38,0.5)] relative">
            <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-red-600 rounded-full w-12 h-12 flex items-center justify-center border-4 border-gray-900 shadow-xl">
                <i class="fas fa-wrench text-white text-lg"></i>
            </div>
            
            <h3 class="text-xl font-bold text-white mb-2 text-center mt-4">דיווח תקלה לחוליה</h3>
            <p class="text-center text-red-300 text-xs mb-4">דיווח זה יישלח מיידית למנהל עבודה גדודי</p>
            
            <div class="space-y-4">
                <textarea id="fault-desc" rows="4" class="w-full bg-black/40 border border-red-800 rounded-lg p-3 text-white placeholder-red-300/30 focus:outline-none focus:border-red-500 text-sm" placeholder="תאר את התקלה בפירוט... (למשל: נזילת שמן מההינע סופי צד ימין, בורג משוחרר בזר מניע)"></textarea>
                
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="submitFault()" class="bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded-lg shadow-lg flex items-center justify-center gap-2">
                        <span>שלח דיווח</span>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                    <button onclick="closeModal('modal-fault')" class="bg-transparent border border-gray-600 text-gray-300 hover:bg-gray-800 py-3 rounded-lg">
                        ביטול
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        // --- 1. CONFIGURATION & MOCK DATA ---
        
        const currentUser = { name: 'יוגב כהן', role: 'נהג', id: 's7821211' };
        
        // Detailed Tank Tasks (Hebrew Military Terminology)
        const checkLists = {
            'תובה': [
                { title: 'בדיקת מפלס שמן מנוע (מנוע דומם)', critical: true },
                { title: 'בדיקת מפלס שמן ממסרת (מדיד שמאלי)', critical: true },
                { title: 'בדיקת נוזל קירור במיכל התפשטות', critical: true },
                { title: 'ניקוז מים ממפריד דלק (סולר)', critical: false },
                { title: 'בדיקת נזילות מתא המנוע', critical: true },
                { title: 'ניקיון מסנני אוויר (פילטרים)', critical: false },
                { title: 'בדיקת תקינות מטפי כיבוי (שעון ירוק)', critical: true }
            ],
            'צריח': [
                { title: 'בדיקת שמן הידראולי (מפלס)', critical: true },
                { title: 'בדיקת צידוד והגבהה (ידני + חשמלי)', critical: true },
                { title: 'ניקיון קנה ובית הבליעה', critical: false },
                { title: 'בדיקת קשר פנים וחוץ (ורדית)', critical: true },
                { title: 'בדיקת מקלע מקביל (דריכה ונצירה)', critical: true },
                { title: 'תקינות מדף מפקד וטען', critical: false },
                { title: 'בדיקת עשן מיידי (חיבורים)', critical: false }
            ],
            'מזקום': [
                { title: 'בדיקת מתח זחל (ויזואלי)', critical: true },
                { title: 'בדיקת ברגים בבוקים (חיזוק)', critical: true },
                { title: 'בדיקת נזילות מהינעים סופיים', critical: true },
                { title: 'תקינות זרים מניעים', critical: false },
                { title: 'בדיקת פלטות בזנתי״ם', critical: false },
                { title: 'ניקיון בוץ ממערכת המזקו״ם', critical: false }
            ]
        };

        // Seed Data (To make the demo look "lived in")
        function seedData() {
            if(!localStorage.getItem('harnevo_data_seeded')) {
                const pastSessions = [
                    {
                        id: 's_1', type: 'טיפול שבועי', tankId: '820041', status: 'closed', timestamp: Date.now() - 604800000, 
                        createdBy: 'יוגב כהן', hasFaults: false, tasks: [], score: 100
                    },
                    {
                        id: 's_2', type: 'לפני תנועה', tankId: '820041', status: 'closed', timestamp: Date.now() - 259200000, 
                        createdBy: 'יוגב כהן', hasFaults: true, tasks: [], score: 85
                    },
                    {
                        id: 's_3', type: 'טיפול שבועי', tankId: '820155', status: 'open', timestamp: Date.now() - 86400000, 
                        createdBy: 'אביב המט״ק', hasFaults: false, 
                        tasks: generateTasksForSeed()
                    }
                ];
                
                pastSessions.forEach(s => localStorage.setItem(`harnevo_session_${s.id}`, JSON.stringify(s)));
                localStorage.setItem('harnevo_data_seeded', 'true');
            }
        }

        function generateTasksForSeed() {
            // Helper to generate a dummy task list for the open session
            let tasks = [];
            Object.keys(checkLists).forEach(cat => {
                checkLists[cat].forEach((t, i) => {
                    tasks.push({
                        id: Date.now() + i, category: cat, title: t.title, critical: t.critical,
                        status: i < 3 ? 'done' : 'pending', by: i < 3 ? 'אביב המט״ק' : '', notes: ''
                    });
                });
            });
            return tasks;
        }

        // --- 2. STATE MANAGEMENT ---

        let activeSessionId = null;
        let activeFilter = 'תובה';
        let currentRole = 'נהג';

        function setRole(role) {
            currentRole = role;
            currentUser.role = role;
            // UI Update
            document.querySelectorAll('.role-sel').forEach(btn => {
                if(btn.dataset.role === role) {
                    btn.classList.add('border-idf', 'text-white', 'bg-gray-700');
                    btn.classList.remove('border-gray-600', 'text-gray-400');
                    btn.querySelector('i').classList.add('text-green-400');
                } else {
                    btn.classList.remove('border-idf', 'text-white', 'bg-gray-700');
                    btn.classList.add('border-gray-600', 'text-gray-400');
                    btn.querySelector('i').classList.remove('text-green-400');
                }
            });
        }

        function login() {
            const userVal = document.getElementById('login-user').value;
            currentUser.name = userVal || 'יוגב כהן';
            
            // Transition
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-home').classList.remove('hidden');
            updateDashboard();
        }

        function logout() {
            if(confirm('האם לצאת מהמערכת?')) location.reload();
        }

        // --- 3. DASHBOARD LOGIC ---

        function updateDashboard() {
            const sessions = getAllSessions();
            const openCount = sessions.filter(s => s.status === 'open').length;
            
            // Animate Numbers
            animateValue("stat-open", 0, openCount, 1000);
            
            // Calc Readiness (Fake Logic based on faults)
            const faults = sessions.filter(s => s.hasFaults).length;
            const readiness = Math.max(70, 100 - (faults * 5));
            document.getElementById('stat-readiness').innerText = readiness + '%';
            document.getElementById('stat-readiness').className = `block text-3xl font-black ${readiness > 90 ? 'text-green-500' : 'text-yellow-500'}`;
        }

        function getAllSessions() {
            const sessions = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('harnevo_session_')) {
                    sessions.push(JSON.parse(localStorage.getItem(key)));
                }
            }
            return sessions.sort((a,b) => b.timestamp - a.timestamp);
        }

        // --- 4. TREATMENT LOGIC ---

        function openNewTreatmentModal() {
            document.getElementById('modal-new').classList.remove('hidden');
            document.getElementById('modal-new').classList.add('flex');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.getElementById(modalId).classList.remove('flex');
        }

        function createNewSession() {
            const tankId = document.getElementById('new-tank-id').value;
            const type = document.querySelector('input[name="treat-type"]:checked').value;
            
            // Build Task List
            let tasks = [];
            let idCounter = 1;
            Object.keys(checkLists).forEach(cat => {
                checkLists[cat].forEach(t => {
                    tasks.push({
                        id: Date.now() + idCounter++,
                        category: cat,
                        title: t.title,
                        critical: t.critical,
                        status: 'pending',
                        by: '',
                        notes: ''
                    });
                });
            });

            const newSession = {
                id: Date.now().toString(),
                tankId: tankId,
                type: type,
                status: 'open',
                timestamp: Date.now(),
                createdBy: currentUser.name,
                hasFaults: false,
                tasks: tasks
            };

            saveSession(newSession);
            closeModal('modal-new');
            loadSession(newSession.id);
        }

        function loadSession(sessionId) {
            activeSessionId = sessionId;
            const session = JSON.parse(localStorage.getItem(`harnevo_session_${sessionId}`));
            
            // Update UI
            document.getElementById('treatment-title').innerText = session.type;
            document.getElementById('treatment-tank').innerText = `צ׳ ${session.tankId}`;
            
            // Switch Views
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-list').classList.add('hidden');
            document.getElementById('view-treatment').classList.remove('hidden');
            
            filterTasks('תובה'); // Reset to Hull
        }

        function filterTasks(category) {
            activeFilter = category;
            
            // Tab Styles
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            if(category === 'תובה') document.getElementById('tab-hull').classList.add('active');
            if(category === 'צריח') document.getElementById('tab-turret').classList.add('active');
            if(category === 'מזקום') document.getElementById('tab-tracks').classList.add('active');

            renderTasks();
        }

        function renderTasks() {
            const session = JSON.parse(localStorage.getItem(`harnevo_session_${activeSessionId}`));
            const container = document.getElementById('tasks-container');
            container.innerHTML = '';
            
            const tasksToShow = session.tasks.filter(t => t.category === activeFilter);

            if(tasksToShow.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 mt-10 p-5 border border-dashed border-gray-700 rounded-lg">אין משימות בקטגוריה זו</div>`;
                return;
            }

            tasksToShow.forEach(task => {
                const isDone = task.status === 'done';
                const isProb = task.status === 'problem';
                
                const el = document.createElement('div');
                el.className = `relative overflow-hidden bg-gray-800 rounded-lg border ${isProb ? 'border-red-500' : (isDone ? 'border-green-900' : 'border-gray-700')} p-0 transition-all duration-300`;
                
                el.innerHTML = `
                    <div class="flex items-stretch min-h-[80px]">
                        <!-- Checkbox Area -->
                        <div class="w-14 flex items-center justify-center cursor-pointer ${isDone ? 'bg-idf' : 'bg-gray-700 hover:bg-gray-600'} transition" onclick="toggleTask(${task.id})">
                            ${isDone ? '<i class="fas fa-check text-white text-xl"></i>' : '<div class="w-6 h-6 rounded-full border-2 border-gray-500"></div>'}
                        </div>
                        
                        <!-- Content -->
                        <div class="flex-1 p-3 flex flex-col justify-center">
                            <div class="flex justify-between items-start">
                                <h4 class="text-sm font-bold ${isDone ? 'text-gray-400 line-through' : 'text-gray-200'}">${task.title}</h4>
                                ${task.critical ? '<i class="fas fa-star-of-life text-[10px] text-red-500 ml-1" title="קריטי"></i>' : ''}
                            </div>
                            <div class="mt-2 flex justify-between items-center text-xs">
                                <span class="${isDone ? 'text-green-400' : 'text-gray-500'}">
                                    ${isDone ? '<i class="fas fa-user-check"></i> ' + task.by : 'ממתין לביצוע'}
                                </span>
                                ${isProb ? '<span class="text-red-400 font-bold bg-red-900/30 px-2 rounded">תקלה</span>' : ''}
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="flex flex-col border-r border-gray-700">
                             <button onclick="reportSpecificFault(${task.id})" class="flex-1 px-3 text-gray-500 hover:text-red-400 hover:bg-gray-700/50 transition">
                                <i class="fas fa-wrench"></i>
                            </button>
                             <button onclick="toggleNoteField(this)" class="flex-1 px-3 text-gray-500 hover:text-blue-400 hover:bg-gray-700/50 transition">
                                <i class="fas fa-comment-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Hidden Note Field -->
                    <div class="hidden bg-gray-900/50 p-2 border-t border-gray-700 note-field animate-fade-in">
                        <input type="text" value="${task.notes}" onblur="saveNote(${task.id}, this.value)" class="w-full bg-transparent text-xs text-gray-300 placeholder-gray-600 focus:outline-none" placeholder="הוסף הערה...">
                    </div>
                `;
                container.appendChild(el);
            });

            // Update Progress
            const total = session.tasks.length;
            const done = session.tasks.filter(t => t.status === 'done').length;
            const pct = Math.round((done/total)*100);
            
            document.getElementById('progress-bar').style.width = pct + '%';
            document.getElementById('progress-text').innerText = pct + '%';
        }

        function toggleTask(taskId) {
            const session = JSON.parse(localStorage.getItem(`harnevo_session_${activeSessionId}`));
            const task = session.tasks.find(t => t.id === taskId);
            
            if (task.status === 'problem') return; // Cannot toggle if fault

            if (task.status === 'done') {
                task.status = 'pending';
                task.by = '';
            } else {
                task.status = 'done';
                task.by = currentUser.name;
                // Vibration feedback if mobile
                if(navigator.vibrate) navigator.vibrate(50);
            }
            saveSession(session);
            renderTasks();
        }

        function toggleNoteField(btn) {
            const noteDiv = btn.parentElement.parentElement.nextElementSibling;
            noteDiv.classList.toggle('hidden');
        }

        function saveNote(taskId, text) {
            const session = JSON.parse(localStorage.getItem(`harnevo_session_${activeSessionId}`));
            const task = session.tasks.find(t => t.id === taskId);
            task.notes = text;
            saveSession(session);
        }

        function reportSpecificFault(taskId) {
            // Open modal but with context
            openFaultReport(taskId);
        }

        function promptAddTask() {
            const title = prompt("שם הבדיקה/משימה החדשה:");
            if(title) {
                const session = JSON.parse(localStorage.getItem(`harnevo_session_${activeSessionId}`));
                session.tasks.push({
                    id: Date.now(),
                    category: activeFilter,
                    title: title,
                    critical: false,
                    status: 'pending',
                    by: '',
                    notes: 'נוסף ידנית'
                });
                saveSession(session);
                renderTasks();
                showToast("משימה נוספה לרשימה");
            }
        }

        function finishTreatment() {
            const session = JSON.parse(localStorage.getItem(`harnevo_session_${activeSessionId}`));
            const pending = session.tasks.filter(t => t.status === 'pending');
            
            if(pending.length > 0 && !session.hasFaults) {
                if(!confirm(`נותרו ${pending.length} משימות פתוחות. האם לסיים בכל זאת?`)) return;
            }

            session.status = 'closed';
            saveSession(session);
            showToast("הטיפול נסגר ונשמר בארכיון");
            goHome();
        }

        // --- 5. FAULT & LIST LOGIC ---

        let currentFaultTaskId = null;

        function openFaultReport(taskId) {
            currentFaultTaskId = taskId;
            document.getElementById('modal-fault').classList.remove('hidden');
            document.getElementById('modal-fault').classList.add('flex');
        }

        function submitFault() {
            const desc = document.getElementById('fault-desc').value;
            if(!desc) { alert("נא לפרט את התקלה"); return; }

            // If inside a session and attached to a task
            if(activeSessionId) {
                const session = JSON.parse(localStorage.getItem(`harnevo_session_${activeSessionId}`));
                session.hasFaults = true;
                
                if(currentFaultTaskId) {
                    const task = session.tasks.find(t => t.id === currentFaultTaskId);
                    task.status = 'problem';
                    task.notes = desc;
                    task.by = currentUser.name;
                } else {
                    // General fault added to current category
                    session.tasks.push({
                        id: Date.now(),
                        category: activeFilter,
                        title: 'תקלה: ' + desc,
                        status: 'problem',
                        by: currentUser.name,
                        notes: desc,
                        critical: true
                    });
                }
                saveSession(session);
                if(!document.getElementById('view-treatment').classList.contains('hidden')) {
                    renderTasks();
                }
            } else {
                // Global fault report (e.g. from Dashboard)
                // Just create a dummy session for the log in this demo
                const faultSession = {
                    id: 'fault_' + Date.now(),
                    tankId: '820041',
                    type: 'דיווח תקלה חירום',
                    status: 'closed',
                    timestamp: Date.now(),
                    createdBy: currentUser.name,
                    hasFaults: true,
                    tasks: []
                };
                localStorage.setItem(`harnevo_session_${faultSession.id}`, JSON.stringify(faultSession));
            }

            closeModal('modal-fault');
            document.getElementById('fault-desc').value = '';
            showToast("התקלה דווחה למנהל עבודה!");
        }

        function showHistory() {
            const sessions = getAllSessions().filter(s => s.status === 'closed');
            renderSessionList(sessions, 'היסטוריית טיפולים', false);
        }

        function showOpenTreatments() {
            const sessions = getAllSessions().filter(s => s.status === 'open');
            renderSessionList(sessions, 'טיפולים פתוחים', true);
        }

        function renderSessionList(sessions, title, isClickable) {
            document.getElementById('list-title').innerText = title;
            const container = document.getElementById('list-container');
            container.innerHTML = '';
            
            // Switch view
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-list').classList.remove('hidden');

            if(sessions.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 mt-8">אין רשומות</div>';
                return;
            }

            sessions.forEach(s => {
                const date = new Date(s.timestamp);
                const dateStr = `${date.getDate()}/${date.getMonth()+1}`;
                
                const div = document.createElement('div');
                div.className = `bg-gray-800 p-4 rounded-lg border-r-4 ${s.hasFaults ? 'border-red-500' : (s.status === 'open' ? 'border-blue-500' : 'border-gray-600')} shadow mb-3 flex justify-between items-center btn-press cursor-pointer`;
                
                div.onclick = () => {
                    if(isClickable || confirm('האם לפתוח טיפול מארכיון לעיון?')) loadSession(s.id);
                };

                div.innerHTML = `
                    <div>
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-white text-lg">${s.type}</span>
                            <span class="text-xs bg-gray-700 px-2 py-0.5 rounded text-gray-300 font-mono">צ׳ ${s.tankId}</span>
                        </div>
                        <div class="text-xs text-gray-400 mt-1 flex gap-3">
                            <span><i class="far fa-calendar"></i> ${dateStr}</span>
                            <span><i class="fas fa-user"></i> ${s.createdBy}</span>
                        </div>
                    </div>
                    <div class="text-2xl">
                        ${s.hasFaults ? '<i class="fas fa-exclamation-circle text-red-500"></i>' : (s.status==='open' ? '<i class="fas fa-edit text-blue-500"></i>' : '<i class="fas fa-check-circle text-gray-600"></i>')}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // --- 6. UTILITIES ---

        function goHome() {
            document.querySelectorAll('body > div[id^="view-"]').forEach(d => d.classList.add('hidden'));
            document.getElementById('view-home').classList.remove('hidden');
            updateDashboard();
        }

        function saveSession(session) {
            localStorage.setItem(`harnevo_session_${session.id}`, JSON.stringify(session));
            window.dispatchEvent(new Event('storage')); // Trigger sync
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3500);
        }

        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id);
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        // --- INIT ---
        (function init() {
            seedData();
            // Sync across tabs listener
            window.addEventListener('storage', () => {
                if(activeSessionId) loadSession(activeSessionId); // Hot reload check list
                else if(!document.getElementById('view-home').classList.contains('hidden')) updateDashboard();
            });
        })();

    </script>
</body>
</html>
