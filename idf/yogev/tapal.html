<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>驻- | 注专转  驻 专拽"</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Heebo', sans-serif;
            background-color: #1a202c; /* Dark Theme Base */
            color: #e2e8f0;
        }

        /* Military / Tank Vibe Colors */
        .bg-army { background-color: #4a5d23; }
        .text-army { color: #84a98c; }
        .border-army { border-color: #4a5d23; }
        
        .bg-sand { background-color: #d4c5a9; color: #2d3748; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748; 
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5d23; 
            border-radius: 4px;
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .status-checkbox:checked + div {
            background-color: #4a5d23;
            border-color: #84a98c;
            color: white;
        }

        .tab-active {
            border-bottom: 3px solid #84a98c;
            color: #84a98c;
            font-weight: bold;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- App State Container (Hidden Logic) -->
    <div id="app-data" data-session="" data-user=""></div>

    <!-- NOTIFICATION TOAST -->
    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-gray-800 border border-green-500 text-white px-6 py-3 rounded-full shadow-2xl z-50 hidden transition-all duration-300">
        <i class="fas fa-check-circle ml-2 text-green-400"></i>
        <span id="toast-msg">注</span>
    </div>

    <!-- ================= VIEW 1: LOGIN / LANDING ================= -->
    <div id="view-login" class="flex-1 flex flex-col items-center justify-center p-4 fade-in">
        <div class="text-center mb-8">
            <div class="inline-block p-4 rounded-full bg-army mb-4 shadow-lg ring-4 ring-gray-700">
                <i class="fas fa-tank text-4xl text-white"></i>
            </div>
            <h1 class="text-4xl font-black text-gray-100 tracking-wider">驻-</h1>
            <p class="text-gray-400 text-sm mt-2">注专转  拽 专拽"</p>
        </div>

        <div class="bg-gray-800 p-6 rounded-xl shadow-xl w-full max-w-sm border border-gray-700">
            <!-- Name Input -->
            <div class="mb-6">
                <label class="block text-gray-400 text-xs font-bold mb-2">砖  / </label>
                <input type="text" id="username-input" class="w-full bg-gray-900 border border-gray-600 rounded p-3 text-white focus:outline-none focus:border-army transition" placeholder="砖:  ">
            </div>

            <!-- Role Selection -->
            <div class="mb-6">
                <label class="block text-gray-400 text-xs font-bold mb-2">转驻拽 爪转</label>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="selectRole('状拽')" class="role-btn p-2 rounded bg-gray-700 hover:bg-gray-600 text-sm transition" data-role="状拽">状拽 </button>
                    <button onclick="selectRole('转转')" class="role-btn p-2 rounded bg-gray-700 hover:bg-gray-600 text-sm transition" data-role="转转">转转 </button>
                    <button onclick="selectRole('注')" class="role-btn p-2 rounded bg-gray-700 hover:bg-gray-600 text-sm transition" data-role="注">注 </button>
                    <button onclick="selectRole('')" class="role-btn p-2 rounded bg-gray-700 hover:bg-gray-600 text-sm transition" data-role=""> </button>
                </div>
            </div>

            <div class="flex flex-col gap-3">
                <button onclick="createSession()" class="w-full bg-army hover:bg-green-700 text-white font-bold py-3 rounded shadow-lg transition flex justify-center items-center gap-2">
                    <i class="fas fa-plus"></i> 爪专 驻 砖
                </button>
                
                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-600"></div>
                    <span class="flex-shrink mx-4 text-gray-500 text-xs"> 爪专祝 拽</span>
                    <div class="flex-grow border-t border-gray-600"></div>
                </div>

                <div class="flex gap-2">
                    <input type="text" id="session-code-input" class="flex-1 bg-gray-900 border border-gray-600 rounded p-3 text-center tracking-widest uppercase font-mono" placeholder="拽 驻">
                    <button onclick="joinSession()" class="bg-gray-700 hover:bg-gray-600 text-white px-6 rounded font-bold transition">
                        爪专祝
                    </button>
                </div>
            </div>
        </div>
        
        <p class="mt-8 text-gray-500 text-xs text-center max-w-xs">
            驻: 驻转 转 祝  住祝  转 砖转砖 专 爪转. 住专  .
        </p>
    </div>

    <!-- ================= VIEW 2: DASHBOARD ================= -->
    <div id="view-dashboard" class="flex-1 flex flex-col hidden fade-in h-full">
        
        <!-- Top Bar -->
        <header class="bg-gray-800 border-b border-gray-700 p-3 shadow-md flex justify-between items-center z-10">
            <div class="flex items-center gap-3">
                <div class="bg-army w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-lg shadow">
                    <i class="fas fa-tank"></i>
                </div>
                <div>
                    <h2 class="font-bold text-white text-sm leading-tight">驻 砖注</h2>
                    <div class="text-xs text-gray-400 flex gap-2">
                        <span>拽: <span id="display-code" class="font-mono text-green-400 font-bold select-all cursor-pointer"></span></span>
                        <span>|</span>
                        <span id="display-user"></span>
                    </div>
                </div>
            </div>
            <button onclick="logout()" class="text-red-400 hover:text-red-300 text-sm">
                <i class="fas fa-sign-out-alt"></i> 爪
            </button>
        </header>

        <!-- Progress Bar -->
        <div class="bg-gray-900 px-4 py-2">
            <div class="flex justify-between text-xs text-gray-400 mb-1">
                <span>转拽转 转</span>
                <span id="progress-text">0%</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2.5">
                <div id="progress-bar" class="bg-gradient-to-r from-green-600 to-green-400 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>

        <!-- Alerts / Dgeshim Box -->
        <div class="bg-yellow-900/30 border-r-4 border-yellow-600 p-3 m-2 mx-4 rounded flex items-start gap-3">
            <i class="fas fa-exclamation-triangle text-yellow-500 mt-1"></i>
            <div class="flex-1">
                <h3 class="text-yellow-500 font-bold text-xs">砖 驻拽</h3>
                <p id="commander-notes" class="text-gray-300 text-sm mt-1" contenteditable="true" onblur="updateCommanderNotes(this.innerText)">
                     砖  专 拽 爪. 拽 砖 住专转 专转, 注 .
                </p>
            </div>
        </div>

        <!-- Tabs -->
        <nav class="flex justify-around bg-gray-800 border-b border-gray-700 text-sm sticky top-0 z-10">
            <button onclick="filterTasks('all')" class="tab-btn tab-active py-3 flex-1 text-center" id="tab-all"></button>
            <button onclick="filterTasks('转')" class="tab-btn py-3 flex-1 text-center" id="tab-hull">转</button>
            <button onclick="filterTasks('爪专')" class="tab-btn py-3 flex-1 text-center" id="tab-turret">爪专</button>
            <button onclick="filterTasks('拽')" class="tab-btn py-3 flex-1 text-center" id="tab-tracks">拽状</button>
        </nav>

        <!-- Tasks List Area -->
        <div id="tasks-container" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-900">
            <!-- Dynamic Tasks Will Be Injected Here -->
        </div>

        <!-- Add Note / Floating Action -->
        <div class="p-3 bg-gray-800 border-t border-gray-700 flex gap-2">
            <input type="text" id="new-task-input" placeholder="住祝 砖/专'拽..." class="flex-1 bg-gray-900 text-white rounded px-3 py-2 border border-gray-600 text-sm focus:outline-none focus:border-army">
            <button onclick="addNewCustomTask()" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded transition">
                <i class="fas fa-plus"></i>
            </button>
        </div>

    </div>

    <!-- Logic Script -->
    <script>
        // --- State Management ---
        const currentUser = {
            name: '',
            role: ''
        };

        let currentSessionCode = null;
        
        // Initial Mock Tasks Data
        const defaultTasks = [
            { id: 1, category: '拽', title: '拽转 转 ', status: 'pending', by: '', notes: '' },
            { id: 2, category: '拽', title: '拽转 专 拽', status: 'pending', by: '', notes: '' },
            { id: 3, category: '转', title: '驻住 砖 注', status: 'pending', by: '', notes: '' },
            { id: 4, category: '转', title: '驻住  拽专专', status: 'pending', by: '', notes: '' },
            { id: 5, category: '转', title: '拽  住 拽', status: 'pending', by: '', notes: '' },
            { id: 6, category: '爪专', title: '拽转 爪  ()', status: 'pending', by: '', notes: '' },
            { id: 7, category: '爪专', title: '拽 拽', status: 'pending', by: '', notes: '' },
            { id: 8, category: '爪专', title: '拽转 拽注 拽', status: 'pending', by: '', notes: '' },
            { id: 9, category: '拽砖专', title: '拽转 拽砖专 驻', status: 'pending', by: '', notes: '' },
            { id: 10, category: '', title: '拽转 驻', status: 'pending', by: '', notes: '' },
        ];

        let sessionData = {
            tasks: [],
            commanderNotes: " 砖  转 砖.  注 注 注转 砖注.",
            logs: []
        };

        // --- Auth & Setup Functions ---

        function selectRole(role) {
            currentUser.role = role;
            // Visual feedback
            document.querySelectorAll('.role-btn').forEach(btn => {
                if(btn.dataset.role === role) {
                    btn.classList.add('bg-green-600', 'text-white', 'ring-2', 'ring-white');
                    btn.classList.remove('bg-gray-700');
                } else {
                    btn.classList.remove('bg-green-600', 'text-white', 'ring-2', 'ring-white');
                    btn.classList.add('bg-gray-700');
                }
            });
        }

        function createSession() {
            const name = document.getElementById('username-input').value;
            if(!name || !currentUser.role) {
                showToast("  砖 专 转驻拽");
                return;
            }
            currentUser.name = name;
            
            // Generate random 4 digit code
            currentSessionCode = Math.floor(1000 + Math.random() * 9000).toString();
            
            // Init Data
            sessionData.tasks = JSON.parse(JSON.stringify(defaultTasks)); // Deep copy
            sessionData.logs.push(`${name} (${currentUser.role}) 驻转 转 驻`);
            
            saveSession();
            enterDashboard();
        }

        function joinSession() {
            const name = document.getElementById('username-input').value;
            const code = document.getElementById('session-code-input').value;
            
            if(!name || !currentUser.role) {
                showToast("  砖 专 转驻拽");
                return;
            }
            if(!code) {
                showToast("  拽 驻");
                return;
            }

            // Try to load from local storage
            const storedData = localStorage.getItem(`tefach_${code}`);
            if(!storedData) {
                showToast(" 爪 驻 注 拽 ");
                return;
            }

            currentUser.name = name;
            currentSessionCode = code;
            loadSession(); // Load existing data
            
            // Add join log
            sessionData.logs.push(`${name} (${currentUser.role}) 爪专祝 驻`);
            saveSession();

            enterDashboard();
        }

        function enterDashboard() {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-dashboard').classList.remove('hidden');
            
            document.getElementById('display-code').innerText = currentSessionCode;
            document.getElementById('display-user').innerText = `${currentUser.name} (${currentUser.role})`;
            
            renderTasks('all');
            updateProgress();
            
            // Copy Code Feature
            document.getElementById('display-code').addEventListener('click', () => {
                navigator.clipboard.writeText(currentSessionCode);
                showToast("拽 注转拽 !");
            });
        }

        function logout() {
            location.reload();
        }

        // --- Core Logic ---

        function saveSession() {
            if(!currentSessionCode) return;
            localStorage.setItem(`tefach_${currentSessionCode}`, JSON.stringify(sessionData));
        }

        function loadSession() {
            if(!currentSessionCode) return;
            const stored = localStorage.getItem(`tefach_${currentSessionCode}`);
            if(stored) {
                sessionData = JSON.parse(stored);
                document.getElementById('commander-notes').innerText = sessionData.commanderNotes;
                renderTasks(currentFilter);
                updateProgress();
            }
        }

        // --- Rendering ---
        
        let currentFilter = 'all';

        function filterTasks(category) {
            currentFilter = category;
            
            // Update tabs UI
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('tab-active'));
            if(category === 'all') document.getElementById('tab-all').classList.add('tab-active');
            else if(category === '转') document.getElementById('tab-hull').classList.add('tab-active');
            else if(category === '爪专') document.getElementById('tab-turret').classList.add('tab-active');
            else if(category === '拽') document.getElementById('tab-tracks').classList.add('tab-active');

            renderTasks(category);
        }

        function renderTasks(categoryFilter) {
            const container = document.getElementById('tasks-container');
            container.innerHTML = '';

            sessionData.tasks.forEach(task => {
                // Filter logic
                if(categoryFilter !== 'all' && task.category !== categoryFilter && task.category !== '') {
                    if (categoryFilter === '拽' && task.category !== '拽') return;
                    if (categoryFilter === '转' && task.category !== '转') return;
                    if (categoryFilter === '爪专' && task.category !== '爪专') return;
                }

                const isDone = task.status === 'done';
                const isProblem = task.status === 'problem';
                
                // Color coding for categories
                let catColor = 'bg-gray-600';
                if(task.category === '拽') catColor = 'bg-yellow-700';
                if(task.category === '转') catColor = 'bg-blue-700';
                if(task.category === '爪专') catColor = 'bg-green-700';

                const card = document.createElement('div');
                card.className = `bg-gray-800 rounded-lg p-3 shadow border-r-4 ${isDone ? 'border-green-500' : (isProblem ? 'border-red-500' : 'border-gray-600')} flex flex-col gap-2 transition-all`;

                card.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex items-center gap-3 flex-1">
                            <!-- Checkbox Logic -->
                            <label class="relative cursor-pointer">
                                <input type="checkbox" class="status-checkbox hidden" ${isDone ? 'checked' : ''} onchange="toggleTaskStatus(${task.id}, this.checked)">
                                <div class="w-6 h-6 rounded border-2 border-gray-500 flex items-center justify-center transition-colors ${isDone ? 'bg-green-600 border-green-600 text-white' : ''}">
                                    ${isDone ? '<i class="fas fa-check text-xs"></i>' : ''}
                                </div>
                            </label>
                            
                            <div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-white px-1.5 rounded-sm ${catColor}">${task.category}</span>
                                    <h4 class="font-bold text-gray-200 text-sm ${isDone ? 'line-through text-gray-500' : ''}">${task.title}</h4>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">
                                    ${isDone 
                                        ? `<span class="text-green-400"><i class="fas fa-user-check"></i> ${task.by}</span>` 
                                        : (isProblem ? '<span class="text-red-400 font-bold">转拽 </span>' : '专 爪注')}
                                </p>
                            </div>
                        </div>

                        <div class="flex flex-col gap-1">
                             <button onclick="reportProblem(${task.id})" class="text-gray-500 hover:text-red-400 p-1" title=" 转拽">
                                <i class="fas fa-wrench ${isProblem ? 'text-red-500' : ''}"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Notes Section -->
                    <div class="bg-gray-900/50 rounded p-2 flex items-center gap-2 mt-1">
                        <i class="fas fa-comment-alt text-gray-600 text-xs"></i>
                        <input type="text" 
                            class="bg-transparent text-xs w-full text-gray-300 focus:outline-none placeholder-gray-600" 
                            placeholder="注专转..." 
                            value="${task.notes || ''}" 
                            onblur="updateTaskNote(${task.id}, this.value)">
                    </div>
                `;
                container.appendChild(card);
            });

            // Empty state
            if(container.children.length === 0) {
                container.innerHTML = `
                    <div class="text-center mt-10 opacity-50">
                        <i class="fas fa-clipboard-check text-4xl mb-2 text-gray-600"></i>
                        <p> 砖转 拽专 </p>
                    </div>
                `;
            }
        }

        // --- Actions ---

        function toggleTaskStatus(id, isChecked) {
            const task = sessionData.tasks.find(t => t.id === id);
            if(task) {
                if(isChecked) {
                    task.status = 'done';
                    task.by = currentUser.name;
                    playSound('check');
                } else {
                    task.status = 'pending';
                    task.by = '';
                }
                saveSession();
                renderTasks(currentFilter);
                updateProgress();
            }
        }

        function reportProblem(id) {
            const task = sessionData.tasks.find(t => t.id === id);
            if(task) {
                if(task.status === 'problem') {
                    task.status = 'pending'; // Reset
                } else {
                    const note = prompt(" 转拽?", task.notes);
                    if(note !== null) {
                        task.status = 'problem';
                        task.notes = note;
                        task.by = currentUser.name;
                    }
                }
                saveSession();
                renderTasks(currentFilter);
                updateProgress();
            }
        }

        function updateTaskNote(id, noteText) {
            const task = sessionData.tasks.find(t => t.id === id);
            if(task && task.notes !== noteText) {
                task.notes = noteText;
                saveSession();
            }
        }

        function updateCommanderNotes(text) {
            if(sessionData.commanderNotes !== text) {
                sessionData.commanderNotes = text;
                saveSession();
            }
        }

        function addNewCustomTask() {
            const input = document.getElementById('new-task-input');
            const title = input.value.trim();
            if(!title) return;

            const newTask = {
                id: Date.now(),
                category: currentFilter === 'all' ? '' : currentFilter,
                title: title,
                status: 'pending',
                by: '',
                notes: ''
            };
            
            sessionData.tasks.push(newTask);
            input.value = '';
            saveSession();
            renderTasks(currentFilter);
            updateProgress();
            showToast("砖 住驻");
        }

        function updateProgress() {
            const total = sessionData.tasks.length;
            const completed = sessionData.tasks.filter(t => t.status === 'done').length;
            const percent = total === 0 ? 0 : Math.round((completed / total) * 100);
            
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('progress-text').innerText = `${percent}%`;

            // Visual feedback for completion
            if(percent === 100) {
                document.getElementById('progress-bar').classList.remove('from-green-600', 'to-green-400');
                document.getElementById('progress-bar').classList.add('from-yellow-400', 'to-yellow-600'); // Gold
            }
        }

        // --- Utilities ---

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.classList.remove('hidden');
            toast.classList.add('fade-in');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function playSound(type) {
            // Very subtle sound effects using Web Audio API could go here
            // For now, silent
        }

        // --- Multi-Tab Sync Logic (The Magic) ---
        // This listens for changes in LocalStorage from OTHER tabs
        window.addEventListener('storage', (e) => {
            if(e.key === `tefach_${currentSessionCode}`) {
                // Another user updated the session!
                const newData = JSON.parse(e.newValue);
                sessionData = newData;
                
                // Re-render
                document.getElementById('commander-notes').innerText = sessionData.commanderNotes;
                renderTasks(currentFilter);
                updateProgress();
                
                // Show notification?
                // showToast("转 注 注状 专 爪转");
            }
        });

    </script>
</body>
</html>
