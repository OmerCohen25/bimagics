<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>BI Magics • Demo</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@3.4.0/tsparticles.bundle.min.js" defer></script>

  <link rel="stylesheet" href="style.css">
</head>
<body>
  <canvas id="tsparticles"></canvas>

  <nav class="top-nav">
    <button data-view-id="connect" data-index="0" class="active">Connect</button>
    <button data-view-id="chat" data-index="1">Chat</button>
    <button data-view-id="feed" data-index="2">Feed</button>
    <button data-view-id="studio" data-index="3">Studio</button>
    </nav>

  <div id="views-wrapper">
      <div id="views-carousel" class="views">
          </div>
  </div>

  <script type="module">
    // Import view modules
    import { renderConnectView } from './connectors.js';
    import { renderChatView } from './chat.js';
    import { renderFeedView } Dלאתר מ- './feed.js'; // שינוי שם הפונקציה כדי למנוע התנגשות
    import { renderStudioView } from './studio.js';
    // import { renderMarketplaceView } from './marketplace.js'; // אם תוסיף את זה

    const viewsCarousel = document.getElementById('views-carousel');
    const navButtons = document.querySelectorAll('.top-nav button');
    const numViews = navButtons.length;
    let currentViewIndex = 0;
    let touchStartX = 0;
    let touchCurrentX = 0;
    let isDragging = false;
    let viewWidth = window.innerWidth;

    // Pre-render all views into the carousel
    const viewRenderers = {
        'connect': renderConnectView,
        'chat': renderChatView,
        'feed': renderFeedView,
        'studio': renderStudioView,
        // 'marketplace': renderMarketplaceView
    };

    navButtons.forEach(button => {
        const viewId = button.dataset.viewId;
        if (viewRenderers[viewId]) {
            const viewElement = viewRenderers[viewId](); // כל פונקציית render מחזירה את אלמנט ה-section
            viewsCarousel.appendChild(viewElement);
        }
    });
    viewsCarousel.style.width = `${numViews * 100}%`;


    function switchView(viewIndex, animate = true) {
        if (viewIndex < 0 || viewIndex >= numViews) return;

        currentViewIndex = viewIndex;
        if (animate) {
            viewsCarousel.style.transition = 'transform .45s cubic-bezier(.25,1,.5,1)';
        } else {
            viewsCarousel.style.transition = 'none';
        }
        viewsCarousel.style.transform = `translateX(${-currentViewIndex * (100 / numViews)}%)`;

        navButtons.forEach((btn) => {
            btn.classList.toggle('active', parseInt(btn.dataset.index) === currentViewIndex);
        });

        // Trigger AOS for the new view
        const currentViewElement = viewsCarousel.children[currentViewIndex];
        if (currentViewElement && window.AOS) {
             // AOS.refreshHard() for elements that are dynamically added
             // Or re-init AOS on specific elements if needed
            setTimeout(() => {
                AOS.refresh(); // Standard refresh might be enough if elements are not re-created
                 // If cards are added dynamically, you might need to re-initialize AOS on them or call refreshHard
                if (currentViewElement.id === 'feed' || currentViewElement.id === 'connect') {
                    AOS.refreshHard(); // For views with dynamically loaded cards
                }
            }, 50); // Delay to ensure content is in place
        }
    }

    navButtons.forEach((btn) => {
        btn.onclick = () => switchView(parseInt(btn.dataset.index));
    });

    function handlePointerDown(e) {
        if (e.target.closest('button, a, canvas, table, .bi-card, .modal')) return;
        isDragging = true;
        touchStartX = e.pageX || e.touches[0].pageX;
        touchCurrentX = touchStartX; // Initialize current X
        viewWidth = window.innerWidth;
        viewsCarousel.style.transition = 'none';
        // Add a class to the body to disable text selection during swipe
        document.body.classList.add('swiping');
    }

    function handlePointerMove(e) {
        if (!isDragging) return;
        touchCurrentX = e.pageX || e.touches[0].pageX;
        const diffX = touchCurrentX - touchStartX;
        // Calculate translateX based on the base position of the current view + drag difference
        const baseTranslateX = -currentViewIndex * viewWidth;
        viewsCarousel.style.transform = `translateX(${baseTranslateX + diffX}px)`;
    }

    function handlePointerUp() {
        if (!isDragging) return;
        isDragging = false;
        document.body.classList.remove('swiping'); // Remove class

        const diffX = touchCurrentX - touchStartX;
        const threshold = viewWidth * 0.20; // Adjusted threshold

        if (diffX < -threshold && currentViewIndex < numViews - 1) {
            switchView(currentViewIndex + 1);
        } else if (diffX > threshold && currentViewIndex > 0) {
            switchView(currentViewIndex - 1);
        } else {
            switchView(currentViewIndex); // Snap back
        }
    }
    
    viewsCarousel.addEventListener('pointerdown', handlePointerDown, { passive: true });
    window.addEventListener('pointermove', handlePointerMove, { passive: true });
    window.addEventListener('pointerup', handlePointerUp);
    window.addEventListener('pointercancel', handlePointerUp); // Also handle pointercancel


    window.addEventListener('resize', () => {
        viewWidth = window.innerWidth;
        switchView(currentViewIndex, false); // Re-align without animation
    });

    // Initialize Particles and AOS
    if (window.tsParticles) {
        tsParticles.load('tsparticles', {
            particles: {
                number: { value: 30, density: { enable: true, value_area: 800 } },
                color: { value: '#ffffff' },
                shape: { type: 'circle' },
                opacity: { value: 0.2, random: true, anim: { enable: false } },
                size: { value: 2, random: true, anim: { enable: false } },
                links: { enable: true, distance: 150, color: 'var(--accent)', opacity: 0.15, width: 1 },
                move: {
                    enable: true, speed: 0.5, direction: 'none', random: true, straight: false, out_mode: 'out', bounce: false
                }
            },
            interactivity: { detect_on: 'canvas', events: { onhover: { enable: false }, onclick: { enable: false } } },
            retina_detect: true,
            fullScreen: { enable: false }
        });
    }

    if (window.AOS) {
        AOS.init({
            once: false, // Allow animation on scroll in different views
            duration: 550,
            offset: 50,
            easing: 'ease-out-quad'
        });
    }
    
    // Load initial view
    switchView(0, false); // Load the first view without animation

  </script>
</body>
</html>
