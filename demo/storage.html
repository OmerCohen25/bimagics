<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Energy Storage Analyzer – v2.0</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f8f9fa; --card:#ffffff; --muted:#6c757d; --text:#212529; --border:#dee2e6;
    --accent:#007bff; --accent-hover:#0056b3; --good:#28a745; --bad:#dc3545; --warn:#ffc107;
    --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    --font-main: 'Rubik', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
  }
  [data-theme="dark"] {
    --bg:#121212; --card:#1e1e1e; --muted:#8892b0; --text:#e6eeff; --border:#343a40;
    --accent:#64a1ff; --accent-hover:#8bbaff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:400 16px/1.5 var(--font-main);-webkit-font-smoothing: antialiased;}
  a{color:var(--accent);text-decoration:none;transition:color .2s}
  a:hover{color:var(--accent-hover)}

  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 0;flex-wrap:wrap}
  .brand{display:flex;align-items:center;gap:12px}
  .brand .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg, var(--accent), #8bbaff);display:grid;place-items:center;color:#fff;font-weight:700;font-size:18px}
  .brand .title{font-size:20px;font-weight:700}
  .brand .subtitle{color:var(--muted);font-size:14px}
  
  .steps{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .step{padding:6px 12px;border-radius:999px;background:transparent;border:1px solid var(--border);color:var(--muted);font-size:14px;transition: all .3s ease;}
  .step.active{color:#fff;background:var(--accent);border-color:var(--accent);font-weight:500}
  .step.done{color:var(--text);background:rgba(40,167,69,0.1);border-color:rgba(40,167,69,0.3)}
  .step.done::before{content:"✔";margin-left:6px;color:var(--good)}

  section.view{display:none;opacity:0;transition:opacity .4s ease-in-out;animation:fadeIn .5s ease forwards}
  section.view.active{display:block;opacity:1}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;box-shadow:var(--shadow)}
  .grid{display:grid;gap:20px}
  @media(min-width:768px){ .grid.cols-2{grid-template-columns:1fr 1fr} .grid.cols-3{grid-template-columns:1fr 1fr 1fr} }
  
  .btn{cursor:pointer;border:0;border-radius:10px;padding:12px 20px;font-weight:500;font-size:16px;font-family:var(--font-main);transition:all .2s;display:inline-flex;align-items:center;justify-content:center;gap:8px}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.primary:hover{background:var(--accent-hover);transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,123,255,0.2)}
  .btn.secondary{background:var(--card);color:var(--text);border:1px solid var(--border)}
  .btn.secondary:hover{background:var(--bg);border-color:var(--muted)}
  .btn .spinner{display:none;width:18px;height:18px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
  .btn.loading .spinner{display:block}
  .btn.loading span{display:none}
  @keyframes spin{to{transform:rotate(360deg)}}
  
  input,select{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-family:var(--font-main);transition:all .2s}
  input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,123,255,0.15)}
  label{display:block;margin-bottom:8px;font-weight:500;color:var(--muted);font-size:14px}
  
  .row{display:flex;gap:16px;flex-wrap:wrap;align-items:center}
  
  .kpi{display:flex;flex-direction:column;gap:8px;padding:16px;border-radius:12px;background:var(--bg);border:1px solid var(--border)}
  .kpi .v{font-size:28px;font-weight:700;color:var(--accent)}
  .kpi .l{font-weight:500;font-size:16px}
  .kpi .f{font-size:13px;color:var(--muted)}

  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:var(--bg);color:var(--muted);font-size:14px}
  canvas{width:100%;height:250px;background:var(--bg);border:1px solid var(--border);border-radius:12px}
  
  .heatmap{display:grid;grid-template-columns:repeat(24,1fr);gap:3px}
  .cell{aspect-ratio:1/1;border-radius:4px;transition:transform .2s}
  .cell:hover{transform:scale(1.2)}
  
  .foot{color:var(--muted);font-size:14px;margin-top:16px}
  .screen-title{font-size:28px;font-weight:700;margin:0 0 8px 0}
  
  #toast-container{position:fixed;top:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:10px}
  .toast{padding:12px 20px;border-radius:10px;color:#fff;box-shadow:var(--shadow);opacity:0;animation:slideIn .3s ease forwards}
  .toast.good{background-color:var(--good)}
  .toast.bad{background-color:var(--bad)}
  @keyframes slideIn{from{opacity:0;transform:translateX(100%)}to{opacity:1;transform:translateX(0)}}

  /* Print styles */
  @media print{
    :root{--bg:#fff; --card:#fff; --muted:#555; --text:#000; --border:#ccc;}
    body{background:var(--bg);color:var(--text)}
    header,.steps,.controls,.hide-on-print{display:none!important}
    .card{border:0;box-shadow:none;padding:0}
    .wrap{max-width:none;padding:0}
    .page{page-break-after:always}
    .print-block{break-inside:avoid;margin:0 0 16px 0}
    .print-title{font-size:20px;font-weight:700;margin-bottom:8px;color:#000}
    .print-table{width:100%;border-collapse:collapse}
    .print-table th,.print-table td{border:1px solid var(--border);padding:8px;font-size:12px;text-align:right}
    .print-table th{background:#f0f0f0;font-weight:500}
    .kpi{background:var(--bg);border:1px solid var(--border)}
    canvas{border:1px solid var(--border)}
  }
</style>
</head>
<body data-theme="light">
  <div id="toast-container"></div>
  <div class="wrap">
    <header class="hide-on-print">
      <div class="brand">
        <div class="logo">ES</div>
        <div>
          <div class="title">Energy Storage Analyzer</div>
          <div class="subtitle">Cloud-Native Demo</div>
        </div>
      </div>
      <div class="steps">
        <div class="step active" id="step_chip_login">1 · התחברות</div>
        <div class="step" id="step_chip_inputs">2 · הגדרות</div>
        <div class="step" id="step_chip_dash">3 · ניתוח</div>
        <div class="step" id="step_chip_pdf">4 · דוח</div>
      </div>
    </header>

    <section class="view active" id="screen_login">
      <div class="card">
        <div class="grid cols-2">
          <div style="display:flex; flex-direction:column; justify-content:center;">
            <h2 class="screen-title">ברוכים הבאים</h2>
            <p class="foot" style="margin-top:0">התחברו באמצעות חשבון גוגל (הדגמה) כדי להתחיל בניתוח מערכת אגירת האנרגיה שלכם.</p>
            <div class="row" style="margin-top:24px">
              <button class="btn primary" id="btnGoogle">
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.64 9.20455C17.64 8.56682 17.5827 7.95273 17.4764 7.36364H9V10.845H13.8436C13.635 11.97 13.0009 12.9232 12.0477 13.5618V15.8195H14.9564C16.6582 14.2527 17.64 11.9464 17.64 9.20455Z" fill="#4285F4"></path><path d="M9 18C11.43 18 13.4673 17.1941 14.9564 15.8195L12.0477 13.5618C11.2418 14.1236 10.2109 14.4582 9 14.4582C6.92727 14.4582 5.14636 13.0836 4.50545 11.2418H1.51773V13.5818C3.00682 16.26 5.79545 18 9 18Z" fill="#34A853"></path><path d="M4.50545 11.2418C4.28864 10.6527 4.17273 10.0218 4.17273 9.36364C4.17273 8.70545 4.28864 8.07455 4.50545 7.48545V5.14545H1.51773C0.543182 7.03545 0 9.12364 0 11.2418C0 13.36 0.543182 15.4482 1.51773 17.3382L4.50545 14.9982V11.2418Z" fill="#FBBC05"></path><path d="M9 3.54182C10.3214 3.54182 11.5077 3.99182 12.4814 4.92182L15.0218 2.38182C13.4632 0.902727 11.4255 0 9 0C5.79545 0 3.00682 1.74 1.51773 4.41818L4.50545 6.75818C5.14636 4.91636 6.92727 3.54182 9 3.54182Z" fill="#EA4335"></path></svg>
                <span>התחברות עם Google</span>
              </button>
              <button class="btn secondary" id="btnSkip">כניסה כאורח</button>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:16px;">
            <div class="kpi"><div class="l">Zero-Install</div><div class="f">רץ במלואו בדפדפן שלך. ללא התקנות או ספריות חיצוניות.</div></div>
            <div class="kpi"><div class="l">ניתוח מתקדם</div><div class="f">הדמיית תרחישים שונים, אופטימיזציה של עלויות וניתוח שימוש.</div></div>
            <div class="kpi"><div class="l">דוח PDF בקליק</div><div class="f">הפקת דוחות מקצועיים למטרות שיווק, תכנון והנדסה.</div></div>
          </div>
        </div>
      </div>
    </section>

    <section class="view" id="screen_inputs">
      <div class="card">
        <h2 class="screen-title">הגדרות הפרויקט</h2>
        <p class="foot" style="margin-top:0">העלו קובץ CSV עם נתוני צריכה ברזולוציה של 15 דקות (עמודות: <code>timestamp,consumption_kwh_15m</code>), או השתמשו בנתוני הדגמה.</p>

        <div class="grid cols-2" style="margin-top:24px">
          <div>
            <label for="csvFile">העלאת קובץ CSV</label>
            <input type="file" id="csvFile" accept=".csv" class="btn secondary" style="width:100%" />
            <div class="row" style="margin-top:8px">
              <button class="btn secondary" id="btnSample">השתמש בנתוני הדגמה</button>
              <div class="pill">שורות שנטענו: <span id="rowsCount">0</span></div>
            </div>
          </div>
          <div>
            <label for="scenario">תרחיש הפעלה</label>
            <select id="scenario">
              <option value="self">צריכה עצמית / אפס ייצוא</option>
              <option value="sell">מכירה לרשת (מודל פשוט)</option>
            </select>
          </div>
        </div>
        <hr style="border:0; border-top:1px solid var(--border); margin:24px 0;">
        <div class="grid cols-3">
          <div><label for="bat_kwh">קיבולת סוללה (kWh)</label><input id="bat_kwh" type="number" min="1" step="0.1" value="10"></div>
          <div><label for="bat_kw">הספק טעינה/פריקה (kW)</label><input id="bat_kw" type="number" min="0.5" step="0.1" value="5"></div>
          <div><label for="soc_min">טעינה מינימלית (SoC %)</label><input id="soc_min" type="number" min="0" max="95" step="1" value="10"></div>
          <div><label for="soc_max">טעינה מקסימלית (SoC %)</label><input id="soc_max" type="number" min="5" max="100" step="1" value="95"></div>
          <div><label for="grid_a">מגבלת חיבור לרשת (A)</label><input id="grid_a" type="number" min="0" step="1" placeholder="לדוגמה: 3x40"></div>
          <div><label for="phase">סוג חיבור</label>
            <select id="phase">
              <option>חד-פאזי</option>
              <option>תלת-פאזי</option>
            </select>
          </div>
        </div>
        <hr style="border:0; border-top:1px solid var(--border); margin:24px 0;">
        <div class="grid cols-2">
          <div>
            <label for="price_peak">תעריף שיא (ש"ח/קוט"ש) – 17:00-22:00</label>
            <input id="price_peak" type="number" min="0" step="0.01" value="1.00">
          </div>
          <div>
            <label for="price_off">תעריף שפל (ש"ח/קוט"ש)</label>
            <input id="price_off" type="number" min="0" step="0.01" value="0.50">
          </div>
        </div>

        <div class="row controls" style="margin-top:24px; justify-content:flex-start">
          <button class="btn primary" id="btnAnalyze">
            <div class="spinner"></div>
            <span>בצע ניתוח</span>
          </button>
          <button class="btn secondary" onclick="goto('login')">חזור</button>
        </div>
      </div>
    </section>

    <section class="view" id="screen_dash">
       <div class="card">
        <div class="row" style="align-items:center;justify-content:space-between">
            <h2 class="screen-title">תוצאות הניתוח</h2>
            <div class="row hide-on-print">
            <button class="btn secondary" onclick="goto('inputs')">עריכת הגדרות</button>
            <button class="btn primary" onclick="goto('pdf')">הכן דוח PDF</button>
            </div>
        </div>

        <div class="grid cols-3" style="margin-top:24px">
            <div class="kpi"><div class="l">חיסכון שנתי צפוי</div><div class="v" id="kpi_savings">–</div><div class="f">בהשוואה לתעריף בסיס</div></div>
            <div class="kpi"><div class="l">הפחתת שיא צריכה</div><div class="v" id="kpi_peak">–</div><div class="f">הפחתה מקסימלית ב-kW</div></div>
            <div class="kpi"><div class="l">ניצולת סוללה</div><div class="v" id="kpi_util">–</div><div class="f">אחוז ניצול הקיבולת</div></div>
        </div>

        <div class="grid cols-2" style="margin-top:20px">
            <div>
            <h3 style="font-weight:500">עומס נטו – יום לדוגמה</h3>
            <canvas id="chartNet"></canvas>
            </div>
            <div>
            <h3 style="font-weight:500">מצב טעינה (SoC) – יום לדוגמה</h3>
            <canvas id="chartSoC"></canvas>
            </div>
        </div>

        <div class="grid cols-1" style="margin-top:20px">
            <div>
              <h3 style="font-weight:500">מפת חום שבועית (ממוצע kW)</h3>
              <div style="display:flex;gap:4px;font-size:12px;color:var(--muted);padding-left:30px; margin-bottom: 5px;">
                <div style="flex:1; text-align:center">00:00</div><div style="flex:1; text-align:center">06:00</div><div style="flex:1; text-align:center">12:00</div><div style="flex:1; text-align:center">18:00</div>
              </div>
              <div style="display:flex;gap:8px">
                <div style="display:flex;flex-direction:column;gap:3px;font-size:10px;color:var(--muted);text-align:right;padding-top:5px;width:25px">
                  <span>א'</span><span>ב'</span><span>ג'</span><span>ד'</span><span>ה'</span><span>ו'</span><span>ש'</span>
                </div>
                <div class="heatmap" id="heatmap" style="flex:1"></div>
              </div>
            </div>
        </div>
      </div>
    </section>

    <section class="view" id="screen_pdf">
      <div class="card">
        <div class="row" style="align-items:center;justify-content:space-between">
            <h2 class="screen-title">תצוגה מקדימה לדוח</h2>
            <div class="row hide-on-print">
                <button class="btn secondary" onclick="goto('dash')">חזרה לניתוח</button>
                <button class="btn primary" onclick="window.print()">הדפס / שמור כ-PDF</button>
            </div>
        </div>
        <p class="foot" style="margin-top:0">הדוח משתמש בפורמט הדפסה נקי. הגרפים והטבלאות יופיעו בפריסה מיטבית.</p>

        <div id="pdf_container" class="grid cols-2" style="margin-top:24px; background:white; color:black; padding:16px; border-radius:12px;">
            <div class="print-block">
            <div class="print-title">סיכום הגדרות הפרויקט</div>
            <table class="print-table"><tbody id="pdf_inputs"></tbody></table>
            </div>
            <div class="print-block">
            <div class="print-title">מדדי ביצועים מרכזיים (KPIs)</div>
            <table class="print-table"><tbody id="pdf_kpis"></tbody></table>
            </div>
            <div class="print-block">
            <div class="print-title">עומס נטו (יום לדוגמה)</div>
            <img id="img_net" alt="Net Load Chart" style="width:100%;border:1px solid #ccc;border-radius:6px"/>
            </div>
            <div class="print-block">
            <div class="print-title">מצב טעינה (יום לדוגמה)</div>
            <img id="img_soc" alt="SoC Chart" style="width:100%;border:1px solid #ccc;border-radius:6px"/>
            </div>
            <div class="print-block" style="grid-column: 1 / -1;">
              <div class="print-title">מפת חום שבועית (kW)</div>
              <div id="img_heat" style="border:1px solid #ccc;border-radius:6px;overflow:hidden"></div>
            </div>
        </div>
      </div>
    </section>
  </div>

<script>
'use strict';
/* --------------------------
   State & Global Helpers
---------------------------*/
const state = {
  user: {name:null,email:null},
  rows: [], // [{ts:Date, kwh: number}]
  params: {},
  results: null,
};
const $ = (id)=>document.getElementById(id);

function goto(screenId){
  document.querySelectorAll('section.view').forEach(s => s.classList.remove('active'));
  $(`screen_${screenId}`).classList.add('active');
  updateStepChips(screenId);
  if(screenId==='pdf' && state.results) preparePdf();
}

function updateStepChips(activeScreen){
  const order=['login','inputs','dash','pdf'];
  const activeIndex = order.indexOf(activeScreen);
  order.forEach((screen, index) => {
    const chip = $(`step_chip_${screen}`);
    chip.classList.remove('active', 'done');
    if (index < activeIndex) chip.classList.add('done');
    else if (index === activeIndex) chip.classList.add('active');
  });
}

function showToast(message, type = 'good') {
    const container = $('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

/* --------------------------
   Screen 1: Login
---------------------------*/
$('btnGoogle').onclick = ()=>{
  state.user = {name:'דנה כהן', email:'dana.c@example.com'};
  showToast(`התחברת בהצלחה, ${state.user.name}`);
  setTimeout(()=>goto('inputs'), 500);
};
$('btnSkip').onclick = ()=>{
  state.user = {name:'משתמש אורח', email:'guest@example.com'};
  showToast('נכנסת במצב אורח.');
  setTimeout(()=>goto('inputs'), 500);
};

/* --------------------------
   Screen 2: Inputs & CSV
---------------------------*/
$('csvFile').addEventListener('change', async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try {
    const text = await file.text();
    loadCsv(text);
    showToast('קובץ CSV נטען בהצלחה.');
  } catch (err) {
    showToast('שגיאה בקריאת הקובץ.', 'bad');
  }
});

$('btnSample').onclick = ()=>{
  const start = new Date('2025-06-02T00:00:00'); // Monday
  const rows=[];
  const days=14, stepsPerDay=96;
  for(let d=0;d<days;d++){
    for(let i=0;i<stepsPerDay;i++){
      const ts=new Date(start.getTime()+ (d*24*60 + i*15)*60000);
      const hour = ts.getHours()+ts.getMinutes()/60;
      const base = 0.6 + 0.4*Math.sin((hour-7)*Math.PI/12)**2;
      const evening = 0.8*Math.max(0, Math.sin((hour-17)*Math.PI/4))**2;
      const noise = (Math.random()-0.5)*0.1;
      const kwh15 = Math.max(0.05, base*0.35 + evening*0.5 + noise);
      rows.push({ts, kwh:kwh15});
    }
  }
  state.rows=rows;
  $('rowsCount').textContent=state.rows.length.toLocaleString();
  showToast('נתוני הדגמה נטענו (14 ימים).');
};

function loadCsv(text){
  const lines = text.split(/\r?\n/).filter(Boolean);
  if(lines.length < 2) throw new Error('CSV has no data');
  const header = lines[0].toLowerCase().split(',').map(s=>s.trim());
  const tIdx = header.indexOf('timestamp');
  const cIdx = header.indexOf('consumption_kwh_15m');
  if(tIdx < 0 || cIdx < 0) throw new Error('Header must include timestamp,consumption_kwh_15m');
  
  const out=lines.slice(1).map(line => {
    const cols = line.split(',');
    const ts = new Date(cols[tIdx]);
    const kwh = parseFloat(cols[cIdx]);
    if(!isFinite(ts.getTime()) || !isFinite(kwh)) return null;
    return {ts, kwh};
  }).filter(Boolean);

  out.sort((a,b)=>a.ts-b.ts);
  state.rows=out;
  $('rowsCount').textContent=state.rows.length.toLocaleString();
}

/* --------------------------
   Analysis Trigger
---------------------------*/
function readInputs(){
  const n = (v,def) => { const x=parseFloat(v); return isFinite(x)?x:def; };
  state.params = {
    scenario : $('scenario').value,
    bat_kwh : n($('bat_kwh').value,10),
    bat_kw  : n($('bat_kw').value,5),
    soc_min : n($('soc_min').value,10)/100,
    soc_max : n($('soc_max').value,95)/100,
    grid_a  : $('grid_a').value? n($('grid_a').value,0):null,
    phase   : $('phase').value,
    price_peak : n($('price_peak').value,1),
    price_off  : n($('price_off').value,0.5),
  };
}

$('btnAnalyze').onclick = () => {
  if(!state.rows.length){
    showToast('יש לטעון נתונים לפני ביצוע ניתוח.', 'bad');
    return;
  }
  readInputs();
  
  const btn = $('btnAnalyze');
  btn.classList.add('loading');
  btn.disabled = true;

  // Allow UI to update before heavy computation
  setTimeout(() => {
    try {
      state.results = analyze(state.rows, state.params);
      renderDashboard(state.results);
      showToast('הניתוח הושלם בהצלחה!');
      goto('dash');
    } catch(err) {
      showToast(`שגיאה בניתוח: ${err.message}`, 'bad');
    } finally {
      btn.classList.remove('loading');
      btn.disabled = false;
    }
  }, 50); 
};

/* --------------------------
   Core Analysis Logic
---------------------------*/
function analyze(rows, p){
    const stepHrs=0.25;
    let baselineCost=0, energyKwh=0;
    let soc = p.bat_kwh * p.soc_min; 
    const socMin = p.bat_kwh * p.soc_min, socMax = p.bat_kwh * p.soc_max;
    const etaC=0.95, etaD=0.95;

    const dayIdx = d => new Date(d.ts.getFullYear(),d.ts.getMonth(),d.ts.getDate()).getTime();
    const groups = rows.reduce((acc, r) => {
        const key = dayIdx(r);
        (acc[key]||(acc[key]=[])).push(r);
        return acc;
    }, {});
    const days = Object.values(groups).sort((a,b) => a[0].ts - b[0].ts);
    const dayTotals = days.map(d=>d.reduce((s,r)=>s+r.kwh,0));
    const medianIdx = dayTotals.indexOf([...dayTotals].sort((a,b)=>a-b)[Math.floor(dayTotals.length/2)]);
    const sampleDay = days[Math.max(0, medianIdx)];

    const series = { time:[], baseKw:[], netKw:[], soc:[] };
    let newCost=0, peakBase=0, peakNew=0, utilSum=0, utilSteps=0;

    for(const r of rows){
        const hour = r.ts.getHours() + r.ts.getMinutes()/60;
        const isPeak = (hour>=17 && hour<22);
        const price = isPeak? p.price_peak : p.price_off;
        baselineCost += price * r.kwh;
        energyKwh += r.kwh;

        const loadKw = r.kwh/stepHrs;
        let chargeKw=0, dischargeKw=0;

        if(isPeak){
            dischargeKw = Math.min(p.bat_kw, loadKw, (soc - socMin)/(stepHrs/etaD));
        }else{
            chargeKw = Math.min(p.bat_kw, (socMax - soc)/(etaC*stepHrs));
        }

        soc += etaC*chargeKw*stepHrs - (dischargeKw/etaD)*stepHrs;
        soc = Math.max(socMin, Math.min(socMax, soc));
        let netKw = loadKw - dischargeKw + chargeKw;

        if(p.scenario==='sell' && isPeak){
            const extra = Math.min(p.bat_kw - dischargeKw, (soc - socMin)/(stepHrs/etaD));
            dischargeKw += extra;
            soc -= (extra/etaD)*stepHrs;
            netKw = Math.max(0, netKw - extra);
            newCost -= p.price_peak * extra*stepHrs;
        }

        newCost += price * Math.max(0, netKw*stepHrs);
        peakBase = Math.max(peakBase, loadKw);
        peakNew  = Math.max(peakNew, netKw);
        if(chargeKw>0 || dischargeKw>0){ utilSum += (chargeKw+dischargeKw)/(2*p.bat_kw); utilSteps++; }

        if(r.ts>=sampleDay[0].ts && r.ts<=sampleDay[sampleDay.length-1].ts){
            series.time.push(r.ts);
            series.baseKw.push(loadKw);
            series.netKw.push(netKw);
            series.soc.push(soc/p.bat_kwh*100);
        }
    }

    const msInWeek = 1000*60*60*24*7;
    const weeks = (rows[rows.length-1].ts - rows[0].ts) / msInWeek;
    const annualFactor = weeks > 0 ? (52/weeks) : 1;
    
    const kpis = {
        savings_annual: (baselineCost - newCost) * annualFactor,
        peak_shave: Math.max(0, peakBase - peakNew),
        util_pct: utilSteps? (100*Math.min(1, utilSum/utilSteps)) : 0,
        baseline_annual_cost: baselineCost*annualFactor,
        new_annual_cost: newCost*annualFactor,
        energy_kwh: energyKwh*annualFactor
    };
    
    const heat = Array(7).fill(0).map(()=>Array(24).fill(0));
    const counts = Array(7).fill(0).map(()=>Array(24).fill(0));
    rows.forEach(r => {
        const d = (r.ts.getDay() + 6) % 7; // Mon=0, Sun=6
        const h = r.ts.getHours();
        heat[d][h] += r.kwh/stepHrs;
        counts[d][h]++;
    });
    heat.forEach((row,d) => row.forEach((_,h) => { if(counts[d][h]) heat[d][h]/=counts[d][h]; }));

    return { kpis, sampleSeries:series, heat, params: {...p}, user:{...state.user} };
}


/* --------------------------
   Dashboard & Chart Rendering
---------------------------*/
function renderDashboard(res){
  const fmt = (n) => n.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  $('kpi_savings').textContent = '₪ ' + fmt(res.kpis.savings_annual);
  $('kpi_peak').textContent    = res.kpis.peak_shave.toFixed(2)+' kW';
  $('kpi_util').textContent    = res.kpis.util_pct.toFixed(0)+'%';

  const timeLabels = res.sampleSeries.time.map(t=>t.toTimeString().slice(0,5));
  drawLineChart('chartNet', timeLabels, [
      {name:'צריכה בסיסית (kW)', data:res.sampleSeries.baseKw, color:'rgba(0,123,255,0.2)', borderColor: 'rgba(0,123,255,1)'},
      {name:'צריכה עם סוללה (kW)', data:res.sampleSeries.netKw, color:'rgba(40,167,69,0.2)', borderColor: 'rgba(40,167,69,1)'},
  ]);
  drawLineChart('chartSoC', timeLabels, [
      {name:'SoC %', data:res.sampleSeries.soc, color:'rgba(255,193,7,0.2)', borderColor: 'rgba(255,193,7,1)'}
  ]);
  renderHeatmap('heatmap', res.heat);
}

function drawLineChart(canvasId, labels, seriesList){
    const c=$(canvasId); const ctx=c.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const w=c.clientWidth, h=c.clientHeight;
    c.width = w * dpr; c.height = h * dpr;
    ctx.scale(dpr, dpr);

    const pad = {t:20, b:30, l:45, r:10};
    const chartW = w-pad.l-pad.r, chartH = h-pad.t-pad.b;

    let min=Infinity, max=-Infinity;
    seriesList.forEach(s=>s.data.forEach(v=>{ min=Math.min(min,v); max=Math.max(max,v); }));
    if(!isFinite(min)||!isFinite(max)){ min=0; max=100; }
    if(max-min<1e-6) max = min+1;
    const rangePad = (max-min)*0.1;
    min-=rangePad; max+=rangePad;

    const mapX = (i) => pad.l + i/(labels.length-1) * chartW;
    const mapY = (v) => pad.t + chartH - (v-min)/(max-min) * chartH;
    
    // Y-axis grid and labels
    ctx.font = '12px ' + getComputedStyle(document.body).fontFamily;
    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--muted');
    ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--border');
    ctx.lineWidth = 1;
    const ticks = 5;
    for(let i=0; i<=ticks; i++){
        const val = min + i/ticks * (max-min);
        const y = mapY(val);
        ctx.beginPath();
        ctx.moveTo(pad.l, y); ctx.lineTo(pad.l+chartW, y);
        ctx.stroke();
        ctx.textAlign = 'right';
        ctx.fillText(val.toFixed(1), pad.l-8, y+4);
    }
    
    // X-axis labels
    const xLabelSkip = Math.ceil(labels.length / (chartW / 70));
    for(let i=0; i<labels.length; i+=xLabelSkip){
        const x = mapX(i);
        ctx.textAlign = 'center';
        ctx.fillText(labels[i], x, h-10);
    }

    // Draw lines
    seriesList.forEach(s => {
        ctx.strokeStyle = s.borderColor;
        ctx.lineWidth = 2;
        ctx.beginPath();
        s.data.forEach((v,i) => {
            if(i===0) ctx.moveTo(mapX(i), mapY(v));
            else ctx.lineTo(mapX(i), mapY(v));
        });
        ctx.stroke();
    });
}


function renderHeatmap(containerId, M){
  const el=$(containerId);
  el.innerHTML='';
  let max=0; M.forEach(row => row.forEach(v => max=Math.max(max,v)));
  const days = ['א','ב','ג','ד','ה','ו','ש'];
  M.forEach((row, d) => {
    row.forEach((v,h) => {
      const norm = v / (max||1);
      const cell=document.createElement('div');
      cell.className='cell';
      const hue = 220 - Math.round(180*norm);
      const alpha = 0.1 + 0.9*norm**0.8;
      cell.style.background = `hsla(${hue}, 85%, 60%, ${alpha})`;
      cell.title = `יום ${days[d]}, שעה ${h}:00 — ${v.toFixed(2)} kW`;
      el.appendChild(cell);
    });
  });
}

/* --------------------------
   PDF Preparation
---------------------------*/
function preparePdf(){
  const {params:p, user:u, kpis:r} = state.results;
  const fmt = (n,d=0) => (n??0).toFixed(d).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  const inputs = [
    ['שם משתמש', `${u.name||'-'} (${u.email||'-'})`],
    ['תרחיש', p.scenario==='self' ? 'צריכה עצמית' : 'מכירה לרשת'],
    ['סוללה', `${p.bat_kwh} kWh / ${p.bat_kw} kW`],
    ['טווח טעינה', `${Math.round(p.soc_min*100)}% – ${Math.round(p.soc_max*100)}%`],
    ['חיבור לרשת', p.grid_a ? `${p.grid_a}A (${p.phase})` : p.phase],
    ['תעריפים', `שיא ₪${p.price_peak}/קוט"ש, שפל ₪${p.price_off}/קוט"ש`]
  ];
  $('pdf_inputs').innerHTML = inputs.map(([k,v])=>`<tr><th>${k}</th><td>${v}</td></tr>`).join('');

  const kpis = [
    ['חיסכון שנתי', '₪ '+fmt(r.savings_annual)],
    ['עלות שנתית בסיסית', '₪ '+fmt(r.baseline_annual_cost)],
    ['עלות שנתית חדשה', '₪ '+fmt(r.new_annual_cost)],
    ['צריכה שנתית', fmt(r.energy_kwh)+' kWh'],
    ['הפחתת שיא', fmt(r.peak_shave,2)+' kW'],
    ['ניצולת סוללה', fmt(r.util_pct)+'%'],
  ];
  $('pdf_kpis').innerHTML = kpis.map(([k,v])=>`<tr><th>${k}</th><td>${v}</td></tr>`).join('');

  $('img_net').src = $('chartNet').toDataURL('image/png');
  $('img_soc').src = $('chartSoC').toDataURL('image/png');
  const heatClone = $('heatmap').parentNode.cloneNode(true);
  $('img_heat').innerHTML=''; $('img_heat').appendChild(heatClone);
}


/* --------------------------
   Initialization
---------------------------*/
window.addEventListener('DOMContentLoaded', ()=>{
  $('btnSample').click();
  // could add dark mode toggle here
  // document.documentElement.setAttribute('data-theme', 'dark');
});
</script>
</body>
</html>

