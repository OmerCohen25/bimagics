<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Energy Storage Analyzer – Demo (Single HTML)</title>
<style>
  :root{
    --bg:#0b1020; --card:#131a32; --muted:#8892b0; --text:#e6eeff;
    --accent:#64ffda; --accent2:#8be9fd; --good:#1ecb8a; --bad:#ff6b6b; --warn:#ffd166;
  }
  *{box-sizing:border-box} html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:500 16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  a{color:var(--accent);text-decoration:none}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 0}
  .brand{display:flex;align-items:center;gap:10px}
  .brand .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:grid;place-items:center;color:#0b1020;font-weight:900}
  .steps{display:flex;gap:8px;flex-wrap:wrap}
  .step{padding:8px 12px;border-radius:999px;background:#0e1430;border:1px solid #1f2c58;color:var(--muted)}
  .step.active{color:#0b1020;background:var(--accent);border-color:transparent}
  .step.done{color:#0b1020;background:#9fffe2;border-color:transparent}
  .card{background:var(--card);border:1px solid #22305e;border-radius:16px;padding:16px}
  .grid{display:grid;gap:16px}
  @media(min-width:900px){ .grid.cols-2{grid-template-columns:1fr 1fr} .grid.cols-3{grid-template-columns:1fr 1fr 1fr} }
  button, .btn{cursor:pointer;border:0;border-radius:12px;padding:12px 16px;background:var(--accent);color:#0b1020;font-weight:700}
  button.secondary{background:#1a254a;color:var(--text);border:1px solid #2b3b78}
  button.ghost{background:transparent;border:1px dashed #2b3b78;color:var(--muted)}
  input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #2b3b78;background:#0f1736;color:var(--text)}
  label{display:block;margin:8px 0 6px;color:#b6c2e0}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .row>div{flex:1 1 240px}
  .hide{display:none}
  .kpi{display:flex;flex-direction:column;gap:6px;padding:12px;border-radius:12px;background:#0f1736;border:1px solid #22305e}
  .kpi .v{font-size:24px;font-weight:800}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid #2b3b78;background:#0f1736;color:#b6c2e0}
  canvas{width:100%;height:220px;background:#0f1736;border:1px solid #22305e;border-radius:12px}
  .heatmap{display:grid;grid-template-columns:repeat(24, minmax(8px,1fr));gap:2px}
  .cell{aspect-ratio:1/1;border-radius:4px}
  .foot{color:var(--muted);font-size:13px}
  /* printable report */
  @media print{
    body{background:#fff;color:#000}
    header,.steps,.controls,.hide-on-print{display:none!important}
    .card{border:0}
    .wrap{max-width:none}
    .page{page-break-after:always}
    .print-block{break-inside:avoid;margin:0 0 16px 0}
    .print-title{font-size:22px;font-weight:900;margin:8px 0}
    .print-table{width:100%;border-collapse:collapse}
    .print-table th,.print-table td{border:1px solid #ccc;padding:6px 8px;font-size:12px}
    .kpi{background:#fff;border:1px solid #ccc}
    canvas{border:1px solid #ccc}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header class="hide-on-print">
      <div class="brand">
        <div class="logo">ES</div>
        <div>
          <div style="font-weight:900">Energy Storage Analyzer</div>
          <div style="color:var(--muted);font-size:13px">Cloud-Native · Single-File Demo</div>
        </div>
      </div>
      <div class="steps">
        <div class="step active" id="step_chip_login">1 · Sign in</div>
        <div class="step" id="step_chip_inputs">2 · Inputs</div>
        <div class="step" id="step_chip_dash">3 · Dashboard</div>
        <div class="step" id="step_chip_pdf">4 · PDF</div>
      </div>
    </header>

    <!-- SCREEN 1: LOGIN -->
    <section class="card" id="screen_login">
      <div class="grid cols-2">
        <div>
          <h2 style="margin:0 0 8px 0">Welcome</h2>
          <p class="foot">Use the simulated Google Sign-In to continue. In production this will use real OIDC; here it’s a simple demo.</p>
          <div class="row" style="margin-top:16px">
            <div><label>Full name</label><input id="fullName" placeholder="e.g., Dana Cohen" /></div>
            <div><label>Email</label><input id="email" placeholder="e.g., dana@example.com" type="email" /></div>
          </div>
          <div class="row" style="margin-top:12px">
            <button id="btnGoogle">Sign in with Google</button>
            <button class="secondary" id="btnSkip">Skip (demo user)</button>
          </div>
          <p id="loginStatus" class="foot" style="margin-top:10px"></p>
        </div>
        <div>
          <div class="kpi"><div class="v">Zero-install</div><div>Runs fully in your browser. No external libraries.</div></div>
          <div class="kpi"><div class="v">Multi-role</div><div>Sales • Planning • End-customer flows.</div></div>
          <div class="kpi"><div class="v">One-click PDF</div><div>Marketing + Engineering report variants.</div></div>
        </div>
      </div>
      <div class="row hide-on-print" style="margin-top:16px">
        <button class="ghost" onclick="goto('inputs')">Preview next step →</button>
      </div>
    </section>

    <!-- SCREEN 2: INPUTS -->
    <section class="card hide" id="screen_inputs">
      <h2 style="margin:0 0 8px 0">Project Inputs</h2>
      <p class="foot">Upload a 15-minute interval CSV (headers: <code>timestamp,consumption_kwh_15m</code>). Or use sample data.</p>

      <div class="grid cols-2">
        <div>
          <label>Upload CSV</label>
          <input type="file" id="csvFile" accept=".csv" />
          <div class="row" style="margin-top:8px">
            <button class="secondary" id="btnSample">Use sample data</button>
            <div class="pill">Rows loaded: <span id="rowsCount">0</span></div>
          </div>
        </div>
        <div>
          <label>Scenario</label>
          <select id="scenario">
            <option value="self">Self-Use / Zero-Export</option>
            <option value="sell">Sell-to-Grid (toy model)</option>
          </select>
        </div>
      </div>

      <div class="grid cols-3" style="margin-top:12px">
        <div><label>Battery capacity (kWh)</label><input id="bat_kwh" type="number" min="1" step="0.1" value="10"></div>
        <div><label>Charge/Discharge power (kW)</label><input id="bat_kw" type="number" min="0.5" step="0.1" value="5"></div>
        <div><label>Min SoC (%)</label><input id="soc_min" type="number" min="0" max="95" step="1" value="10"></div>
        <div><label>Max SoC (%)</label><input id="soc_max" type="number" min="5" max="100" step="1" value="95"></div>
        <div><label>Grid limit (A) – optional</label><input id="grid_a" type="number" min="0" step="1" placeholder="e.g., 3x40A"></div>
        <div><label>Phase</label>
          <select id="phase">
            <option>Single-phase</option>
            <option>Three-phase</option>
          </select>
        </div>
      </div>

      <div class="grid cols-2" style="margin-top:12px">
        <div>
          <label>Peak price (₪/kWh) – 17:00-22:00</label>
          <input id="price_peak" type="number" min="0" step="0.01" value="1.00">
        </div>
        <div>
          <label>Off-peak price (₪/kWh)</label>
          <input id="price_off" type="number" min="0" step="0.01" value="0.50">
        </div>
      </div>

      <div class="row controls" style="margin-top:14px">
        <button id="btnAnalyze">Analyze</button>
        <button class="secondary" onclick="goto('login')">← Back</button>
        <button class="ghost" onclick="goto('dash')">Skip to dashboard</button>
      </div>
      <p id="inputStatus" class="foot" style="margin-top:8px"></p>
    </section>

    <!-- SCREEN 3: DASHBOARD -->
    <section class="card hide" id="screen_dash">
      <div class="row" style="align-items:center;justify-content:space-between">
        <h2 style="margin:0">Dashboard</h2>
        <div class="row hide-on-print">
          <button class="secondary" onclick="goto('inputs')">Edit Inputs</button>
          <button onclick="goto('pdf')">Prepare PDF →</button>
        </div>
      </div>

      <div class="grid cols-3" style="margin-top:8px">
        <div class="kpi"><div>Annualized Savings</div><div class="v" id="kpi_savings">–</div><div class="foot">vs. baseline tariff</div></div>
        <div class="kpi"><div>Peak Shaving</div><div class="v" id="kpi_peak">–</div><div class="foot">Max kW reduced</div></div>
        <div class="kpi"><div>Battery Utilization</div><div class="v" id="kpi_util">–</div><div class="foot">% of capacity used</div></div>
      </div>

      <div class="grid cols-2" style="margin-top:12px">
        <div>
          <div class="row" style="justify-content:space-between;align-items:center">
            <div class="pill">Net Load – sample day</div>
            <div class="foot">consumption vs. with battery</div>
          </div>
          <canvas id="chartNet"></canvas>
        </div>
        <div>
          <div class="row" style="justify-content:space-between;align-items:center">
            <div class="pill">State of Charge – sample day</div>
            <div class="foot">SoC profile</div>
          </div>
          <canvas id="chartSoC"></canvas>
        </div>
      </div>

      <div class="grid cols-1" style="margin-top:12px">
        <div>
          <div class="row" style="justify-content:space-between;align-items:center">
            <div class="pill">Weekly Heatmap (avg kW)</div>
            <div class="foot">0–24h × 7d</div>
          </div>
          <div class="heatmap" id="heatmap"></div>
        </div>
      </div>

      <div class="row hide-on-print" style="margin-top:14px">
        <button onclick="goto('pdf')">Generate PDF →</button>
      </div>
    </section>

    <!-- SCREEN 4: PDF PREVIEW / PRINT -->
    <section class="card hide" id="screen_pdf">
      <h2 style="margin:0 0 8px 0">Report (Preview)</h2>
      <p class="foot">Click “Print / Save as PDF”. The report uses a clean print stylesheet and embeds your charts as images.</p>

      <div id="pdf_container" class="grid cols-2">
        <div class="print-block">
          <div class="print-title">Project Summary</div>
          <table class="print-table">
            <tbody id="pdf_inputs"></tbody>
          </table>
        </div>
        <div class="print-block">
          <div class="print-title">KPIs</div>
          <table class="print-table">
            <tbody id="pdf_kpis"></tbody>
          </table>
        </div>
        <div class="print-block">
          <div class="print-title">Net Load (Sample Day)</div>
          <img id="img_net" alt="Net Load Chart" style="width:100%;border:1px solid #ccc;border-radius:6px"/>
        </div>
        <div class="print-block">
          <div class="print-title">State of Charge (Sample Day)</div>
          <img id="img_soc" alt="SoC Chart" style="width:100%;border:1px solid #ccc;border-radius:6px"/>
        </div>
        <div class="print-block">
          <div class="print-title">Weekly Heatmap</div>
          <div id="img_heat" style="border:1px solid #ccc;border-radius:6px;overflow:hidden"></div>
        </div>
      </div>

      <div class="row hide-on-print" style="margin-top:14px">
        <button class="secondary" onclick="goto('dash')">← Back to Dashboard</button>
        <button onclick="window.print()">Print / Save as PDF</button>
      </div>
    </section>

  </div>

<script>
/* --------------------------
   State & helpers
---------------------------*/
const state = {
  user: {name:null,email:null},
  rows: [], // [{ts:Date, kwh: number}] at 15-min resolution
  params: {
    scenario:'self', bat_kwh:10, bat_kw:5, soc_min:0.1, soc_max:0.95,
    price_peak:1.0, price_off:0.5, grid_a:null, phase:'Single-phase',
  },
  results: null, // filled after analyze()
};

// simple selector
const $ = (id)=>document.getElementById(id);

function setStep(active){
  const chips = [
    ['login','step_chip_login'],
    ['inputs','step_chip_inputs'],
    ['dash','step_chip_dash'],
    ['pdf','step_chip_pdf']
  ];
  chips.forEach(([key,chip])=>{
    const el=$(chip);
    el.classList.remove('active','done');
    if(key===active) el.classList.add('active');
  });
  // mark done for previous
  const order=['login','inputs','dash','pdf'];
  const idx=order.indexOf(active);
  for(let i=0;i<idx;i++){ $( 'step_chip_'+order[i] ).classList.add('done'); }
}
function goto(screen){
  ['login','inputs','dash','pdf'].forEach(s=>$('#screen_'+s).classList.add('hide'));
  $('#screen_'+screen).classList.remove('hide');
  setStep(screen);
  if(screen==='pdf') preparePdf();
}

/* --------------------------
   Login (simulated)
---------------------------*/
$('btnGoogle').onclick = ()=>{
  const name = $('fullName').value.trim()||'Demo User';
  const email = $('email').value.trim()||'demo@example.com';
  state.user = {name,email};
  $('loginStatus').textContent = `Signed in as ${name} (${email}).`;
  setTimeout(()=>goto('inputs'), 300);
};
$('btnSkip').onclick = ()=>{
  state.user = {name:'Demo User',email:'demo@example.com'};
  $('loginStatus').textContent = `Signed in (demo).`;
  setTimeout(()=>goto('inputs'), 300);
};

/* --------------------------
   CSV parsing
---------------------------*/
$('csvFile').addEventListener('change', async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  const text = await file.text();
  loadCsv(text);
});
$('btnSample').onclick = ()=>{
  const start = new Date('2025-06-02T00:00:00'); // Monday
  // generate 14 days * 96 intervals with a diurnal + randomness pattern
  const rows=[];
  const days=14, stepsPerDay=96;
  for(let d=0;d<days;d++){
    for(let i=0;i<stepsPerDay;i++){
      const ts=new Date(start.getTime()+ (d*24*60 + i*15)*60000);
      const hour = ts.getHours()+ts.getMinutes()/60;
      const base = 0.6 + 0.4*Math.sin((hour-7)*Math.PI/12)**2; // day shape
      const evening = 0.8*Math.max(0, Math.sin((hour-17)*Math.PI/4))**2; // peak 17-22
      const noise = (Math.random()-0.5)*0.1;
      const kwh15 = Math.max(0.05, base*0.35 + evening*0.5 + noise); // 0.05..~0.9 kWh/15m
      rows.push({ts, kwh:kwh15});
    }
  }
  state.rows=rows;
  $('rowsCount').textContent=state.rows.length.toLocaleString();
  $('inputStatus').textContent='Loaded sample data (14 days).';
};

function loadCsv(text){
  // naive CSV: expects header "timestamp,consumption_kwh_15m"
  const lines = text.split(/\r?\n/).filter(Boolean);
  if(lines.length<2){ alert('CSV has no data'); return; }
  const header = lines[0].toLowerCase().split(',').map(s=>s.trim());
  const tIdx = header.indexOf('timestamp');
  const cIdx = header.indexOf('consumption_kwh_15m');
  if(tIdx<0 || cIdx<0){
    alert('Header must include timestamp,consumption_kwh_15m');
    return;
  }
  const out=[];
  for(let i=1;i<lines.length;i++){
    const cols = safeSplit(lines[i]);
    if(cols.length<=Math.max(tIdx,cIdx)) continue;
    const ts = new Date(cols[tIdx]);
    const kwh = parseFloat(cols[cIdx]);
    if(!isFinite(ts.getTime()) || !isFinite(kwh)) continue;
    out.push({ts, kwh});
  }
  // sort + dedupe
  out.sort((a,b)=>a.ts-b.ts);
  state.rows=out;
  $('rowsCount').textContent=state.rows.length.toLocaleString();
  $('inputStatus').textContent='CSV loaded.';
}
function safeSplit(line){
  // handle commas inside quotes (very light)
  const res=[]; let cur=''; let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='\"'){ inQ=!inQ; continue; }
    if(ch===',' && !inQ){ res.push(cur); cur=''; continue; }
    cur+=ch;
  }
  res.push(cur);
  return res.map(s=>s.trim());
}

/* --------------------------
   Inputs → analyze
---------------------------*/
function readInputs(){
  state.params.scenario = $('scenario').value;
  state.params.bat_kwh = n($('bat_kwh').value,10);
  state.params.bat_kw  = n($('bat_kw').value,5);
  state.params.soc_min = n($('soc_min').value,10)/100;
  state.params.soc_max = n($('soc_max').value,95)/100;
  state.params.grid_a  = $('grid_a').value? n($('grid_a').value,0):null;
  state.params.phase   = $('phase').value;
  state.params.price_peak = n($('price_peak').value,1);
  state.params.price_off  = n($('price_off').value,0.5);
}
function n(v,def){ const x=parseFloat(v); return Number.isFinite(x)?x:def; }

$('btnAnalyze').onclick = ()=>{
  readInputs();
  if(!state.rows.length){ alert('Please load CSV or use sample data'); return; }
  state.results = analyze(state.rows, state.params);
  $('inputStatus').textContent = 'Analysis completed.';
  renderDashboard(state.results);
  goto('dash');
};

/* --------------------------
   Core analysis (toy but realistic)
---------------------------*/
function analyze(rows, p){
  // 1) baseline cost with simple TOU: peak 17–22
  const stepHrs=0.25;
  let baselineCost=0, energyKwh=0;
  // battery model
  let soc = p.bat_kwh * p.soc_min; const socMin = p.bat_kwh*p.soc_min, socMax=p.bat_kwh*p.soc_max;
  const etaC=0.95, etaD=0.95;
  const dayIdx = d=> new Date(d.ts.getFullYear(),d.ts.getMonth(),d.ts.getDate()).getTime();
  const groups = groupBy(rows, r=>dayIdx(r));
  const days = Object.keys(groups).sort().map(k=>groups[k]);
  // pick a representative day (the median total consumption day)
  const dayTotals = days.map(d=>d.reduce((s,r)=>s+r.kwh,0));
  const medianIdx = dayTotals.indexOf([...dayTotals].sort((a,b)=>a-b)[Math.floor(dayTotals.length/2)]);
  const sampleDay = days[Math.max(0, medianIdx)];

  // per-interval arrays for sample day charts
  const series = { time:[], baseKw:[], netKw:[], soc:[] };

  let newCost=0, peakBase=0, peakNew=0, utilSum=0, utilSteps=0;
  for(const r of rows){
    const hour = r.ts.getHours() + r.ts.getMinutes()/60;
    const isPeak = (hour>=17 && hour<22);
    const price = isPeak? p.price_peak : p.price_off;
    baselineCost += price * r.kwh;
    energyKwh += r.kwh;

    // naive policy:
    // - if peak hour -> discharge to shave up to bat_kw and demand (can't export in self-use)
    // - if off-peak -> charge up to bat_kw
    // sell-to-grid: allow export (very simplified)
    const loadKw = r.kwh/stepHrs; // kW
    let chargeKw=0, dischargeKw=0;

    if(isPeak){
      // try to cover up to loadKw
      dischargeKw = Math.min(p.bat_kw, loadKw, (soc - socMin)/(stepHrs/etaD));
    }else{
      // charge until socMax
      chargeKw = Math.min(p.bat_kw, (socMax - soc)/(etaC*stepHrs));
    }

    // update SoC
    soc += etaC*chargeKw*stepHrs - (dischargeKw/etaD)*stepHrs;
    soc = Math.min(socMax, Math.max(socMin, soc));

    let netKw = loadKw - dischargeKw + chargeKw; // resulting grid import
    if(p.scenario==='sell' && isPeak){
      // assume we may export beyond load if battery still has room to discharge
      const extra = Math.min(p.bat_kw - dischargeKw, (soc - socMin)/(stepHrs/etaD));
      // export 'extra' – we’ll count revenue on price_peak
      dischargeKw += extra;
      soc -= (extra/etaD)*stepHrs;
      netKw = Math.max(0, netKw - extra); // import cannot be negative (we treat export via credit)
      newCost -= p.price_peak * extra*stepHrs; // revenue (credit)
    }

    newCost += price * Math.max(0, netKw*stepHrs);

    peakBase = Math.max(peakBase, loadKw);
    peakNew  = Math.max(peakNew, netKw);

    // Utilization metric: average absolute battery power usage relative to capacity
    if(chargeKw>0 || dischargeKw>0){ utilSum += (Math.abs(chargeKw)+Math.abs(dischargeKw))/(2*p.bat_kw); utilSteps++; }

    // sample day series
    const isSample = r.ts>=sampleDay[0].ts && r.ts<=sampleDay[sampleDay.length-1].ts;
    if(isSample){
      series.time.push(r.ts);
      series.baseKw.push(loadKw);
      series.netKw.push(netKw);
      series.soc.push(soc/p.bat_kwh*100);
    }
  }

  const savings = baselineCost - newCost;
  const weeks = energySpanWeeks(rows);
  const annualFactor = weeks>0 ? (52/weeks) : 1;
  const kpis = {
    savings_annual: savings * annualFactor,
    peak_shave: Math.max(0, peakBase - peakNew),
    util_pct: utilSteps? (100*Math.min(1, utilSum/utilSteps)) : 0,
    baseline_annual_cost: baselineCost*annualFactor,
    new_annual_cost: newCost*annualFactor,
    energy_kwh: energyKwh*annualFactor
  };

  // heatmap: average per weekday/hour of day
  const heat = buildHeatmap(rows);

  return { kpis, sampleSeries:series, heat, params: {...state.params}, user:{...state.user} };
}

function groupBy(arr, keyFn){
  const m={}; for(const x of arr){ const k=keyFn(x); (m[k]||(m[k]=[])).push(x) } return m;
}
function energySpanWeeks(rows){
  if(!rows.length) return 0;
  const ms = rows[rows.length-1].ts - rows[0].ts;
  return ms/(1000*60*60*24*7);
}
function buildHeatmap(rows){
  // 7 x 24 matrix of average kW
  const M=[...Array(7)].map(()=>Array(24).fill(0));
  const C=[...Array(7)].map(()=>Array(24).fill(0));
  for(const r of rows){
    const d = r.ts.getDay(); // 0..6 (Sun..Sat)
    const h = r.ts.getHours();
    M[d][h] += r.kwh/0.25;
    C[d][h] += 1;
  }
  for(let d=0;d<7;d++) for(let h=0;h<24;h++) if(C[d][h]) M[d][h]/=C[d][h];
  return M;
}

/* --------------------------
   Dashboard rendering
---------------------------*/
function renderDashboard(res){
  $('kpi_savings').textContent = '₪ ' + res.kpis.savings_annual.toFixed(0).toLocaleString();
  $('kpi_peak').textContent    = res.kpis.peak_shave.toFixed(2)+' kW';
  $('kpi_util').textContent    = res.kpis.util_pct.toFixed(0)+'%';

  drawLineChart('chartNet',
    res.sampleSeries.time.map(t=>t.toTimeString().slice(0,5)),
    [
      {name:'Baseline kW', data:res.sampleSeries.baseKw},
      {name:'With Battery kW', data:res.sampleSeries.netKw},
    ]
  );
  drawLineChart('chartSoC',
    res.sampleSeries.time.map(t=>t.toTimeString().slice(0,5)),
    [{name:'SoC %', data:res.sampleSeries.soc}]
  );
  renderHeatmap('heatmap', res.heat);
}

function drawLineChart(canvasId, labels, seriesList){
  const c=$(canvasId); const ctx=c.getContext('2d');
  const w=c.clientWidth, h=c.clientHeight;
  c.width = Math.floor(w*devicePixelRatio); c.height=Math.floor(h*devicePixelRatio);
  ctx.scale(devicePixelRatio, devicePixelRatio);
  ctx.clearRect(0,0,w,h);

  // axes
  ctx.strokeStyle='rgba(255,255,255,0.15)';
  ctx.lineWidth=1;
  ctx.beginPath();
  ctx.moveTo(40,10); ctx.lineTo(40,h-26); ctx.lineTo(w-10,h-26); ctx.stroke();

  // find range
  let min=Infinity, max=-Infinity;
  seriesList.forEach(s=>s.data.forEach(v=>{ if(v<min)min=v; if(v>max)max=v; }));
  if(!isFinite(min)||!isFinite(max)){ min=0; max=1; }
  if(Math.abs(max-min)<1e-6){ max=min+1; }
  const pad=(max-min)*0.1; min-=pad; max+=pad;

  // y grid
  const ticks=4;
  ctx.fillStyle='rgba(255,255,255,0.5)';
  for(let i=0;i<=ticks;i++){
    const y=map(i/ticks,0,1,h-26,10);
    ctx.strokeStyle='rgba(255,255,255,0.08)';
    ctx.beginPath(); ctx.moveTo(40,y); ctx.lineTo(w-10,y); ctx.stroke();
    const v=(min+(max-min)*(i/ticks)).toFixed(1);
    ctx.fillText(v,6,y+3);
  }
  // x labels (sparse)
  const n=labels.length;
  for(let i=0;i<n;i+=Math.max(1,Math.floor(n/8))){
    const x=map(i,0,n-1,40,w-10);
    ctx.fillStyle='rgba(255,255,255,0.5)';
    ctx.fillText(labels[i],x-10,h-8);
  }

  // lines
  const colors = ['#8be9fd','#64ffda','#ffd166','#ff6b6b'];
  seriesList.forEach((s,idx)=>{
    ctx.strokeStyle=colors[idx%colors.length];
    ctx.lineWidth=2;
    ctx.beginPath();
    s.data.forEach((v,i)=>{
      const x=map(i,0,n-1,40,w-10);
      const y=map(v,min,max,h-26,10);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
  });
}

function map(v,a,b,c,d){ return c + (v-a)*(d-c)/(b-a); }

function renderHeatmap(containerId, M){
  const el=$(containerId);
  el.innerHTML='';
  // normalize 0..max
  let max=0; for(let d=0;d<7;d++) for(let h=0;h<24;h++) max=Math.max(max,M[d][h]);
  for(let d=0;d<7;d++){
    for(let h=0;h<24;h++){
      const v=M[d][h]/(max||1);
      const cell=document.createElement('div');
      cell.className='cell';
      const hue = 200 - Math.round(200*v); // teal→blue scale
      const alpha = 0.15 + 0.85*v;
      cell.style.background = `hsla(${hue}, 90%, 55%, ${alpha})`;
      cell.title = `Day ${d}, ${h}:00 — ${M[d][h].toFixed(2)} kW`;
      el.appendChild(cell);
    }
  }
}

/* --------------------------
   PDF preparation
---------------------------*/
function preparePdf(){
  // inputs
  const p=state.params, u=state.user, r=state.results?.kpis || {};
  const inputsHtml = [
    ['User', `${u.name||'-'} (${u.email||'-'})`],
    ['Scenario', titleCase(p.scenario.replace('-',' '))],
    ['Battery', `${p.bat_kwh} kWh · ${p.bat_kw} kW`],
    ['SoC window', `${Math.round(p.soc_min*100)}% – ${Math.round(p.soc_max*100)}%`],
    ['Grid limit (A)', p.grid_a??'—'],
    ['Phase', p.phase],
    ['Tariffs', `Peak ₪${p.price_peak}/kWh · Off-peak ₪${p.price_off}/kWh`]
  ].map(([k,v])=>`<tr><th>${k}</th><td>${escapeHtml(v)}</td></tr>`).join('');
  $('pdf_inputs').innerHTML = inputsHtml;

  const kpisHtml = [
    ['Annual Savings', '₪ '+fmt0(r.savings_annual)],
    ['Baseline Annual Cost', '₪ '+fmt0(r.baseline_annual_cost)],
    ['New Annual Cost', '₪ '+fmt0(r.new_annual_cost)],
    ['Annual Energy', fmt0(r.energy_kwh)+' kWh'],
    ['Peak Shaving', (r.peak_shave??0).toFixed(2)+' kW'],
    ['Battery Utilization', (r.util_pct??0).toFixed(0)+'%'],
  ].map(([k,v])=>`<tr><th>${k}</th><td>${v}</td></tr>`).join('');
  $('pdf_kpis').innerHTML = kpisHtml;

  // embed charts as images
  $('img_net').src = $('chartNet').toDataURL('image/png');
  $('img_soc').src = $('chartSoC').toDataURL('image/png');
  // heatmap snapshot: clone grid
  const heatClone = $('heatmap').cloneNode(true);
  heatClone.style.transform='scale(1)'; heatClone.style.width='100%';
  $('img_heat').innerHTML=''; $('img_heat').appendChild(heatClone);
}
function fmt0(x){ return (x??0).toFixed(0).toLocaleString(); }
function escapeHtml(s){ return String(s).replace(/[&<>]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[c])) }
function titleCase(s){ return s.split(' ').map(w=>w[0].toUpperCase()+w.slice(1)).join(' '); }

/* --------------------------
   UX niceties
---------------------------*/
window.addEventListener('load', ()=>{
  // default sample for quick play
  $('btnSample').click();
});

/* --------------------------
   THE END
---------------------------*/
</script>
</body>
</html>