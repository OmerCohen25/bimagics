<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Mission Control — Gemini Agent UI</title>
<meta name="description" content="Mission Control: A mobile-first Gemini Agent UI for seamless code, cloud, and log management.">

<script>
  // Replace with your backend URL to exit demo mode.
  const BACKEND_BASE = "";
</script>

<style>
  /* -----------------------
     Design Tokens & Base
     ----------------------- */
  :root {
    --bg: #010409;
    --bg-gradient-start: #0d1117;
    --bg-gradient-end: #010409;
    --panel-bg: rgba(13, 17, 23, 0.5);
    --panel-border: rgba(255, 255, 255, 0.08);
    --muted: #8b949e;
    --text: #c9d1d9;
    --accent: #58a6ff;
    --accent-glow: rgba(88, 166, 255, 0.3);
    --accent-2: #3fb950;
    --ok: #3fb950;
    --warn: #d29922;
    --err: #f85149;
    --radius: 12px;
    --shadow: 0 16px 40px rgba(0, 0, 0, 0.5);
    --mono: "SF Mono", "Consolas", "Roboto Mono", ui-monospace, monospace;
    --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    --transition-speed: 0.2s;
  }
  html, body { height: 100%; margin: 0; background: linear-gradient(180deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 80%); color: var(--text); font-family: var(--font-sans); font-size: 14px; }
  * { box-sizing: border-box; }

  /* -----------------------
     App Layout (Mobile-First)
     ----------------------- */
  .app { display: grid; grid-template-rows: auto 1fr auto; min-height: 100vh; gap: 1rem; padding: 1rem; }
  header { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; border-radius: var(--radius); background: rgba(1, 4, 9, 0.7); backdrop-filter: blur(10px); border: 1px solid var(--panel-border); }
  .logo { display: flex; align-items: center; gap: 0.75rem; }
  .badge { background: linear-gradient(135deg, var(--accent), #3383e0); color: #fff; padding: 0.5rem 0.75rem; border-radius: 999px; font-weight: 600; font-size: 1rem; }
  .subtitle { color: var(--muted); font-size: 0.8rem; }
  .main { display: grid; grid-template-columns: 1fr; gap: 1rem; }
  .panel { background: var(--panel-bg); border-radius: var(--radius); padding: 1rem; border: 1px solid var(--panel-border); box-shadow: var(--shadow); }
  .panel h3 { margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }

  /* -----------------------
     Forms & Buttons
     ----------------------- */
  label { display: block; font-size: 0.8rem; font-weight: 500; color: var(--muted); margin-bottom: 0.5rem; }
  input, select, textarea { width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--panel-border); background: #0d1117; color: var(--text); font-size: 0.9rem; transition: border-color var(--transition-speed), box-shadow var(--transition-speed); }
  input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
  .row { display: flex; gap: 0.5rem; flex-wrap: wrap; }
  button { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; border: 1px solid transparent; padding: 0.6rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: background-color var(--transition-speed), transform var(--transition-speed); white-space: nowrap; }
  button:hover { transform: translateY(-1px); }
  button:active { transform: translateY(0); }
  button:disabled { cursor: not-allowed; opacity: 0.6; }
  .btn-primary { background: var(--accent); color: #fff; border-color: var(--accent); box-shadow: 0 2px 10px var(--accent-glow); }
  .btn-primary:hover { background: #6cb3ff; }
  .btn-ghost { background: transparent; border: 1px solid var(--panel-border); color: var(--muted); }
  .btn-ghost:hover { background: rgba(255, 255, 255, 0.05); color: var(--text); }
  .small { font-size: 0.8rem; color: var(--muted); }
  .kbd { background: #161b22; padding: 0.25rem 0.5rem; border-radius: 6px; color: var(--muted); font-family: var(--mono); font-size: 0.75rem; border: 1px solid var(--panel-border); }
  svg.icon { width: 16px; height: 16px; }

  /* -----------------------
     Repo, Editor, Chat
     ----------------------- */
  .repo-list { height: 180px; overflow-y: auto; border-radius: 8px; padding: 0.5rem; background: #0d1117; }
  .repo-file { padding: 0.6rem; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; font-family: var(--mono); font-size: 0.85rem; cursor: pointer; transition: background-color var(--transition-speed); }
  .repo-file:hover { background: rgba(255, 255, 255, 0.04); }
  .editor-wrapper { position: relative; }
  #editor { min-height: 220px; background: #0d1117; border-radius: 8px; border: 1px solid var(--panel-border); padding: 0.75rem 0.75rem 0.75rem 2.5rem; font-family: var(--mono); color: #dff7ff; font-size: 0.85rem; resize: vertical; line-height: 1.5; }
  .line-numbers { position: absolute; left: 0; top: 0; bottom: 0; width: 2.25rem; padding: 0.75rem 0; text-align: right; color: var(--muted); font-family: var(--mono); font-size: 0.85rem; pointer-events: none; user-select: none; opacity: 0.5; }
  .chat-wrap { display: flex; flex-direction: column; height: 100%; }
  .messages { flex: 1; overflow-y: auto; padding: 0.5rem; background: #0d1117; border-radius: 8px; margin-bottom: 0.5rem; }
  .msg { padding: 0.75rem 1rem; border-radius: 12px; margin-bottom: 0.5rem; max-width: 85%; line-height: 1.4; display: block; width: fit-content; }
  .msg.me { margin-left: auto; background: var(--accent); color: #fff; border-bottom-right-radius: 4px; }
  .msg.ai { margin-right: auto; background: #21262d; color: var(--text); border-bottom-left-radius: 4px; }
  .composer { display: flex; gap: 0.5rem; align-items: flex-end; }
  .composer textarea { min-height: 44px; max-height: 150px; resize: vertical; }
  .suggested-actions { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.75rem; }
  .suggested-action { font-size: 0.8rem; padding: 0.4rem 0.8rem; background: rgba(255,255,255,0.03); border: 1px solid var(--panel-border); border-radius: 99px; color: var(--muted); cursor: pointer; }
  .suggested-action:hover { background: rgba(255,255,255,0.08); color: var(--text); }

  /* -----------------------
     Timeline & Logs
     ----------------------- */
  .timeline, .log-panel { height: 160px; overflow-y: auto; padding: 0.5rem; border-radius: 8px; background: #0d1117; font-size: 0.85rem; }
  .timeline-item { display: flex; gap: 0.75rem; align-items: flex-start; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.5rem; background: rgba(255, 255, 255, 0.02); }
  .dot { width: 10px; height: 10px; border-radius: 50%; background: #30363d; margin-top: 4px; flex-shrink: 0; }
  .dot.ok { background: var(--ok); } .dot.warn { background: var(--warn); } .dot.err { background: var(--err); }
  .log-panel { font-family: var(--mono); }
  .log-line { padding: 0.4rem; border-radius: 4px; margin-bottom: 0.25rem; background: transparent; white-space: pre-wrap; word-break: break-all; }
  .log-line.err { border-left: 3px solid var(--err); color: #ffccd4; background: rgba(248, 81, 73, 0.1); }

  /* -----------------------
     Widescreen Layout
     ----------------------- */
  @media(min-width: 1000px) {
    .app { grid-template-columns: 380px 1fr; grid-template-rows: 80px 1fr; padding: 1.5rem; gap: 1.5rem; }
    header { grid-column: 1 / -1; padding: 1rem 1.5rem; }
    .main { display: grid; grid-template-columns: 380px 1fr; gap: 1.5rem; }
    .left-panel { grid-column: 1/2; }
    .right-panel { grid-column: 2/3; display: grid; grid-template-rows: 1fr; gap: 1rem; }
    .repo-editor-grid { display: grid; grid-template-rows: 1fr auto; gap: 1rem; }
    .repo-list { min-height: 200px; max-height: 30vh; }
    #editor { min-height: 300px; }
    .chat-timeline-grid { display: grid; grid-template-columns: 1fr 340px; gap: 1rem; }
  }

  /* -----------------------
     Micro Interactions & Helpers
     ----------------------- */
  .hint { font-size: 0.75rem; color: var(--muted); }
  [aria-hidden="true"] { display: none !important; }
  .loader { width: 16px; height: 16px; border: 2px solid currentColor; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
  @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .agent-status { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--ok); box-shadow: 0 0 8px var(--ok); animation: pulse 2s infinite; }
  .status-dot.busy { background: var(--warn); box-shadow: 0 0 8px var(--warn); }
  @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

</style>
</head>
<body>
<div class="app" role="application" aria-label="Mission Control - Gemini Agent">

  <header>
    <div class="logo">
      <div class="badge" aria-hidden="true">MC</div>
      <div>
        <div style="font-weight:700;font-size:1.1rem">Mission Control</div>
        <div class="subtitle">Gemini-Powered Cloud & Code Agent</div>
      </div>
    </div>
    <div style="display:flex;gap:1rem;align-items:center">
      <div class="small">Project: <span id="projectLabel" class="kbd">demo-project</span></div>
      <button id="connectBtn" class="btn-primary">
        <svg class="icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.25 2.5a.75.75 0 00-1.5 0v1.636a.75.75 0 001.5 0V2.5zM9.25 4.5A.75.75 0 0010 5.25v1.636a.75.75 0 001.5 0V5.25a.75.75 0 00-.75-.75h-1.5zM6.25 4.5A.75.75 0 017 3.75h1.5a.75.75 0 010 1.5H7A.75.75 0 016.25 4.5zM4.5 6.25a.75.75 0 000 1.5h1.636a.75.75 0 000-1.5H4.5zM4.5 9.25a.75.75 0 000 1.5h1.636a.75.75 0 000-1.5H4.5zM4.5 12.25a.75.75 0 000 1.5h1.636a.75.75 0 000-1.5H4.5zM6.25 14.5a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5H7a.75.75 0 01-.75-.75zM8.5 11.25a.75.75 0 00-1.5 0v1.636a.75.75 0 001.5 0V11.25zM8.5 8.25a.75.75 0 00-1.5 0v1.636a.75.75 0 001.5 0V8.25zM12.25 10a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5A.75.75 0 0112.25 10zM14.5 6.25a.75.75 0 000 1.5h1.636a.75.75 0 000-1.5H14.5zM14.5 12.25a.75.75 0 000 1.5h1.636a.75.75 0 000-1.5H14.5zM11.25 14.5a.75.75 0 00-1.5 0v1.636a.75.75 0 001.5 0V14.5zM15.25 9.25a.75.75 0 00.75.75h1.636a.75.75 0 000-1.5H16a.75.75 0 00-.75.75z" clip-rule="evenodd" /></svg>
        <span id="connectBtnLabel">Connect (Demo)</span>
      </button>
    </div>
  </header>

  <main class="main" role="main">
    <section class="panel left-panel" aria-labelledby="setupTitle">
      <h3 id="setupTitle">
        <svg class="icon" viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg>
        <span>Setup & Quick Actions</span>
      </h3>

      <div style="margin-bottom:1rem">
        <label for="geminiKey">Gemini API Key</label>
        <input id="geminiKey" type="password" placeholder="For demo, leave blank">
      </div>
      <div style="margin-bottom:1rem">
        <label for="githubToken">GitHub Token</label>
        <input id="githubToken" type="password" placeholder="ghp_... or GitHub App token">
      </div>
      <div style="margin-bottom:1rem">
        <label for="projectId">GCP Project ID</label>
        <input id="projectId" type="text" value="demo-project">
      </div>
      <div class="row" style="margin-bottom:1.5rem">
        <button id="saveKeys" class="btn-primary">Save & Connect</button>
        <button id="clearKeys" class="btn-ghost">Clear</button>
      </div>

      <div style="margin-bottom:1rem">
        <label for="repoInput">Repository (owner/name)</label>
        <input id="repoInput" type="text" placeholder="google/generative-ai-docs">
      </div>
      <div class="row" style="margin-bottom:1.5rem">
        <button id="btnListFiles" class="btn-ghost">List Files</button>
      </div>

      <div style="margin-bottom:1rem; display:grid; grid-template-columns: 1fr auto; gap: 0.5rem; align-items: flex-end;">
        <div>
          <label for="serviceName">Cloud Run Service</label>
          <input id="serviceName" placeholder="orders-api" />
        </div>
        <button id="btnTail" class="btn-ghost">Tail Logs</button>
      </div>
      <div class="row">
         <button id="btnDeploy" class="btn-primary" style="width:100%">Deploy Changes</button>
      </div>
       <div class="hint" style="margin-top:1.5rem">In demo mode, all actions are simulated. For production, use a secure backend with Secret Manager and least-privilege service accounts.</div>
    </section>

    <section class="panel right-panel" aria-labelledby="workTitle">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
        <h3 id="workTitle" style="margin:0">
          <svg class="icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm.25 11.5H15.75v-2.5H4.25v2.5zM4.25 4.5h11.5V6h-11.5V4.5z" clip-rule="evenodd" /></svg>
          <span>Workspace</span>
        </h3>
        <div class="agent-status">
          <div id="agentStatusDot" class="status-dot"></div>
          <span id="agentStatusText">Ready</span>
        </div>
        <div class="small">Mode: <span id="modeBadge" class="kbd">DEMO</span></div>
      </div>

      <div class="chat-timeline-grid">
        <div class="repo-editor-grid">
          <div>
            <h3>
              <svg class="icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 3.5A1.5 1.5 0 013.5 2h6.879a1.5 1.5 0 011.06.44l4.122 4.12A1.5 1.5 0 0116 7.622V16.5A1.5 1.5 0 0114.5 18h-11A1.5 1.5 0 012 16.5v-13zM10.5 3.5v3.622a1.5 1.5 0 001.5 1.5H16" clip-rule="evenodd" /></svg>
              <span>Repository Explorer</span>
            </h3>
            <div style="display:flex; gap:0.5rem; margin-bottom:0.5rem">
              <input id="fileFilter" placeholder="Filter files..." />
              <button id="refreshRepo" class="btn-ghost" title="Refresh file list">
                <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.312 11.342a1.25 1.25 0 010-1.768l-3.25-3.25a1.25 1.25 0 111.768-1.768l3.25 3.25a3.75 3.75 0 010 5.304l-3.25 3.25a1.25 1.25 0 11-1.768-1.768l3.25-3.25z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M8.312 4.658a1.25 1.25 0 010 1.768L5.062 9.675a1.25 1.25 0 11-1.768-1.768L6.544 4.658a3.75 3.75 0 015.304 0l3.25 3.25a1.25 1.25 0 11-1.768 1.768L10.08 6.425a1.25 1.25 0 010-1.768z" clip-rule="evenodd" /></svg>
              </button>
            </div>
            <div id="repoList" class="repo-list" aria-live="polite" role="region"><div class="small" style="padding:1rem;text-align:center;">Clone a repository to see files.</div></div>
          </div>

          <div>
            <h3>
              <svg class="icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.28 15.28a.75.75 0 01-1.06 0L10 10.56l-4.22 4.72a.75.75 0 01-1.06-1.06L8.94 9.5 4.72 5.28a.75.75 0 011.06-1.06L10 8.44l4.22-4.72a.75.75 0 111.06 1.06L11.06 9.5l4.22 4.72c.29.29.29.77 0 1.06z" clip-rule="evenodd" /></svg>
              <span>Code Editor</span>
            </h3>
             <div class="editor-wrapper">
              <div id="lineNumbers" class="line-numbers">1</div>
              <textarea id="editor" placeholder="// Select a file from the repository to edit..."></textarea>
            </div>
            <div style="display:flex; gap:0.5rem; margin-top:0.5rem; align-items:center; justify-content:space-between;">
              <button id="saveEditor" class="btn-primary">Commit Changes</button>
              <div class="small">Path: <span id="currentPath" class="kbd">—</span></div>
            </div>
          </div>
        </div>

        <div>
            <h3>
                <svg class="icon" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3a.75.75 0 01.75.75v1.5h1.5a.75.75 0 010 1.5h-1.5v1.5a.75.75 0 01-1.5 0v-1.5h-1.5a.75.75 0 010-1.5h1.5v-1.5A.75.75 0 0110 3zM8.06 9.94a.75.75 0 010-1.06l1.5-1.5a.75.75 0 011.06 0l1.5 1.5a.75.75 0 01-1.06 1.06L10.5 9.56v5.69a.75.75 0 01-1.5 0V9.56l-.53.53a.75.75 0 01-1.06 0z" /><path fill-rule="evenodd" d="M16.5 10a6.5 6.5 0 11-13 0 6.5 6.5 0 0113 0zM10 18a8 8 0 100-16 8 8 0 000 16z" clip-rule="evenodd" /></svg>
                <span>Agent Chat</span>
            </h3>
          <div class="chat-wrap">
            <div id="messages" class="messages" role="log" aria-live="polite"></div>
            <div class="composer">
              <textarea id="prompt" placeholder="Describe your task... e.g., 'Refactor this function for clarity' or 'Find the bug causing 500 errors'." rows="1"></textarea>
              <button id="sendBtn" class="btn-primary" title="Send Prompt (Ctrl+Enter)">
                  <svg class="icon" viewBox="0 0 20 20" fill="currentColor"><path d="M3.105 3.105a1.5 1.5 0 012.122-.219l11.485 8.614a1.5 1.5 0 010 2.428L5.227 17.114a1.5 1.5 0 01-2.122-.22 1.5 1.5 0 01.219-2.121L11.836 10 3.324 5.227a1.5 1.5 0 01-.22-2.122z" /></svg>
              </button>
            </div>
             <div id="suggestedActions" class="suggested-actions">
                <div class="suggested-action">Analyze & Fix Recent Errors</div>
                <div class="suggested-action">Explain the code in `main.ts`</div>
                <div class="suggested-action">Add a new feature</div>
             </div>
          </div>
          
          <div style="margin-top:1rem">
            <h3>
                <svg class="icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5h-3.25V5z" clip-rule="evenodd" /></svg>
                <span>Timeline & Logs</span>
            </h3>
            <div id="timeline" class="timeline" role="status" aria-live="polite"></div>
            <div style="height:0.5rem"></div>
            <div id="logs" class="log-panel" aria-live="polite"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer style="text-align:center; padding: 1rem;">
    <div class="small">Mission Control &copy; 2025 • Secure backend required for production use.</div>
  </footer>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const DEMO = (typeof BACKEND_BASE === 'undefined' || !BACKEND_BASE);
  const state = {
    connected: false,
    project: 'demo-project',
    currentPath: null,
    isAgentBusy: false,
    demoRepo: {
      name: "orders-service",
      files: {
        "src/main.ts": `import http from 'http';

function handle(req, res) {
  // BUG: This line will throw if the 'x-user' header is missing or malformed.
  const user = JSON.parse(req.headers['x-user']);
  
  if (!user) {
    res.writeHead(401);
    res.end('Unauthorized');
    return;
  }
  
  console.log(\`Processing request for user: \${user.id}\`);
  res.writeHead(200, { 'Content-Type': 'application/json' });
  res.end(JSON.stringify({ status: 'ok', userId: user.id }));
}

http.createServer(handle).listen(8080);
console.log('Server running on port 8080');`,
        "package.json": `{
  "name": "orders-service",
  "version": "1.0.1",
  "description": "A simple order processing service.",
  "main": "src/main.ts",
  "scripts": {
    "start": "node src/main.ts"
  }
}`,
        "Dockerfile": `FROM node:20-slim
WORKDIR /app
COPY package.json .
RUN npm install --production
COPY src/ .
CMD ["node", "src/main.ts"]`
      }
    }
  };

  /* ---------- DOM Element Cache ---------- */
  const $ = id => document.getElementById(id);
  const elements = {
    connectBtnLabel: $('connectBtnLabel'),
    modeBadge: $('modeBadge'),
    projectLabel: $('projectLabel'),
    geminiKey: $('geminiKey'),
    githubToken: $('githubToken'),
    projectId: $('projectId'),
    repoList: $('repoList'),
    editor: $('editor'),
    lineNumbers: $('lineNumbers'),
    currentPath: $('currentPath'),
    messages: $('messages'),
    prompt: $('prompt'),
    timeline: $('timeline'),
    logs: $('logs'),
    agentStatusDot: $('agentStatusDot'),
    agentStatusText: $('agentStatusText'),
  };

  /* ---------- UI & State Helpers ---------- */
  const setAgentBusy = (busy, message = "Working...") => {
    state.isAgentBusy = busy;
    elements.agentStatusDot.classList.toggle('busy', busy);
    elements.agentStatusText.textContent = busy ? message : "Ready";
    document.querySelectorAll('button, textarea, input').forEach(el => {
      if(el.id !== 'prompt') el.disabled = busy;
    });
  };

  const addTimelineEvent = (title, note, status = 'pending') => {
    const el = document.createElement('div');
    el.className = 'timeline-item';
    el.innerHTML = `<div class="dot ${status}"></div><div><strong>${title}</strong><div class="small" style="margin-top:0.25rem">${note || ''}</div></div>`;
    elements.timeline.prepend(el);
  };
  
  const appendLog = (line, level = 'info') => {
    const el = document.createElement('div');
    el.className = 'log-line' + (level === 'err' ? ' err' : '');
    el.textContent = `[${new Date().toLocaleTimeString()}] ${line}`;
    elements.logs.prepend(el);
  };

  const appendMessage = (who, text) => {
    const div = document.createElement('div');
    div.className = 'msg ' + who;
    div.textContent = text;
    elements.messages.appendChild(div);
    elements.messages.scrollTop = elements.messages.scrollHeight;
    return div;
  };

  const typewriter = async (element, text, speed = 20) => {
      return new Promise(resolve => {
        let i = 0;
        const interval = setInterval(() => {
          if (i < text.length) {
            element.textContent += text.charAt(i);
            i++;
            elements.messages.scrollTop = elements.messages.scrollHeight;
          } else {
            clearInterval(interval);
            resolve();
          }
        }, speed);
      });
  };

  const updateLineNumbers = () => {
    const lineCount = elements.editor.value.split('\n').length;
    elements.lineNumbers.innerHTML = Array.from({ length: lineCount }, (_, i) => i + 1).join('<br>');
  };
  
  const toggleButtonLoading = (button, isLoading) => {
    if (isLoading) {
      button.dataset.originalContent = button.innerHTML;
      button.innerHTML = '<div class="loader"></div>';
      button.disabled = true;
    } else {
      if (button.dataset.originalContent) {
        button.innerHTML = button.dataset.originalContent;
      }
      button.disabled = state.isAgentBusy;
    }
  };


  /* ---------- Core Functionality ---------- */
  function populateRepo(filter = '') {
    elements.repoList.innerHTML = '';
    const paths = Object.keys(state.demoRepo.files).filter(p => !filter || p.toLowerCase().includes(filter.toLowerCase()));
    if(paths.length === 0) {
        elements.repoList.innerHTML = `<div class="small" style="padding:1rem;text-align:center;">No files found.</div>`;
        return;
    }
    paths.forEach(p => {
      const item = document.createElement('div');
      item.className = 'repo-file';
      item.textContent = p;
      item.onclick = () => openFile(p);
      elements.repoList.appendChild(item);
    });
  }

  async function openFile(path) {
    elements.currentPath.textContent = path;
    state.currentPath = path;
    if (DEMO) {
      elements.editor.value = state.demoRepo.files[path] || '';
      addTimelineEvent('File Opened (Demo)', path, 'ok');
    } else {
      // Backend logic...
    }
    updateLineNumbers();
  }

  async function saveFile() {
    const path = state.currentPath;
    if (!path) {
      alert('No file is open to save.');
      return;
    }
    const content = elements.editor.value;
    const btn = $('saveEditor');
    toggleButtonLoading(btn, true);

    if (DEMO) {
      await new Promise(r => setTimeout(r, 800)); // Simulate network latency
      state.demoRepo.files[path] = content;
      addTimelineEvent('Committed (Demo)', `Changes to ${path} saved.`, 'ok');
      await typewriter(appendMessage('ai', ''), `Saved changes to ${path} in the demo repository.`);
    } else {
      // Backend logic...
    }
    toggleButtonLoading(btn, false);
  }

  /* ---------- Agent & AI Flows ---------- */
  async function sendPrompt(promptText, stream = true) {
    if (!promptText || state.isAgentBusy) return;
    
    setAgentBusy(true, "Thinking...");
    appendMessage('me', promptText);
    elements.prompt.value = '';
    elements.prompt.style.height = 'auto';

    if (promptText.toLowerCase().includes('analyze') && promptText.toLowerCase().includes('error')) {
      await runFixFlow();
    } else if (DEMO) {
      const aiMsg = appendMessage('ai', '');
      await typewriter(aiMsg, `Simulating response for: "${promptText}". In a real scenario, I would connect to the Gemini API to provide a detailed, context-aware answer based on your repository and cloud environment.`);
    } else {
      // Real backend chat logic...
    }
    setAgentBusy(false);
  }

  async function runFixFlow() {
    addTimelineEvent('Task Initiated', 'Analyzing recent 500 errors.', 'pending');
    
    let aiMsg = appendMessage('ai', '');
    await typewriter(aiMsg, "Understood. I'll start by analyzing the logs for recent 500 errors and correlate them with the code in the repository.");
    
    setAgentBusy(true, "Analyzing Logs...");
    await new Promise(r => setTimeout(r, 1500));
    addTimelineEvent('Log Analysis', 'Found TypeError in `src/main.ts` from missing header.', 'ok');
    appendLog('ERROR: TypeError: Cannot read properties of undefined (reading \'id\') at handle (src/main.ts:13:42)', 'err');
    
    aiMsg = appendMessage('ai', '');
    await typewriter(aiMsg, "I've found a recurring `TypeError` in the logs. It seems to originate from an unsafe `JSON.parse` call on a request header in `src/main.ts`. Opening the file now to propose a fix.");

    setAgentBusy(true, "Analyzing Code...");
    await new Promise(r => setTimeout(r, 1500));
    await openFile('src/main.ts');
    
    setAgentBusy(true, "Applying Fix...");
    await new Promise(r => setTimeout(r, 1000));
    const before = state.demoRepo.files['src/main.ts'];
    const after = before.replace(
        "const user = JSON.parse(req.headers['x-user']);",
        `let user = null;
  try {
    if (req.headers['x-user']) {
      user = JSON.parse(req.headers['x-user']);
    }
  } catch (e) {
    console.error('Failed to parse x-user header:', e);
    // User remains null, handled below
  }`
    );
    state.demoRepo.files['src/main.ts'] = after;
    if (state.currentPath === 'src/main.ts') {
        elements.editor.value = after;
        updateLineNumbers();
    }
    addTimelineEvent('Code Patched', 'Added a try-catch block for safe header parsing.', 'ok');
    
    aiMsg = appendMessage('ai', '');
    await typewriter(aiMsg, "I've applied a patch to `src/main.ts` by wrapping the JSON parsing in a `try-catch` block. This will prevent the server from crashing on malformed headers. The changes are now in the editor. Would you like me to commit and deploy?");
  }


  /* ---------- Event Listeners ---------- */
  const setupEventListeners = () => {
    $('saveKeys').onclick = () => {
      localStorage.setItem('mc_project', $('projectId').value);
      elements.projectLabel.textContent = $('projectId').value;
      addTimelineEvent('Connected (Demo)', `Project set to ${$('projectId').value}`, 'ok');
    };
    $('clearKeys').onclick = () => {
      localStorage.clear();
      $('geminiKey').value = '';
      $('githubToken').value = '';
      $('projectId').value = 'demo-project';
      addTimelineEvent('Keys Cleared', 'Local credentials removed.', 'ok');
    };
    $('btnListFiles').onclick = async (e) => {
        const btn = e.currentTarget;
        toggleButtonLoading(btn, true);
        if(DEMO){
            await new Promise(r => setTimeout(r, 800));
            populateRepo();
            addTimelineEvent('Repo Cloned (Demo)', state.demoRepo.name, 'ok');
        } else { /* backend */ }
        toggleButtonLoading(btn, false);
    };
    $('refreshRepo').onclick = () => populateRepo($('fileFilter').value);
    $('fileFilter').oninput = () => populateRepo($('fileFilter').value);
    elements.editor.oninput = updateLineNumbers;
    $('saveEditor').onclick = saveFile;
    $('sendBtn').onclick = () => sendPrompt(elements.prompt.value);
    elements.prompt.onkeydown = (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        $('sendBtn').click();
      }
    };
    elements.prompt.addEventListener('input', () => {
        elements.prompt.style.height = 'auto';
        elements.prompt.style.height = (elements.prompt.scrollHeight) + 'px';
    });
    $('suggestedActions').onclick = (e) => {
        if (e.target.classList.contains('suggested-action')) {
            sendPrompt(e.target.textContent);
        }
    };
    $('btnDeploy').onclick = async () => {
      if (state.isAgentBusy) return;
      setAgentBusy(true, "Deploying...");
      addTimelineEvent('Deploy Started', 'Building container image...', 'pending');
      await new Promise(r => setTimeout(r, 2000));
      addTimelineEvent('Build Complete', 'Image pushed to registry.', 'ok');
      await new Promise(r => setTimeout(r, 1000));
      addTimelineEvent('Deploying to Cloud Run', `Rolling out new revision for ${$('serviceName').value || 'orders-api'}...`, 'pending');
      await new Promise(r => setTimeout(r, 2500));
      addTimelineEvent('Deploy Successful', 'Traffic switched to new revision.', 'ok');
      const aiMsg = appendMessage('ai', '');
      await typewriter(aiMsg, 'Deployment complete! The new version is now live and serving 100% of traffic.');
      setAgentBusy(false);
    };
  };


  /* ---------- Initialization ---------- */
  const init = () => {
    elements.modeBadge.textContent = DEMO ? 'DEMO' : 'CONNECTED';
    elements.projectLabel.textContent = localStorage.getItem('mc_project') || state.project;
    setupEventListeners();
    appendMessage('ai', 'Welcome to Mission Control. I am your AI agent for code and cloud tasks. How can I assist you today?');
    addTimelineEvent('System Ready', `Running in ${DEMO ? 'Demo' : 'Connected'} Mode`, 'ok');
    setAgentBusy(false);
  };

  init();
});
</script>
</body>
</html>
