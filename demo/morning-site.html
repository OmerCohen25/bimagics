<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BulkGoods Demo | גרסה משודרגת</title>
<style>
  /* --- הגדרות כלליות וצבעים --- */
  :root {
    --bg-main: #f8fafc;
    --bg-panel: #ffffff;
    --bg-input: #f1f5f9;
    --border-color: #e2e8f0;
    --border-focus: #3b82f6;
    --text-primary: #0f172a;
    --text-secondary: #475569;
    --text-muted: #94a3b8;
    --accent-primary: #2563eb;
    --accent-primary-hover: #1d4ed8;
    --accent-danger: #dc2626;
    --accent-warn: #f59e0b;
    --shadow: 0 4px 12px rgba(0,0,0,0.08);
    --radius: 12px;
  }
  
  /* --- איפוס וסגנון בסיסי --- */
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    margin: 0;
    background-color: var(--bg-main);
    color: var(--text-primary);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 15px;
    line-height: 1.5;
  }
  a { color: var(--accent-primary); text-decoration: none; }
  a:hover { text-decoration: underline; }
  img { max-width: 100%; height: auto; display: block; }
  
  /* --- רכיבים (Components) --- */
  button, input, select, textarea {
    font-family: inherit;
    font-size: 1rem;
    background-color: var(--bg-input);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 10px 14px;
    outline: none;
    transition: all 0.2s ease;
  }
  input:focus, select:focus, textarea:focus {
    border-color: var(--border-focus);
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
  }
  button {
    cursor: pointer;
    background-color: var(--bg-panel);
    border: 1px solid var(--border-color);
    font-weight: 500;
  }
  button.primary {
    background-color: var(--accent-primary);
    color: white;
    border-color: var(--accent-primary);
  }
  button.primary:hover { background-color: var(--accent-primary-hover); }
  button.danger {
    background-color: var(--accent-danger);
    color: white;
    border-color: var(--accent-danger);
  }
  .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  .sp { flex: 1; }
  .muted { color: var(--text-secondary); }
  .hidden { display: none !important; }

  /* --- מבנה האפליקציה --- */
  .app { display: flex; flex-direction: column; min-height: 100vh; }
  header {
    display: flex; justify-content: space-between; align-items: center; gap: 12px;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-color);
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(8px);
    position: sticky; top: 0; z-index: 50;
  }
  .brand { display: flex; align-items: center; gap: 12px; }
  .logo { width: 32px; height: 32px; border-radius: 8px; background: conic-gradient(from 230deg, #34d399, #22d3ee, #60a5fa, #a78bfa); }
  .brand-text { font-weight: 600; font-size: 18px; }
  
  nav .tab {
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    border: 1px solid transparent;
    font-weight: 500;
  }
  nav .tab.active {
    background-color: var(--bg-input);
    color: var(--accent-primary);
  }
  
  /* --- מסך התחברות (Auth) --- */
  .view { display: none; }
  .view.active { display: block; }
  .auth-view { min-height: calc(100vh - 70px); display: grid; place-items: center; padding: 20px; }
  .auth-card {
    max-width: 420px; width: 100%;
    background-color: var(--bg-panel);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: 24px;
    box-shadow: var(--shadow);
    display: grid; gap: 20px;
  }
  .auth-card h1 { margin: 0; font-size: 24px; text-align: center; }
  .auth-card .step { display: grid; gap: 8px; }
  .auth-card label { font-weight: 500; font-size: 14px; }
  .g-btn {
    display: flex; gap: 12px; align-items: center; justify-content: center;
    background-color: #fff; border: 1px solid var(--border-color);
    width: 100%; cursor: pointer;
  }
  .g-logo { width: 18px; height: 18px; background: conic-gradient(#ea4335 0 25%, #fbbc04 0 50%, #34a853 0 75%, #4285f4 0 100%); }

  /* --- פאנל ניהול (Admin) --- */
  .admin-container { display: flex; }
  .admin-sidebar {
    width: 320px;
    background: var(--bg-panel);
    border-left: 1px solid var(--border-color);
    padding: 16px;
    display: flex; flex-direction: column; gap: 16px;
    height: calc(100vh - 65px);
    position: sticky; top: 65px;
  }
  .admin-main { flex: 1; padding: 16px; }
  .toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
  .item-list { display: grid; gap: 8px; overflow-y: auto; flex: 1; }
  .item-list .it {
    display: flex; justify-content: space-between; align-items: center;
    padding: 8px 10px; border-radius: 8px;
    cursor: pointer;
    border: 1px solid transparent;
  }
  .item-list .it:hover { background-color: var(--bg-input); }
  .item-list .it.active { border-color: var(--border-focus); background-color: #eff6ff; }
  .log-panel { font: 12px "Courier New", monospace; background: var(--bg-input); border-radius: 8px; height: 120px; overflow-y: auto; padding: 8px; color: var(--text-secondary); border: 1px solid var(--border-color); }
  .divider { height: 1px; background: var(--border-color); margin: 0; }
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 16px; }
  .card-item {
    background: var(--bg-panel); border: 1px solid var(--border-color);
    border-radius: var(--radius); overflow: hidden;
    display: flex; flex-direction: column; box-shadow: var(--shadow);
  }
  .card-item .image { aspect-ratio: 4/3; background: #e2e8f0; display: grid; place-items: center; position: relative; }
  .card-item .image img { width: 100%; height: 100%; object-fit: cover; }
  .card-item .meta { padding: 12px; display: grid; gap: 8px; flex: 1; }
  .card-item .desc { font-size: 13px; color: var(--text-secondary); height: 38px; overflow: hidden; }
  .card-item .price { font-weight: 700; font-size: 18px; }
  
  /* --- מגירת עריכה (Drawer) --- */
  .drawer-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 60; display: none; }
  .drawer-backdrop.show { display: block; }
  .drawer-panel {
    position: fixed; top: 0; left: 0; bottom: 0;
    width: min(500px, 100%);
    background: var(--bg-main);
    box-shadow: var(--shadow);
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    z-index: 70;
    display: flex; flex-direction: column;
  }
  .drawer-backdrop.show .drawer-panel { transform: translateX(0); }
  .drawer-header { padding: 12px 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
  .drawer-header h2 { margin: 0; font-size: 18px; }
  .drawer-content { padding: 16px; overflow-y: auto; flex: 1; }
  .form { display: grid; gap: 14px; }
  
  /* --- חנות (Store) --- */
  .store-container { max-width: 1200px; margin: 0 auto; padding: 16px; }
  .store-header {
    background: var(--bg-panel); border: 1px solid var(--border-color);
    border-radius: var(--radius); padding: 12px;
    display: flex; flex-wrap: wrap; gap: 12px; align-items: center;
    position: sticky; top: 80px; z-index: 40;
    margin-bottom: 16px;
  }
  .chips { display: flex; gap: 8px; flex-wrap: wrap; }
  .chip { padding: 6px 12px; border-radius: 999px; background: var(--bg-input); border: 1px solid var(--border-color); cursor: pointer; }
  .chip.active { background: var(--accent-primary); color: white; border-color: var(--accent-primary); }
  .store-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px; }
  .store-card {
      background: var(--bg-panel); border: 1px solid var(--border-color);
      border-radius: var(--radius); overflow: hidden;
      display: flex; flex-direction: column; box-shadow: var(--shadow);
  }
  .store-card .image { aspect-ratio: 1; }
  .store-card .meta { padding: 12px; display: grid; gap: 8px; }
  .store-card .name { font-weight: 600; font-size: 16px; }
  .store-card .price { font-weight: 700; font-size: 18px; color: var(--accent-primary); }

  /* --- התאמות למובייל --- */
  @media (max-width: 768px) {
    header { flex-direction: column; gap: 8px; padding: 10px; }
    nav { width: 100%; display: flex; justify-content: space-around; }
    
    .admin-container { flex-direction: column; }
    .admin-sidebar {
      position: fixed; left: 0; top: 0; bottom: 0;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 80; width: 300px;
      height: 100%;
    }
    .sidebar-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 79; display: none; }
    .sidebar-backdrop.show { display: block; }
    .sidebar-backdrop.show .admin-sidebar { transform: translateX(0); }
    .mobile-menu-btn { display: block !important; }

    .drawer-panel { width: 100%; }
    .store-header { flex-direction: column; align-items: stretch; }
  }
</style>
</head>
<body>

<div class="app">
  <header>
    <div class="brand">
      <div class="logo"></div>
      <span class="brand-text">BulkGoods</span>
    </div>
    <nav class="row">
      <div class="tab" id="tab-admin">ניהול</div>
      <div class="tab" id="tab-store">חנות</div>
      <div class="tab hidden" id="tab-logout">התנתקות</div>
    </nav>
  </header>

  <section id="view-auth" class="view">
    <div class="auth-view">
      <div class="auth-card">
        <h1>ברוכים הבאים</h1>
        <p class="muted" style="text-align:center;">התחברו כדי לנהל את קטלוג המוצרים שלכם.</p>
        
        <div class="step">
          <label>שלב 1: התחברות (דמו)</label>
          <input id="demoName" placeholder="שם (לדוגמה: משה כהן)" value="משה כהן"/>
          <input id="demoEmail" placeholder="אימייל (לדוגמה: moshe@mail.com)" value="moshe@mail.com" />
          <button class="g-btn" id="btn-google"><div class="g-logo"></div>התחברות עם גוגל</button>
        </div>
        
        <div class="step">
          <label>שלב 2: הגדרות Morning (אופציונלי)</label>
          <select id="base">
            <option value="demo">מצב הדגמה (ללא חיבור חיצוני)</option>
            <option value="https://sandbox.d.greeninvoice.co.il/api/v1">Sandbox</option>
            <option value="https://api.greeninvoice.co.il/api/v1">Production</option>
          </select>
          <input id="token" placeholder="הדביקו מפתח JWT של Morning" />
        </div>
        
        <button class="primary" id="btn-enter">כניסה לפאנל הניהול</button>
      </div>
    </div>
  </section>

  <section id="view-admin" class="view">
    <div class="admin-container">
      <div class="sidebar-backdrop" id="sidebar-backdrop">
        <aside class="admin-sidebar" id="admin-sidebar">
            <div class="toolbar"><input id="q" placeholder="חיפוש מוצרים..." class="sp"/></div>
            <div class="toolbar">
              <button id="pull" class="sp">משיכה ↻</button>
              <button id="push" class="sp">דחיפה ↪</button>
            </div>
            <button id="publish" class="primary">פרסום לחנות</button>
            <div class="divider"></div>
            <div class="row" style="justify-content: space-between;">
              <span class="muted">מוצרים (<span id="countTag">0</span>)</span>
              <button id="newItem">➕ מוצר חדש</button>
            </div>
            <div class="item-list" id="sideList"></div>
            <div class="divider"></div>
            <b>לוגים</b>
            <div class="log-panel" id="log"></div>
            <button id="logClear" style="width:100%;">ניקוי לוגים</button>
        </aside>
      </div>
      <main class="admin-main">
        <div class="toolbar" style="margin-bottom:16px;">
            <button class="mobile-menu-btn" id="mobile-menu-btn" style="display:none;">☰ תפריט</button>
            <span class="sp muted">מצב: <b id="modeBadge">הדגמה</b></span>
        </div>
        <div class="grid" id="grid"></div>
      </main>
    </div>
  </section>

  <section id="view-store" class="view">
    <div class="store-container">
      <div class="store-header">
        <input id="s-q" class="sp" placeholder="חיפוש מוצרים..."/>
        <select id="s-sort">
          <option value="rel">מיון: רלוונטיות</option>
          <option value="name">שם (א→ת)</option>
          <option value="priceAsc">מחיר (נמוך לגבוה)</option>
          <option value="priceDesc">מחיר (גבוה לנמוך)</option>
        </select>
        <div class="chips" id="chips"></div>
      </div>
      <div class="store-grid" id="s-grid"></div>
    </div>
  </section>
</div>

<div class="drawer-backdrop" id="drawer">
  <div class="drawer-panel">
    <div class="drawer-header">
      <h2 id="editTitle">מוצר חדש</h2>
      <button id="close">✖</button>
    </div>
    <div class="drawer-content">
      <div class="form">
        <label>שם המוצר</label>
        <input id="f_name" placeholder="לדוגמה: כוסות פלסטיק 200 מ״ל" required/>
        
        <label>תיאור</label>
        <textarea id="f_desc" placeholder="תיאור קצר של המוצר" rows="3"></textarea>
        
        <div class="row">
          <div class="sp"><label>מחיר</label><input id="f_price" type="number" step="0.01" placeholder="0.00"/></div>
          <div class="sp"><label>מטבע</label><select id="f_currency"><option>ILS</option><option>USD</option></select></div>
        </div>
        
        <div class="row">
            <div class="sp"><label>מק״ט</label><input id="f_sku" placeholder="אופציונלי"/></div>
            <div class="sp"><label>קטגוריה</label><input id="f_cat" placeholder="לדוגמה: כלים חד פעמיים"/></div>
        </div>
        
        <label>תמונה (URL)</label>
        <input id="f_imgurl" placeholder="https://... (יוצג באתר הלקוח)"/>
        
        <div><input id="f_active" type="checkbox" checked/> <label for="f_active">פעיל (יוצג בחנות)</label></div>
        
        <div class="divider"></div>

        <div class="row" style="justify-content:space-between;">
            <button id="save" class="primary">💾 שמירה</button>
            <a href="#" id="delete" style="color:var(--accent-danger);">מחיקה</a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
'use strict';
/* =======================
   DEMO: Single-file Admin + Store (Upgraded Version)
   ======================= */

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const uid = () => Math.random().toString(36).slice(2, 9);
const now = () => new Date().toLocaleTimeString('he-IL');
const escapeHTML = s => (s ?? '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));

// --- Local Storage Keys ---
const LS = {
    user: 'demo.user',
    items: 'demo.items.wholesale',
    published: 'demo.published.catalog',
    demoRemote: 'demo.morning.remote',
    settings: 'demo.settings'
};

// --- Global State ---
let USER = null;
let SETTINGS = loadSettings();
let ITEMS = load(LS.items) || [];
let PUBLISHED = load(LS.published) || { meta: {}, items: [] };
let CURRENT = null;
let QUERY = '';
let S_QUERY = '';
let S_CAT = '';

// --- Utilities ---
function loadSettings() {
    return load(LS.settings) || { base: 'demo', token: '', demo: true };
}
function saveSettings() { save(LS.settings, SETTINGS); }
function load(key) { try { return JSON.parse(localStorage.getItem(key) || 'null'); } catch { return null; } }
function save(key, val) { localStorage.setItem(key, JSON.stringify(val)); }
function resetDemo() { Object.values(LS).forEach(k => localStorage.removeItem(k)); location.reload(); }
function setView(id) {
    $$('.view').forEach(v => v.classList.remove('active'));
    $(id).classList.add('active');
    $$('.tab').forEach(t => t.classList.remove('active'));
    if (id === '#view-admin') $('#tab-admin').classList.add('active');
    if (id === '#view-store') $('#tab-store').classList.add('active');
}
function svgPlaceholder(text, color = '#3b82f6') {
    const t = encodeURIComponent(text.slice(0, 2));
    const w = 200, h = 150;
    return `data:image/svg+xml;utf8,` +
        `<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}'>` +
        `<rect width='100%' height='100%' fill='#e2e8f0'/>` +
        `<text x='50%' y='52%' dominant-baseline='middle' text-anchor='middle' font-size='54' font-family='-apple-system, sans-serif' fill='${color}' font-weight='600'>${t}</text>` +
        `</svg>`;
}
function log(msg, obj) {
    const line = document.createElement('div');
    line.textContent = `[${now()}] ${msg}`;
    $('#log').prepend(line);
    if (obj) console.log('[DEMO]', msg, obj);
}

// --- Morning API Mock ---
const MorningMock = {
    load() {
        let r = load(LS.demoRemote);
        if (!r) {
            const seed = [
                ['כוסות פלסטיק 200 מ"ל (100 יח\')', 'כוסות שקופות לשתיה קרה', 12.9, 'ILS'],
                ['צלחות נייר 9" (100 יח\')', 'צלחות חד פעמיות לבנות', 22.9, 'ILS'],
                ['סכו"ם פלסטיק (100 סטים)', 'מזלגות, סכינים, כפיות', 27.9, 'ILS'],
                ['מפיות 33x33 (500 יח\')', 'מפיות לבנות דו-שכבתיות', 28.0, 'ILS'],
                ['שקיות אשפה XL (25 יח\')', 'שקיות שחורות חזקות במיוחד 120 ליטר', 19.9, 'ILS'],
                ['נייר אלומיניום 45 ס"מ', 'גליל נייר אלומיניום עבה', 26.0, 'ILS'],
                ['קופסאות אוכל (50 יח\')', 'קופסאות טייקאווי מתקפלות', 44.9, 'ILS'],
                ['נייר סופג (24 גלילים)', 'חזק וסופג במיוחד', 69.0, 'ILS'],
                ['נייר טואלט (48 גלילים)', 'רך, 3 שכבות', 99.0, 'ILS'],
                ['סבון כלים 5 ליטר', 'בניחוח לימון', 29.0, 'ILS']
            ];
            r = seed.map((s, i) => ({ id: String(1000 + i), name: s[0], description: s[1], price: s[2], currency: s[3] }));
            save(LS.demoRemote, r);
        }
        return r;
    },
    save(arr) { save(LS.demoRemote, arr); },
    async search(query = '', page = 1, pageSize = 100) {
        await new Promise(res => setTimeout(res, 300));
        const all = this.load();
        const q = query.toLowerCase();
        const filtered = all.filter(i => (`${i.name} ${i.description}`).toLowerCase().includes(q));
        return { items: filtered.slice(0, pageSize), total: filtered.length };
    },
    async create(payload) {
        await new Promise(res => setTimeout(res, 300));
        const all = this.load();
        const item = { id: String(Date.now()), ...payload };
        all.push(item);
        this.save(all);
        return item;
    },
    async update(id, patch) {
        await new Promise(res => setTimeout(res, 300));
        const all = this.load();
        const ix = all.findIndex(x => x.id === id);
        if (ix === -1) throw new Error('404 Not Found');
        all[ix] = { ...all[ix], ...patch };
        this.save(all);
        return all[ix];
    }
};

// --- Admin Catalog Logic ---
function ensureLocalSeed() {
    if (ITEMS && ITEMS.length) return;
    const remote = MorningMock.load();
    const mapCategory = (n) => {
        if (n.match(/כוסות|צלחות|סכו"ם|מפיות/i)) return 'כלים חד פעמיים';
        if (n.match(/שקיות/i)) return 'שקיות';
        if (n.match(/נייר/i)) return 'מוצרי נייר';
        if (n.match(/סבון/i)) return 'ניקיון';
        return 'כללי';
    };
    ITEMS = remote.map(r => ({
        id: uid(),
        morningId: r.id,
        name: r.name,
        description: r.description,
        price: r.price,
        currency: r.currency,
        sku: mapCategory(r.name).slice(0, 2).toUpperCase() + '-' + Math.floor(100 + Math.random() * 900),
        category: mapCategory(r.name),
        active: true,
        imageUrl: '',
        dirty: false
    }));
    save(LS.items, ITEMS);
}

// --- Admin Rendering ---
function renderAdmin() {
    const q = (QUERY || '').trim().toLowerCase();
    const list = ITEMS.filter(i => (`${i.name} ${i.description} ${i.sku} ${i.category}`).toLowerCase().includes(q));
    $('#countTag').textContent = list.length;

    const gridEl = $('#grid');
    gridEl.innerHTML = '';
    list.forEach(it => {
        const el = document.createElement('div');
        el.className = 'card-item';
        const price = (it.price ?? 0).toLocaleString('he-IL', { style: 'currency', currency: it.currency || 'ILS' });
        el.innerHTML = `
        <div class="image">
          <img src="${it.imageUrl || svgPlaceholder(it.name, '#0f172a')}" alt="${escapeHTML(it.name)}">
          ${it.dirty ? '<span style="position:absolute;top:8px;right:8px;background:var(--accent-warn);color:white;padding:2px 8px;border-radius:99px;font-size:12px;">לא מסונכרן</span>' : ''}
        </div>
        <div class="meta">
          <b title="${escapeHTML(it.name)}">${escapeHTML(it.name)}</b>
          <div class="desc">${escapeHTML(it.description || '')}</div>
          <div class="row" style="justify-content: space-between; align-items: baseline;">
            <span class="price">${price}</span>
            <span class="muted">${escapeHTML(it.sku || '—')}</span>
          </div>
          <button data-edit="${it.id}">עריכה</button>
        </div>`;
        gridEl.appendChild(el);
    });

    const sideListEl = $('#sideList');
    sideListEl.innerHTML = '';
    list.forEach(it => {
        const li = document.createElement('div');
        li.className = 'it';
        if (CURRENT && it.id === CURRENT.id) li.classList.add('active');
        li.innerHTML = `<span>${escapeHTML(it.name)}</span> <span class="muted">${it.price ?? 0} ${it.currency || 'ILS'}</span>`;
        li.onclick = () => openEditor(it.id);
        sideListEl.appendChild(li);
    });
}

// --- Editor Logic ---
function openEditor(id) {
    const it = ITEMS.find(x => x.id === id);
    CURRENT = it ? { ...it } : { id: uid(), name: '', description: '', price: 0, currency: 'ILS', sku: '', category: '', active: true, imageUrl: '' };
    
    $('#editTitle').textContent = it ? 'עריכת מוצר' : 'מוצר חדש';
    $('#f_name').value = CURRENT.name || '';
    $('#f_desc').value = CURRENT.description || '';
    $('#f_price').value = CURRENT.price ?? 0;
    $('#f_currency').value = CURRENT.currency || 'ILS';
    $('#f_sku').value = CURRENT.sku || '';
    $('#f_cat').value = CURRENT.category || '';
    $('#f_active').checked = !!CURRENT.active;
    $('#f_imgurl').value = CURRENT.imageUrl || '';
    
    $('#drawer').classList.add('show');
    renderAdmin(); // To highlight in side list
}
function closeEditor() {
    $('#drawer').classList.remove('show');
    CURRENT = null;
    renderAdmin(); // To remove highlight
}
function persistCurrent() {
    if (!CURRENT) return;
    CURRENT.name = $('#f_name').value.trim();
    if (!CURRENT.name) return alert('שם המוצר הוא שדה חובה');
    
    CURRENT.description = $('#f_desc').value.trim();
    CURRENT.price = Number($('#f_price').value || 0);
    CURRENT.currency = $('#f_currency').value;
    CURRENT.sku = $('#f_sku').value.trim();
    CURRENT.category = $('#f_cat').value.trim();
    CURRENT.active = $('#f_active').checked;
    CURRENT.imageUrl = $('#f_imgurl').value.trim();

    const ix = ITEMS.findIndex(x => x.id === CURRENT.id);
    if (ix === -1) {
        ITEMS.unshift({ ...CURRENT, dirty: true });
    } else {
        ITEMS[ix] = { ...CURRENT, dirty: true };
    }
    
    save(LS.items, ITEMS);
    log(`שמירה מקומית: ${CURRENT.name}`);
    closeEditor();
    renderAdmin();
}

// --- Sync Logic ---
async function pull() {
    if (SETTINGS.demo) {
        log('מתחיל משיכה (דמו)...');
        try {
            const res = await MorningMock.search();
            const arr = res.items || [];
            const byName = Object.fromEntries(ITEMS.map(i => [(i.name || '').toLowerCase(), i]));
            ITEMS = arr.map(r => {
                const local = byName[(r.name || '').toLowerCase()];
                return {
                    id: local?.id || uid(),
                    morningId: r.id, name: r.name, description: r.description,
                    price: r.price, currency: r.currency,
                    sku: local?.sku || '', category: local?.category || '',
                    active: local?.active ?? true, imageUrl: local?.imageUrl || '',
                    dirty: false
                };
            });
            save(LS.items, ITEMS);
            renderAdmin();
            log(`הסתיימה משיכה, ${arr.length} פריטים נטענו.`);
        } catch (e) { log(`שגיאה במשיכה: ${e.message}`); }
    } else { alert('מצב Live אינו זמין בהדגמה זו.'); }
}

async function push() {
    if (SETTINGS.demo) {
        const dirtyItems = ITEMS.filter(i => i.dirty);
        if (!dirtyItems.length) { log('אין שינויים לדחוף.'); return; }
        log(`דוחף ${dirtyItems.length} שינויים (דמו)...`);
        try {
            for (const it of dirtyItems) {
                const payload = { name: it.name, description: it.description, price: it.price, currency: it.currency };
                if (it.morningId) {
                    await MorningMock.update(it.morningId, payload);
                } else {
                    const created = await MorningMock.create(payload);
                    it.morningId = created.id;
                }
                it.dirty = false;
            }
            save(LS.items, ITEMS);
            renderAdmin();
            log('הדחיפה הושלמה בהצלחה.');
        } catch (e) { log(`שגיאה בדחיפה: ${e.message}`); }
    } else { alert('מצב Live אינו זמין בהדגמה זו.'); }
}

// --- Publish to Store ---
function publish() {
    const items = ITEMS.filter(i => i.active);
    PUBLISHED = {
        meta: { generatedAt: new Date().toISOString(), count: items.length },
        items: items
    };
    save(LS.published, PUBLISHED);
    log(`פורסמו ${items.length} פריטים לחנות.`);
    if ($('#view-store').classList.contains('active')) {
        renderStore();
    }
}

// --- Store Rendering ---
function renderStore() {
    buildCategories();
    const grid = $('#s-grid');
    grid.innerHTML = '';
    const filtered = filteredStore();
    
    if (filtered.length === 0) {
        grid.innerHTML = `<p>לא נמצאו מוצרים התואמים את החיפוש.</p>`;
        return;
    }
    
    filtered.forEach(i => {
        const price = Number(i.price || 0).toLocaleString('he-IL', { style: 'currency', currency: i.currency || 'ILS' });
        const el = document.createElement('div');
        el.className = 'store-card';
        el.innerHTML = `
            <div class="image">
                <img src="${i.imageUrl || svgPlaceholder(i.name, '#475569')}" alt="${escapeHTML(i.name)}">
            </div>
            <div class="meta">
                <span class="name">${escapeHTML(i.name)}</span>
                <span class="muted">${escapeHTML(i.category || '')}</span>
                <div class="row" style="justify-content: space-between; align-items: center;">
                  <span class="price">${price}</span>
                  <button class="primary" onclick="alert('הזמנה דרך WhatsApp')">הזמנה</button>
                </div>
            </div>`;
        grid.appendChild(el);
    });
}
function buildCategories() {
    const cats = [...new Set((PUBLISHED.items || []).map(i => i.category).filter(Boolean))].sort();
    const chips = $('#chips');
    chips.innerHTML = `<div class="chip ${S_CAT === '' ? 'active' : ''}" data-cat="">הכל</div>`;
    cats.forEach(c => {
        chips.innerHTML += `<div class="chip ${S_CAT === c ? 'active' : ''}" data-cat="${escapeHTML(c)}">${escapeHTML(c)}</div>`;
    });
}
function filteredStore() {
    const q = (S_QUERY || '').toLowerCase();
    let arr = (PUBLISHED.items || []).filter(i => (`${i.name} ${i.description} ${i.sku} ${i.category}`).toLowerCase().includes(q));
    if (S_CAT) arr = arr.filter(i => i.category === S_CAT);
    const sort = $('#s-sort').value;
    if (sort === 'name') arr.sort((a, b) => a.name.localeCompare(b.name, 'he'));
    if (sort === 'priceAsc') arr.sort((a, b) => (a.price || 0) - (b.price || 0));
    if (sort === 'priceDesc') arr.sort((a, b) => (b.price || 0) - (a.price || 0));
    return arr;
}


// --- Auth Flow ---
function setSignedInUI() {
    $('#modeBadge').textContent = SETTINGS.demo ? 'הדגמה' : 'Live';
    $('#tab-logout').classList.remove('hidden');
    log(`התחברות כ: ${USER.name}`);
}
function signOut() {
    USER = null;
    save(LS.user, null);
    $('#tab-logout').classList.add('hidden');
    setView('#view-auth');
}

// --- Event Listeners ---
function addEventListeners() {
    // --- Navigation ---
    $('#tab-admin').onclick = () => setView('#view-admin');
    $('#tab-store').onclick = () => { setView('#view-store'); renderStore(); };
    $('#tab-logout').onclick = signOut;

    // --- Auth ---
    $('#btn-google').onclick = () => {
        const name = $('#demoName').value.trim() || 'משתמש הדגמה';
        const email = $('#demoEmail').value.trim() || 'demo@example.com';
        USER = { name, email };
        save(LS.user, USER);
        setSignedInUI();
        $('#btn-enter').click();
    };
    $('#btn-enter').onclick = () => {
        if (!USER) { $('#btn-google').click(); return; }
        SETTINGS.base = $('#base').value;
        SETTINGS.token = $('#token').value.trim();
        SETTINGS.demo = SETTINGS.base === 'demo';
        saveSettings();
        setSignedInUI();
        ensureLocalSeed();
        renderAdmin();
        setView('#view-admin');
    };

    // --- Admin ---
    $('#q').addEventListener('input', e => { QUERY = e.target.value; renderAdmin(); });
    $('#newItem').onclick = () => openEditor();
    $('#pull').onclick = pull;
    $('#push').onclick = push;
    $('#publish').onclick = publish;
    $('#logClear').onclick = () => { $('#log').innerHTML = ''; };
    $('#mobile-menu-btn').onclick = () => $('#sidebar-backdrop').classList.add('show');
    $('#sidebar-backdrop').onclick = (e) => {
      if (e.target.id === 'sidebar-backdrop') $('#sidebar-backdrop').classList.remove('show');
    };
    
    // --- Editor ---
    $('#close').onclick = closeEditor;
    $('#drawer').onclick = (e) => { if(e.target.id === 'drawer') closeEditor(); };
    $('#save').onclick = persistCurrent;
    $('#delete').onclick = (e) => {
        e.preventDefault();
        if (!CURRENT || !confirm('האם למחוק את המוצר?')) return;
        ITEMS = ITEMS.filter(x => x.id !== CURRENT.id);
        save(LS.items, ITEMS);
        log(`נמחק (מקומי): ${CURRENT.name}`);
        closeEditor();
    };
    
    // --- Store ---
    $('#s-q').addEventListener('input', e => { S_QUERY = e.target.value; renderStore(); });
    $('#s-sort').addEventListener('change', renderStore);
    $('#chips').addEventListener('click', e => {
        if (e.target.classList.contains('chip')) {
            S_CAT = e.target.dataset.cat;
            renderStore();
        }
    });
    
    // --- Global clicks ---
    document.addEventListener('click', e => {
        const editBtn = e.target.closest('[data-edit]');
        if (editBtn) openEditor(editBtn.getAttribute('data-edit'));
    });
}


// --- Initialize App ---
function init() {
    USER = load(LS.user);
    if (USER) {
        setSignedInUI();
        ensureLocalSeed();
        renderAdmin();
        setView('#view-admin');
    } else {
        setView('#view-auth');
    }
    addEventListeners();
    log('אפליקציה אותחלה.');
}

init();
</script>
</body>
</html>
